<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Eternal Brothers FC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* -------------------- 1. GENERAL & BODY STYLES -------------------- */
body { font-family: "Cairo", sans-serif; background-color: #121212; color: #e0e0e0; margin:0; padding:10px; text-align:center; }
.container { display:none; max-width:95%; margin:auto; background:#1e1e1ecc; padding:20px 10px; border-radius:15px; box-shadow:0 0 10px #000; }
h1,h2,h3 { margin:10px 0; }
input[type=text] { padding:8px; width:80%; border-radius:8px; border:1px solid #555; margin:5px 0; background:#2c2c2c; color:#fff; text-align:center; }
button { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:700; }
.formation-controls button { margin: 5px 3px; background: #009688; color: #fff; padding: 8px 12px; font-size: 14px; }
.formation-controls .dynamic-btn { background: #FF9800; font-weight: 700; }

/* -------------------- 2. NAV CONTROLS -------------------- */
.nav-controls { margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; }
.nav-buttons-top { display: flex; flex-direction: row; justify-content: space-between; width: 100%; max-width: 400px; margin-bottom: 5px; }
.nav-buttons-bottom { display: flex; justify-content: space-between; width: 100%; max-width: 400px; gap: 5px; }
#homeBtn, #blueBtn, #yellowBtn, #addressBtn, #arcadeBtn { border-radius: 8px; font-size: 14px; }
#homeBtn { background:#d32f2f; color:#fff; width: 100%; margin: 0 5px; }
#blueBtn { background:#1976d2; color:#fff; width: 100%; margin: 0 5px; }
#yellowBtn { background:#fbc02d; color:#000; width: 100%; margin: 0 5px; }
#addressBtn { background:#9c27b0; color:#fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 2; }
#arcadeBtn { background: #673AB7; color: #fff; flex: 1; }
.settings-audio-group { display: flex; gap: 5px; flex: 1.5; justify-content: center; }
#audioToggleBtn, #settingsBtn { background: #616161 !important; color: #fff !important; font-size: 14px; padding: 8px 5px !important; width: 50% !important; margin: 0 !important; border-radius: 8px; box-sizing: border-box; }
#settingsBtn { background: #795548 !important; }

/* -------------------- 3. LISTS & PLAYER INFO -------------------- */
ul { list-style:none; padding:0; margin-top:10px; text-align:left; font-weight:bold; }
li { margin:5px 0; padding:6px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; flex-direction: row; min-height: 40px; }
#teamList li { background:#a8e6a1; color:black; }
#waitingList li { background:#ffe0e0; color:black; }
#blueList li { background:rgba(25,118,210,0.7); color:white; }
#yellowList li { background:rgba(251,192,42,0.7); color:#000; }
.player-info { display: flex; flex-direction: row; align-items: center; font-size: 16px; font-weight: bold; }
.player-time { font-size: 12px; font-weight: normal; color: #616161; margin-left: 5px; }
.action-btn { margin-left:6px; border:none; border-radius:5px; padding:4px 8px; cursor:pointer; font-weight:bold; }
.edit-btn { background:#4caf50; color:#fff; }
.delete-btn { background:#e53935; color:#fff; }

/* -------------------- 4. FIELD & MARKER STYLES -------------------- */
.field { width:100%; max-width:400px; height:250px; background:#4CAF50; margin:10px auto; border:2px solid #fff; border-radius:10px; position:relative; touch-action:none; }
.field .center-circle { position:absolute; width:50px;height:50px;border-radius:50%;border:2px solid #fff; top:50%; left:50%; transform:translate(-50%,-50%); }
.field .penalty-box-left, .field .penalty-box-right { position:absolute;width:60px;height:120px;border:2px solid #fff; top:50%; transform:translateY(-50%); }
.field .penalty-box-left { left:0; } .field .penalty-box-right { right:0; }
.field .mid-line { position:absolute; width:0;height:100%;border-left:2px solid #fff; top:0; left:50%; transform:translateX(-50%); }

.player-marker { width:35px; height:35px; border-radius:50%; color:#fff; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:bold; position:absolute; cursor:pointer; user-select:none; border: 2px solid rgba(255, 255, 255, 0.5); touch-action: none; transform: translate(-50%, -50%); z-index: 10; }
.player-name { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 12px; color: black; white-space: nowrap; font-weight: bold; text-shadow: 0 0 2px rgba(0,0,0,0.5); }
.player-position-label { font-size: 13px; font-weight: bold; color: white; }

/* -------------------- 5. CHAT STYLES -------------------- */
.chat-container { width: 100%; max-width: 100%; margin: 20px 0 0 0; background: #242424; border-radius: 10px; padding: 10px; box-shadow: 0 0 5px #000; text-align: left; }
.team-chat-container { background: none; box-shadow: none; margin: 5px 0 0 0; padding: 0; }
#onlineUsersBar { display: flex; flex-wrap: wrap; gap: 8px; padding: 5px; margin-bottom: 5px; background: #1a1a1a; border-radius: 8px; min-height: 20px; }
.online-user-pill { background: #333; border-radius: 15px; padding: 2px 8px; font-size: 11px; display: flex; align-items: center; color: #ccc; border: 1px solid #444; }
.online-dot { width: 8px; height: 8px; background-color: #00e676; border-radius: 50%; margin-left: 5px; box-shadow: 0 0 5px #00e676; animation: blink 2s infinite; }
@keyframes blink { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }
#typingIndicator { font-size: 11px; color: #00e676; height: 15px; margin-bottom: 2px; font-style: italic; padding-left: 5px; }
.chat-messages { height: 250px; overflow-y: auto; margin-bottom: 5px; padding: 5px; background: #1e1e1e; border-radius: 5px; display: flex; flex-direction: column; text-align: left; }
#blueChatMessages { background: rgba(25, 118, 210, 0.1); } #yellowChatMessages { background: rgba(251, 192, 42, 0.1); }
.message { margin-bottom: 8px; padding: 8px; border-radius: 10px; background: #333; word-wrap: break-word; max-width: 90%; align-self: flex-start; font-size: 14px; line-height: 1.4; text-align: left; border: 1px solid transparent; color: #e0e0e0; position: relative; }
.my-message { background: #d32f2f; color: #fff; align-self: flex-end; text-align: left; border: 1px solid #d32f2f; }
.delete-msg-btn { background: transparent !important; border: none; color: #ffeb3b; cursor: pointer; font-size: 16px; margin-left: 8px; padding: 0 5px; line-height: 1; font-weight: bold; }
.delete-msg-btn:hover { color: #fff; background-color: rgba(0,0,0,0.2) !important; border-radius: 50%; }

/* ---- CUSTOM AUDIO PLAYER STYLES ---- */
.custom-audio-player {
    display: flex;
    align-items: center;
    background-color: #f5f5f5; /* White/Light Gray background like the image */
    border-radius: 12px;
    padding: 8px 15px;
    width: 100%;
    min-width: 240px;
    margin-top: 8px;
    box-sizing: border-box;
}
.audio-play-btn {
    background: none;
    border: none;
    color: #333;
    font-size: 20px;
    cursor: pointer;
    margin-right: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
}
.audio-time-display {
    color: #333;
    font-size: 14px;
    font-family: monospace;
    font-weight: bold;
    flex-grow: 1;
    text-align: left; /* Or center */
}
/* ------------------------------------ */

.chat-input-area { display: flex; flex-direction: column; gap: 8px; margin-top: 5px; position: relative; }
.chat-row-inputs { display: flex; gap: 5px; width: 100%; }
.chat-row-tools { display: flex; gap: 5px; justify-content: flex-start; align-items: center; width: 100%; padding: 2px 0; }

#chatNameInput, .chat-row-inputs input[type=text]:first-child { width: 25%; text-align: center; }
#chatMsgInput, .chat-row-inputs input[type=text]:nth-child(2) { flex-grow: 1; text-align: left; }
#sendChatBtn, .send-btn { background: #d32f2f; color: #fff; padding: 0 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }

.tool-btn { background: #424242; color: #fff; padding: 5px 8px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; min-width: 30px; }
.tool-btn:active { background: #616161; }
.sticker-btn { background: #FF9800 !important; } 
.radio-btn { background: #9C27B0 !important; }
.team-add-custom { background: #009688 !important; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1; font-size: 10px; font-weight: bold; padding: 3px 6px; min-width: 35px; }
.team-dots { display: flex; gap: 3px; margin-top: 2px; }
.dot { width: 7px; height: 7px; border-radius: 50%; border: 1px solid #fff; } .dot-b { background: #2196F3; } .dot-y { background: #FFEB3B; }

/* RECORDING UI STYLES */
.recording-overlay {
    display: none;
    width: 100%;
    height: 50px;
    background: #2c2c2c;
    border-radius: 10px;
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
    box-sizing: border-box;
    position: absolute;
    bottom: 0;
    left: 0;
    z-index: 100;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
}
.recording-text {
    color: #ff1744;
    font-weight: bold;
    font-size: 16px;
    flex-grow: 1;
    text-align: center;
    animation: pulseText 1.5s infinite;
}
@keyframes pulseText { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }

.rec-action-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 20px;
    padding: 5px 10px;
}
.rec-send-btn { color: #FFD700; font-size: 24px; } /* Gold Arrow */
.rec-trash-btn { color: #ccc; font-size: 22px; } /* Trash */
.rec-trash-btn:hover { color: #ff1744; }

.chat-media-content { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; border: 1px solid #555; }
.chat-sticker { width: 100px; height: auto; display: block; margin-top: 5px; }

.sticker-popup { position: absolute; bottom: 60px; left: 0; right: 0; margin: auto; background: #2c2c2c; border: 1px solid #555; border-radius: 10px; width: 90%; max-width: 280px; height: 200px; display: none; flex-direction: column; z-index: 2500; box-shadow: 0 -2px 15px rgba(0,0,0,0.7); }
.sticker-tabs { display: flex; justify-content: space-between; background: #1e1e1e; border-radius: 10px 10px 0 0; padding: 5px; }
.sticker-tab { background: none; border: none; color: #aaa; font-size: 11px; padding: 5px; cursor: pointer; flex: 1; }
.sticker-tab.active { color: #fff; border-bottom: 2px solid #FF9800; }
.sticker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; padding: 5px; overflow-y: auto; height: 100%; }
.sticker-item { width: 100%; height: auto; cursor: pointer; border-radius: 5px; }
.sticker-item:hover { transform: scale(1.1); }

#radioPlayerSection { display: none; position: absolute; bottom: 60px; left: 0; right: 0; margin: auto; width: 90%; max-width: 300px; background: #333; border-radius: 8px; padding: 10px; border: 1px solid #9C27B0; z-index: 2600; box-shadow: 0 -2px 15px #000; }
#radioSelect { width: 100%; padding: 8px; background: #1e1e1e; color: #fff; border: 1px solid #555; border-radius: 5px; margin-bottom: 8px; }
.radio-controls { display: flex; justify-content: space-between; gap: 5px; }
.radio-control-btn { flex: 1; padding: 8px; background: #009688; color: #fff; border-radius: 5px; border: none; cursor: pointer; }
.stop-btn { background: #d32f2f; }

/* -------------------- 6. MODALS STYLES -------------------- */
.position-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
.position-menu-box { background-color: #2c2c2c; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); width: 90%; max-width: 350px; text-align: center; }
.position-menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
.position-menu-grid button { padding: 12px 5px; font-size: 14px; background-color: #444; color: #fff; border-radius: 6px; transition: background-color 0.2s; }
.position-menu-grid button:hover { background-color: #d32f2f; }

.settings-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 10px; }
.settings-modal-content { background-color: #1e1e1e; padding: 25px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.8); width: 95%; max-width: 450px; text-align: left; color: #fff; display: flex; flex-direction: column; max-height: 90vh; }
.settings-modal-content h2 { text-align: center; color: #d32f2f; margin-bottom: 20px; flex-shrink: 0; }
.setting-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #333; }
.setting-item:last-child { border-bottom: none; }
.setting-item input[type="checkbox"] { transform: scale(1.5); cursor: pointer; }
.password-input-group { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 20px; }
.password-input-group input[type="password"] { width: 70%; text-align: center; font-size: 16px; }
.settings-options-container { overflow-y: auto; padding: 10px; border: 1px solid #333; border-radius: 8px; margin-bottom: 15px; flex-grow: 1; }
.settings-footer { text-align: center; margin-top: 0; flex-shrink: 0; padding-top: 15px; border-top: 1px solid #333; }
#saveSettingsBtn { background: #1976d2; color: #fff; width: 100%; padding: 12px; }

.danger-zone { margin-top: 20px; padding-top: 10px; border-top: 1px solid #555; }
.danger-zone h2 { color: #ffeb3b; text-align: center; font-size: 18px; }
.danger-btn { background-color: #d32f2f; color: #fff; width: 100%; padding: 10px; margin-top: 8px; font-size: 14px; }
.danger-btn:hover { background-color: #e57373; }
#matchAddressInput { width: 100%; text-align: left; margin-top: 5px; margin-bottom: 15px; }

.mini-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 2500; }
.mini-modal-box { background: #2c2c2c; padding: 20px; border-radius: 10px; width: 85%; max-width: 300px; text-align: center; border: 1px solid #555; box-shadow: 0 4px 15px #000; }
.mini-modal-box input { width: 90% !important; margin-bottom: 15px; }
.team-select-btns { display: flex; justify-content: space-around; gap: 10px; }
</style>
</head>
<body>

<audio id="musicPlayer" loop preload="auto"><source src="https://raw.githubusercontent.com/ahmadalshaear/eternal-brothers-audio/main/Eternal_Brothers%20_FC_new.mp3" type="audio/mp3"></audio>
<audio id="radioStreamPlayer" preload="none"></audio>
<audio id="notification-sound" preload="auto"><source src="https://www.soundjay.com/button/button-3.mp3" type="audio/mp3"></audio>

<div id="toastContainer"></div> 

<div class="nav-controls">
  <div class="nav-buttons-top">
    <button id="blueBtn" onclick="showSection('blue')">Blue Team</button>
    <button id="homeBtn" onclick="showSection('main')">Home</button>
    <button id="yellowBtn" onclick="showSection('yellow')">Yellow Team</button>
  </div>
  <div class="nav-buttons-bottom">
    <button id="addressBtn" onclick="openGoogleMaps()">Address üìç</button> 
    <button id="arcadeBtn" onclick="openGameCenter()">Games üéÆ</button>
    <div class="settings-audio-group">
        <button id="audioToggleBtn" onclick="toggleBackgroundMusic()">Audio</button>
        <button id="settingsBtn" onclick="showSettingsModal()">‚öô</button> 
    </div>
  </div>
</div>

<div id="main" class="container">
  <h1 style="margin-top:0; font-size:28px; display:flex; align-items:center; justify-content:center; gap:8px;">
    ‚öΩ <span style="color:#1976d2;">Eternal</span> <span style="color:#fbc02d;">Brothers</span> ‚öΩ
  </h1>
  <p style="margin:5px 0; font-weight:bold; color:#fb8c00; font-size:16px;">The Game will be on Sunday at 9:40AM</p>

  <div id="playerManagement">
    <h2>Add Player</h2>
    <input type="text" id="nameInput" placeholder="Enter player name">
    <button id="addPlayerBtn" onclick="addPlayer()">Add</button>
  </div>

  <h2>Main Team (24 max)</h2>
  <ul id="teamList"></ul>

  <h2>Waiting List</h2>
  <ul id="waitingList"></ul>
  
  <button onclick="loadSystemHistory()" style="background:#6a1b9a; color:#fff; margin-top:15px; width:80%;">Show Join/Leave History</button>
  <div id="systemHistoryContainer" style="margin-top:10px; padding:10px; background:#2c2c2c; border-radius:8px; max-width: 400px; margin-left: auto; margin-right: auto; text-align:left; display:none;">
      <h3 style="margin-top:0;">Event History</h3>
      <ul id="historyList" style="text-align:left; font-weight:normal; font-size:14px; color:#ccc;"></ul>
  </div>

  <div class="chat-container">
    <h2>Group Chat</h2>
    <div id="chatMessages" class="chat-messages"></div>
    
    <div class="chat-input-area">
        <div id="recordingBar_global" class="recording-overlay">
            <button class="rec-action-btn rec-send-btn" onclick="finishVoiceRecording('global', 'send')">‚û§</button>
            <span class="recording-text">Recording...</span>
            <button class="rec-action-btn rec-trash-btn" onclick="finishVoiceRecording('global', 'cancel')">üóëÔ∏è</button>
        </div>

        <div class="chat-row-inputs">
            <input type="text" id="chatNameInput" placeholder="Name" value="">
            <input type="text" id="chatMsgInput" placeholder="Type a message...">
            <button id="sendChatBtn" class="send-btn" onclick="sendMessage()">Send</button>
        </div>
        <div class="chat-row-tools">
            <input type="file" id="globalChatFile" accept="image/*,video/*" style="display:none" onchange="handleFileUpload(this, 'global')">
            <button class="tool-btn" onclick="document.getElementById('globalChatFile').click()" title="Upload">üì∑</button>
            <button id="recordBtnGlobal" class="tool-btn record-btn" style="margin-left:5px;" onmousedown="startVoiceRecording('global')" title="Record">üé§</button>
            <button class="tool-btn sticker-btn" style="margin-left:5px;" onclick="toggleStickerMenu('global')" title="Stickers">‚ò∫</button>
            <button class="tool-btn team-add-custom" style="margin-left:5px;" onclick="openTeamAddModal()" title="Add to Team"><span>Add</span><div class="team-dots"><span class="dot dot-b"></span><span class="dot dot-y"></span></div></button>
            <button class="tool-btn radio-btn" style="margin-left:5px;" onclick="toggleRadio()" title="Radio">üìª</button>
        </div>
        
        <div id="radioPlayerSection">
            <select id="radioSelect" onchange="changeRadioChannel()">
                <optgroup label="Quran">
                    <option value="https://server8.mp3quran.net/afs/001.mp3">Mishary Alafasy</option>
                    <option value="https://server7.mp3quran.net/basit/001.mp3">Abdulbasit Abdulsamad</option>
                    <option value="https://server11.mp3quran.net/sds/001.mp3">Abdulrahman Al-Sudais</option>
                </optgroup>
                <optgroup label="News/Info">
                    <option value="https://live-hls-audio-web-aje.getaj.net/AJE/01.m3u8">Al Jazeera English</option>
                    <option value="https://live-hls-audio-web-aja.getaj.net/AJA/01.m3u8">Al Jazeera Arabic</option>
                </optgroup>
                <optgroup label="Entertainment">
                    <option value="https://l3.itworkscdn.net/itwaudio/9026/stream">Rotana FM</option>
                </optgroup>
            </select>
            <div class="radio-controls">
                <button class="radio-control-btn" onclick="playRadio()">‚ñ∂ Play</button>
                <button class="radio-control-btn stop-btn" onclick="stopRadio()">‚èπ Stop</button>
            </div>
        </div>

        <div id="stickerPopupGlobal" class="sticker-popup">
            <div class="sticker-tabs">
                <button class="sticker-tab active" onclick="showStickerTab('global', 'football')">Football</button>
                <button class="sticker-tab" onclick="showStickerTab('global', 'funny')">Funny</button>
                <button class="sticker-tab" onclick="showStickerTab('global', 'action')">Action</button>
                <button class="sticker-tab" onclick="toggleStickerMenu('global')" style="color: #f44336; font-weight: bold;">‚úï</button>
            </div>
            <div id="stickerGridGlobal" class="sticker-grid"></div>
        </div>
    </div>
  </div>
</div>

<div id="blue" class="container" style="background:#1565c0aa;">
  <h2>Blue Team</h2>
  <div id="bluePlayerManagement">
    <input type="text" id="blueInput" placeholder="Enter player name">
    <button id="addBlueBtn" onclick="addBlue()">Add</button>
  </div>
  <ul id="blueList"></ul>
  
  <div class="formation-controls">
    <button class="formation-btn" onclick="applyFormation('blue', '4-3-3')">4-3-3</button>
    <button class="formation-btn" onclick="applyFormation('blue', '4-4-2')">4-4-2</button>
    <button class="formation-btn" onclick="applyFormation('blue', '3-4-3')">3-4-3</button>
    <button id="blueDynamicBtn" class="dynamic-btn" onclick="applyDynamicPlan('blue')">Apply Dynamic Plan</button>
  </div>
  
  <h3>Plan</h3>
  <div id="bluePlan" class="field">
    <div class="mid-line"></div><div class="center-circle"></div><div class="penalty-box-left"></div><div class="penalty-box-right"></div>
  </div>

  <div class="chat-container team-chat-container">
    <h3>Blue Team Chat üó©</h3>
    <div id="blueChatMessages" class="chat-messages"></div>
    <div class="chat-input-area">
        <div id="recordingBar_blue" class="recording-overlay">
            <button class="rec-action-btn rec-send-btn" onclick="finishVoiceRecording('blue', 'send')">‚û§</button>
            <span class="recording-text">Recording...</span>
            <button class="rec-action-btn rec-trash-btn" onclick="finishVoiceRecording('blue', 'cancel')">üóëÔ∏è</button>
        </div>

        <div class="chat-row-inputs">
            <input type="text" id="blueChatNameInput" placeholder="Name" value="">
            <input type="text" id="blueChatMsgInput" placeholder="Message...">
            <button id="sendBlueChatBtn" class="send-btn" onclick="sendTeamMessage('blue')">Send</button>
        </div>
        <div class="chat-row-tools">
            <input type="file" id="blueChatFile" accept="image/*,video/*" style="display:none" onchange="handleFileUpload(this, 'blue')">
            <button class="tool-btn" onclick="document.getElementById('blueChatFile').click()">üì∑</button>
            <button id="recordBtnBlue" class="tool-btn record-btn" style="margin-left:5px;" onmousedown="startVoiceRecording('blue')">üé§</button>
            <button class="tool-btn sticker-btn" style="margin-left:5px;" onclick="toggleStickerMenu('blue')">‚ò∫</button>
        </div>
        <div id="stickerPopupBlue" class="sticker-popup">
            <div class="sticker-tabs">
                <button class="sticker-tab active" onclick="showStickerTab('blue', 'football')">Football</button>
                <button class="sticker-tab" onclick="showStickerTab('blue', 'funny')">Funny</button>
                <button class="sticker-tab" onclick="showStickerTab('blue', 'action')">Action</button>
                <button class="sticker-tab" onclick="toggleStickerMenu('blue')" style="color: #f44336; font-weight: bold;">‚úï</button>
            </div>
            <div id="stickerGridBlue" class="sticker-grid"></div>
        </div>
    </div>
  </div>
</div>

<div id="yellow" class="container" style="background:#fdd835aa; color:#000;">
  <h2>Yellow Team</h2>
  <div id="yellowPlayerManagement">
    <input type="text" id="yellowInput" placeholder="Enter player name">
    <button id="addYellowBtn" onclick="addYellow()">Add</button>
  </div>
  <ul id="yellowList"></ul>
  
  <div class="formation-controls">
    <button class="formation-btn" onclick="applyFormation('yellow', '4-3-3')">4-3-3</button>
    <button class="formation-btn" onclick="applyFormation('yellow', '4-4-2')">4-4-2</button>
    <button class="formation-btn" onclick="applyFormation('yellow', '3-4-3')">3-4-3</button>
    <button id="yellowDynamicBtn" class="dynamic-btn" onclick="applyDynamicPlan('yellow')">Apply Dynamic Plan</button>
  </div>
  
  <h3>Plan</h3>
  <div id="yellowPlan" class="field">
    <div class="mid-line"></div><div class="center-circle"></div><div class="penalty-box-left"></div><div class="penalty-box-right"></div>
  </div>

  <div class="chat-container team-chat-container">
    <h3 style="color: #000;">Yellow Team Chat üó©</h3>
    <div id="yellowChatMessages" class="chat-messages"></div>
    <div class="chat-input-area">
        <div id="recordingBar_yellow" class="recording-overlay">
            <button class="rec-action-btn rec-send-btn" onclick="finishVoiceRecording('yellow', 'send')">‚û§</button>
            <span class="recording-text">Recording...</span>
            <button class="rec-action-btn rec-trash-btn" onclick="finishVoiceRecording('yellow', 'cancel')">üóëÔ∏è</button>
        </div>

        <div class="chat-row-inputs">
            <input type="text" id="yellowChatNameInput" placeholder="Name" value="">
            <input type="text" id="yellowChatMsgInput" placeholder="Message...">
            <button id="sendYellowChatBtn" class="send-btn" onclick="sendTeamMessage('yellow')">Send</button>
        </div>
        <div class="chat-row-tools">
            <input type="file" id="yellowChatFile" accept="image/*,video/*" style="display:none" onchange="handleFileUpload(this, 'yellow')">
            <button class="tool-btn" onclick="document.getElementById('yellowChatFile').click()">üì∑</button>
            <button id="recordBtnYellow" class="tool-btn record-btn" style="margin-left:5px;" onmousedown="startVoiceRecording('yellow')">üé§</button>
            <button class="tool-btn sticker-btn" style="margin-left:5px;" onclick="toggleStickerMenu('yellow')">‚ò∫</button>
        </div>
        <div id="stickerPopupYellow" class="sticker-popup">
            <div class="sticker-tabs">
                <button class="sticker-tab active" onclick="showStickerTab('yellow', 'football')">Football</button>
                <button class="sticker-tab" onclick="showStickerTab('yellow', 'funny')">Funny</button>
                <button class="sticker-tab" onclick="showStickerTab('yellow', 'action')">Action</button>
                <button class="sticker-tab" onclick="toggleStickerMenu('yellow')" style="color: #f44336; font-weight: bold;">‚úï</button>
            </div>
            <div id="stickerGridYellow" class="sticker-grid"></div>
        </div>
    </div>
  </div>
</div>

<div id="positionMenuOverlay" class="position-menu-overlay" style="display:none;">
    <div class="position-menu-box">
        <h3 id="positionMenuTitle">Select Position for Player Name</h3>
        <div id="positionMenuGrid" class="position-menu-grid">
            </div>
        <button onclick="closePositionMenu()" style="margin-top: 15px; background: #555;">Cancel</button>
    </div>
</div>

<div id="settingsModalOverlay" class="settings-modal-overlay">
    <div class="settings-modal-content">
        <div id="passwordSection">
            <h2>Admin Settings</h2>
            <div class="password-input-group">
                <input type="password" id="settingsPassword" placeholder="Password">
                <button onclick="authenticateSettings()" style="background: #d32f2f; color: #fff; width: 70%;">Enter</button>
                <p id="passwordError" style="color: #ffeb3b; display: none; margin: 5px 0;">Incorrect password.</p>
            </div>
        </div>
        <div id="settingsControls" style="display:none; flex-grow: 1; display: flex; flex-direction: column; min-height: 0;">
            <div class="settings-options-container">
                <h2>Match Details</h2>
                <label for="matchAddressInput" style="font-weight: bold; display: block; margin-bottom: 5px;">Match Address (Google Maps)</label>
                <input type="text" id="matchAddressInput" placeholder="Enter full match address or coordinates">
                <h2>System Options</h2>
                <div class="setting-item"><label for="allowPlayerEdit">Allow Player Add/Edit/Delete (Main Lists)</label><input type="checkbox" id="allowPlayerEdit"></div>
                <div class="setting-item"><label for="allowTeamEdit">Allow Player Add/Edit/Delete (Teams)</label><input type="checkbox" id="allowTeamEdit"></div>
                <div class="setting-item"><label for="allowFormationEdit">Allow Applying Formations (Plan)</label><input type="checkbox" id="allowFormationEdit"></div>
                <div class="setting-item"><label for="allowAddressEdit">Allow Editing Match Address</label><input type="checkbox" id="allowAddressEdit"></div>
                <div class="setting-item"><label for="allowChat">Allow Sending Chat Messages</label><input type="checkbox" id="allowChat"></div>
                <div class="setting-item"><label for="allowImageUpload">Allow Image Uploads in Chat</label><input type="checkbox" id="allowImageUpload"></div>
                <div class="setting-item"><label for="allowMusic">Allow Toggling Music</label><input type="checkbox" id="allowMusic"></div>
                <div class="setting-item"><label for="enforceTimeRestriction">Enforce Time Restriction (Wed-Sun)</label><input type="checkbox" id="enforceTimeRestriction"></div>
                <div class="setting-item"><label for="requireIndividualPin">Require Individual Player PIN (Main List)</label><input type="checkbox" id="requireIndividualPin"></div>
                <div class="setting-item"><label for="requireTeamPinForAdd">Require Team PIN for Main List</label><input type="checkbox" id="requireTeamPinForAdd"></div>
                <div class="danger-zone">
                    <h2>Danger Zone - Data Deletion</h2>
                    <button class="danger-btn" onclick="clearGroupChat()">Clear Group Chat (Player Msgs)</button>
                    <button class="danger-btn" onclick="clearSystemHistory()">Clear System History (Alerts)</button>
                    <button class="danger-btn" onclick="clearBlueChat()">Clear Blue Team Chat</button>
                    <button class="danger-btn" onclick="clearYellowChat()">Clear Yellow Team Chat</button>
                    <button class="danger-btn" onclick="clearMainTeam()">Clear Main Team List</button>
                    <button class="danger-btn" onclick="clearWaitingList()">Clear Waiting List</button>
                    <button class="danger-btn" onclick="clearBlueTeam()">Clear Blue Team List</button>
                    <button class="danger-btn" onclick="clearYellowTeam()">Clear Yellow Team List</button>
                </div>
            </div> 
            <div class="settings-footer"><button id="saveSettingsBtn" onclick="saveSettings()">Save & Close</button></div>
        </div>
    </div>
</div>

<div id="teamAddModalOverlay" class="mini-modal-overlay">
    <div class="mini-modal-box">
        <h3 style="color:#fff; margin-top:0;">Add Player to Team</h3>
        <p style="font-size:12px; color:#ccc;">Same rules apply (PIN/Settings)</p>
        <input type="text" id="chatTeamAddInput" placeholder="Enter Player Name">
        <div class="team-select-btns">
            <button onclick="confirmAddToTeam('blue')" style="background:#1565c0; color:#fff; flex:1;">Blue</button>
            <button onclick="confirmAddToTeam('yellow')" style="background:#fdd835; color:#000; flex:1;">Yellow</button>
        </div>
        <button onclick="closeTeamAddModal()" style="background:#555; color:#fff; margin-top:10px; width:100%;">Cancel</button>
    </div>
</div>

<div id="gameCenterOverlay" class="mini-modal-overlay">
    <div class="mini-modal-box" style="max-width: 360px; background: #222; border: 2px solid #673AB7; overflow-y:auto; max-height:80vh;">
        <h3 style="color:#fff; margin-top:0; font-family: 'Courier New', monospace;">üïπÔ∏è ETERNAL ARCADE üïπÔ∏è</h3>
        <div id="gameMenu">
            <p style="color:#ccc; font-size:12px;">Select a Game:</p>
            <button onclick="startGame('juggling')" style="background:linear-gradient(45deg, #FF9800, #F57C00); width:100%; margin-bottom:8px; padding:12px; font-weight:bold; border:2px solid #fff;">‚öΩ Keepy Uppy</button>
            <button onclick="startGame('flappy')" style="background:linear-gradient(45deg, #2196F3, #1976D2); width:100%; margin-bottom:8px; padding:12px; font-weight:bold; border:2px solid #fff;">üöÄ Flappy Ball</button>
            <button onclick="startGame('penalty')" style="background:linear-gradient(45deg, #4CAF50, #388E3C); width:100%; margin-bottom:8px; padding:12px; font-weight:bold; border:2px solid #fff;">ü•Ö Penalty Rush</button>
            <button onclick="startGame('dribbler')" style="background:linear-gradient(45deg, #9C27B0, #673AB7); width:100%; margin-bottom:8px; padding:12px; font-weight:bold; border:2px solid #fff;">üèÉ Dribble Challenge</button>
            <button onclick="startGame('keeper')" style="background:linear-gradient(45deg, #607D8B, #455A64); width:100%; margin-bottom:8px; padding:12px; font-weight:bold; border:2px solid #fff;">üß§ Goalkeeper Hero</button>
        </div>
        <div id="gameArea" style="display:none; position:relative;">
            <canvas id="gameCanvas" width="320" height="400" style="background:#333; border-radius:8px; cursor:pointer; box-shadow: 0 0 15px rgba(103, 58, 183, 0.5);"></canvas>
            <div id="scoreDisplay" style="position:absolute; top:10px; left:10px; color:#fff; font-size:20px; font-weight:bold; pointer-events:none; text-shadow: 2px 2px #000;">Score: 0</div>
            <div id="startPrompt" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; font-weight:bold; pointer-events:none; text-align:center; text-shadow: 2px 2px #000; background:rgba(0,0,0,0.5); padding:10px; border-radius:5px;">Tap to Start!</div>
            <button onclick="exitGame()" style="background:#d32f2f; margin-top:5px; width:100%;">Exit to Menu</button>
        </div>
        <div id="leaderboardSection" style="margin-top:15px; border-top:1px solid #555; padding-top:10px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 style="color:#FFD700; margin:5px 0;">üèÜ High Scores</h4>
                <select id="lbGameSelector" onchange="loadLeaderboard(this.value)" style="background:#333; color:#fff; border:1px solid #555; font-size:12px;">
                    <option value="juggling">Keepy Uppy</option>
                    <option value="flappy">Flappy Ball</option>
                    <option value="penalty">Penalty Rush</option>
                    <option value="dribbler">Dribbler</option>
                    <option value="keeper">Keeper</option>
                </select>
            </div>
            <ul id="leaderboardList" style="font-size:12px; max-height:100px; overflow-y:auto; text-align:left; padding:5px; background:#111; border-radius:5px;">
                <li style="color:#aaa;">Loading...</li>
            </ul>
        </div>
        <button onclick="closeGameCenter()" id="closeGameBtn" style="background:#555; color:#fff; margin-top:10px; width:100%;">Close Arcade</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script> 

<script>
const supabaseUrl = "https://wihhlvgkjglphjzhivdn.supabase.co"; 
const supabaseServiceKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndpaGhsdmdramdscGhqemhpdmRuIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Mjk0MzA5NiwiZXhwIjoyMDc4NTE5MDk2fQ.qVT2CKqMKRW1Y1qEox9_cl4JvuLY659_UQxVDMBWBFA"; 
const supabase = window.supabase.createClient(supabaseUrl, supabaseServiceKey);

let currentPositionTarget = { team: null, playerId: null, playerName: null };
const nameColors = ["#e53935", "#1e88e5", "#fbc02d","#43a047","#8e24aa","#fb8c00","#00acc1","#d81b60","#6d4c41","#3949ab","#f4511e","#7cb342"];
let audioInitialized = false; 
let matchAddress = "Address üìç"; 
const ADMIN_PASSWORD = "2023"; 
const TEAM_ADD_PIN = "1111"; 
let mediaRecorder = null; let audioChunks = []; let isRecording = false;

const STICKERS = {
    football: ["https://media.giphy.com/media/xT9IgG50Fb7Mi0prBC/giphy.gif", "https://media.giphy.com/media/3o6vXNLzXdW4sbFRGo/giphy.gif", "https://media.giphy.com/media/l2JHZKNio4EjY6iqY/giphy.gif"],
    funny: ["https://media.giphy.com/media/10JhviFuU2gWD6/giphy.gif", "https://media.giphy.com/media/3oEjHAUOqG3lSS0f1C/giphy.gif", "https://media.giphy.com/media/26tP3M3i03qgDnhGU/giphy.gif"],
    action: ["https://media.giphy.com/media/3o7TKtnuHOHHUjR38Y/giphy.gif", "https://media.giphy.com/media/l0Iy8hSJalxlbkXIk/giphy.gif", "https://media.giphy.com/media/l41lS23ZZKo8hiiZ2/giphy.gif"]
};

let systemConfig = { allowPlayerEdit: true, allowTeamEdit: true, allowFormationEdit: true, allowAddressEdit: true, allowChat: true, allowImageUpload: true, allowMusic: true, enforceTimeRestriction: true, requireIndividualPin: true, requireTeamPinForAdd: false };
const POSITIONS_LIST = [{ code: 'GK', label: 'Goalkeeper' }, { code: 'CB', label: 'Center Back' }, { code: 'RB', label: 'Right Back' }, { code: 'LB', label: 'Left Back' }, { code: 'DM', label: 'Defensive Mid' }, { code: 'CM', label: 'Center Mid' }, { code: 'RM', label: 'Right Mid' }, { code: 'LM', label: 'Left Mid' }, { code: 'CAM', label: 'Attacking Mid' }, { code: 'CF', label: 'Center Forward' }, { code: 'RW', label: 'Right Winger' }, { code: 'LW', label: 'Left Winger' }, { code: 'ST', label: 'Striker' }, { code: 'SUB', label: 'Substitute' }];

// --- NEW HORIZONTAL FORMATIONS (MERGED FROM NEW CODE) ---
const FORMATIONS = {
    '4-3-3': [
        { left: '6%', top: '50%', code: 'GK' }, { left: '25%', top: '15%', code: 'LB' }, { left: '18%', top: '38%', code: 'CB' }, { left: '18%', top: '62%', code: 'CB' }, { left: '25%', top: '85%', code: 'RB' },
        { left: '40%', top: '50%', code: 'DM' }, { left: '55%', top: '30%', code: 'CM' }, { left: '55%', top: '70%', code: 'CM' },
        { left: '80%', top: '15%', code: 'LW' }, { left: '85%', top: '50%', code: 'ST' }, { left: '80%', top: '85%', code: 'RW' }, { left: '50%', top: '-15%', code: 'SUB' }
    ],
    '4-4-2': [
        { left: '6%', top: '50%', code: 'GK' }, { left: '25%', top: '15%', code: 'LB' }, { left: '20%', top: '38%', code: 'CB' }, { left: '20%', top: '62%', code: 'CB' }, { left: '25%', top: '85%', code: 'RB' },
        { left: '50%', top: '15%', code: 'LM' }, { left: '45%', top: '40%', code: 'CM' }, { left: '45%', top: '60%', code: 'CM' }, { left: '50%', top: '85%', code: 'RM' },
        { left: '80%', top: '35%', code: 'ST' }, { left: '80%', top: '65%', code: 'ST' }, { left: '50%', top: '-15%', code: 'SUB' }
    ],
    '3-4-3': [
        { left: '6%', top: '50%', code: 'GK' }, { left: '20%', top: '20%', code: 'CB' }, { left: '15%', top: '50%', code: 'CB' }, { left: '20%', top: '80%', code: 'CB' },
        { left: '45%', top: '10%', code: 'LM' }, { left: '40%', top: '40%', code: 'CM' }, { left: '40%', top: '60%', code: 'CM' }, { left: '45%', top: '90%', code: 'RM' },
        { left: '75%', top: '20%', code: 'LW' }, { left: '82%', top: '50%', code: 'ST' }, { left: '75%', top: '80%', code: 'RW' }, { left: '50%', top: '-15%', code: 'SUB' }
    ]
};

function stringToHash(str) { let hash = 0; if (str.length === 0) return hash; for (let i = 0; i < str.length; i++) { const char = str.charCodeAt(i); hash = ((hash << 5) - hash) + char; hash |= 0; } return Math.abs(hash); }
function getColorForUsername(username) { return nameColors[stringToHash(username.trim().toUpperCase()) % nameColors.length]; }

function showSection(id){
  document.querySelectorAll('.container').forEach(c=>c.style.display='none');
  document.getElementById(id).style.display='block';
  document.querySelectorAll('.sticker-popup').forEach(p => p.style.display = 'none');
  applyUIRestrictions();
  if (id === 'blue') { loadTeamChatMessages('blue'); document.getElementById('blueChatNameInput').value = localStorage.getItem('chat_username') || ''; setupDraggable('blue'); } 
  else if (id === 'yellow') { loadTeamChatMessages('yellow'); document.getElementById('yellowChatNameInput').value = localStorage.getItem('chat_username') || ''; setupDraggable('yellow'); } 
  else if (id === 'main') { loadChatMessages(); }
}
showSection('main'); 

function toggleBackgroundMusic() {
    if (!systemConfig.allowMusic) { alert("Audio disabled by admin."); return; }
    const audio = document.getElementById('musicPlayer');
    if (audio.paused) { audio.play(); document.getElementById('audioToggleBtn').innerHTML = 'Stop Audio'; } 
    else { audio.pause(); document.getElementById('audioToggleBtn').innerHTML = 'Audio'; }
}

async function openGoogleMaps() {
    const { data } = await supabase.from('app_config').select('match_address').eq('id', 1).single(); 
    const savedAddress = data ? data.match_address : null;
    if (!savedAddress || savedAddress.trim() === '') { alert("No address set."); return; }
    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(savedAddress)}`, '_blank');
}

// SETTINGS & PIN
async function showSettingsModal() {
    document.getElementById('settingsPassword').value = ''; document.getElementById('passwordError').style.display = 'none'; document.getElementById('passwordSection').style.display = 'block'; document.getElementById('settingsControls').style.display = 'none'; document.getElementById('settingsModalOverlay').style.display = 'flex';
    const { data } = await supabase.from('app_config').select('match_address').eq('id', 1).single(); 
    document.getElementById('matchAddressInput').value = data ? data.match_address : '';
}
function authenticateSettings() {
    if (document.getElementById('settingsPassword').value === ADMIN_PASSWORD) {
        document.getElementById('passwordSection').style.display = 'none'; document.getElementById('settingsControls').style.display = 'flex';
        document.getElementById('allowPlayerEdit').checked = systemConfig.allowPlayerEdit; document.getElementById('allowTeamEdit').checked = systemConfig.allowTeamEdit; document.getElementById('allowFormationEdit').checked = systemConfig.allowFormationEdit; document.getElementById('allowAddressEdit').checked = systemConfig.allowAddressEdit; document.getElementById('allowChat').checked = systemConfig.allowChat; document.getElementById('allowImageUpload').checked = systemConfig.allowImageUpload; document.getElementById('allowMusic').checked = systemConfig.allowMusic; document.getElementById('enforceTimeRestriction').checked = systemConfig.enforceTimeRestriction; document.getElementById('requireIndividualPin').checked = systemConfig.requireIndividualPin; document.getElementById('requireTeamPinForAdd').checked = systemConfig.requireTeamPinForAdd;
    } else { document.getElementById('passwordError').style.display = 'block'; }
}
async function saveSettings() {
    const newConfig = { allowPlayerEdit: document.getElementById('allowPlayerEdit').checked, allowTeamEdit: document.getElementById('allowTeamEdit').checked, allowFormationEdit: document.getElementById('allowFormationEdit').checked, allowAddressEdit: document.getElementById('allowAddressEdit').checked, allowChat: document.getElementById('allowChat').checked, allowImageUpload: document.getElementById('allowImageUpload').checked, allowMusic: document.getElementById('allowMusic').checked, enforceTimeRestriction: document.getElementById('enforceTimeRestriction').checked, requireIndividualPin: document.getElementById('requireIndividualPin').checked, requireTeamPinForAdd: document.getElementById('requireTeamPinForAdd').checked };
    await supabase.from('app_config').update({ system_config: JSON.stringify(newConfig), match_address: document.getElementById('matchAddressInput').value.trim() }).eq('id', 1);
    systemConfig = newConfig; matchAddress = document.getElementById('matchAddressInput').value.trim(); loadMatchAddress(); applyUIRestrictions(); document.getElementById('settingsModalOverlay').style.display = 'none'; alert('Settings saved!');
}

async function clearTableData(tableName, confirmMessage, friendlyName) { if (!confirm(confirmMessage)) return; await supabase.from(tableName).delete().gt('id', 0); alert(`${friendlyName} cleared.`); reloadList(tableName); }
function clearGroupChat() { clearTableData('chat_messages', "Clear Group Chat?", "Group Chat"); }
function clearSystemHistory() { clearTableData('system_history', "Clear History?", "History"); }
function clearBlueChat() { clearTableData('blue_chat', "Clear Blue Chat?", "Blue Chat"); }
function clearYellowChat() { clearTableData('yellow_chat', "Clear Yellow Chat?", "Yellow Chat"); }
function clearMainTeam() { clearTableData('main_team', "Clear Main Team?", "Main Team"); }
function clearWaitingList() { clearTableData('waiting_list', "Clear Waiting List?", "Waiting List"); }
function clearBlueTeam() { clearTableData('blue_team', "Clear Blue Team?", "Blue Team"); }
function clearYellowTeam() { clearTableData('yellow_team', "Clear Yellow Team?", "Yellow Team"); }

async function canEditCaptain(table, playerId) {
    if (table !== 'blue_team' && table !== 'yellow_team') return true;
    const { data: allPlayers } = await supabase.from(table).select('id, player_pin').order('id', { ascending: true });
    if (!allPlayers || allPlayers.length === 0 || allPlayers[0].id !== playerId) return true;
    const enteredPin = prompt(`Captain Action: Enter PIN:`);
    return enteredPin === allPlayers[0].player_pin;
}
async function verifyIndividualPin(table, id) {
    const { data } = await supabase.from(table).select('player_pin').eq('id', id).single();
    if (!data || !data.player_pin) return true;
    return prompt("Enter your PIN:") === data.player_pin;
}
async function loadSystemConfig() {
    const { data } = await supabase.from('app_config').select('system_config').eq('id', 1).single(); 
    if (data && data.system_config) systemConfig = { ...systemConfig, ...JSON.parse(data.system_config) };
    applyUIRestrictions(); 
}
function applyUIRestrictions() {
    document.getElementById('playerManagement').style.display = systemConfig.allowPlayerEdit ? 'block' : 'none';
    document.querySelectorAll('.action-btn').forEach(btn => {
        const isTeam = btn.closest('#blueList') || btn.closest('#yellowList');
        btn.style.display = isTeam ? (systemConfig.allowTeamEdit ? 'inline-block' : 'none') : (systemConfig.allowPlayerEdit ? 'inline-block' : 'none');
    });
    document.getElementById('bluePlayerManagement').style.display = systemConfig.allowTeamEdit ? 'block' : 'none';
    document.getElementById('yellowPlayerManagement').style.display = systemConfig.allowTeamEdit ? 'block' : 'none';
    document.querySelectorAll('.formation-btn, .dynamic-btn').forEach(btn => btn.style.display = systemConfig.allowFormationEdit ? 'inline-block' : 'none');
    document.querySelectorAll('.chat-input-area').forEach(el => el.style.display = systemConfig.allowChat ? 'flex' : 'none');
}

function isWithinAllowedTime(){
    if (!systemConfig.enforceTimeRestriction) return true;
    const now = new Date(); const d = now.getDay(); const h = now.getHours();
    if (d >= 3 && d <= 6) { if (d === 3) return h >= 15; return true; } else if (d === 0) return h < 12; return false;
}
function formatPlayerTime(timestamp) { if (!timestamp) return ''; return new Date(timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }); }

// PLAYER & LIST LOGIC
async function addPlayer(){
  if(!systemConfig.allowPlayerEdit) return alert("Add disabled");
  if(!isWithinAllowedTime()){
    alert("Adding players is only allowed from Wednesday 3 PM to Sunday 12 PM.");
    return;
  }
  const name = document.getElementById("nameInput").value.trim();
  if(!name) return alert("Enter name");
  if(systemConfig.requireTeamPinForAdd && prompt("Team PIN:") !== TEAM_ADD_PIN) return alert("Wrong PIN");
  let pin = null;
  if (systemConfig.requireIndividualPin) { pin = prompt("Create 4-digit PIN:"); if (!pin) return; }
  const { data: team } = await supabase.from("main_team").select("id");
  const table = team.length < 24 ? "main_team" : "waiting_list";
  await supabase.from(table).insert([{ name, time: Date.now(), player_pin: pin }]);
  if(team.length < 24) sendSystemMessageToChat(name, `Joined Main Team`);
  else sendSystemMessageToChat(name, `Added to Waiting List`);
  document.getElementById("nameInput").value=""; loadPlayers();
}
async function loadPlayers(){
  const { data: team } = await supabase.from("main_team").select("*").order("id");
  const { data: waiting } = await supabase.from("waiting_list").select("*").order("id");
  renderList("teamList", team, "main_team"); renderList("waitingList", waiting, "waiting_list");
}
function renderList(id, data, table){
    const ul = document.getElementById(id); ul.innerHTML = "";
    if(data) data.forEach((p,i) => {
        const btns = systemConfig.allowPlayerEdit ? `<span><button class="action-btn edit-btn" onclick="editPlayer('${table}',${p.id},'${p.name}')">Edit</button><button class="action-btn delete-btn" onclick="deletePlayer('${table}',${p.id})">Delete</button></span>` : '';
        ul.innerHTML += `<li><div class="player-info"><span>${i+1}. ${p.name} <span class="player-time">${formatPlayerTime(p.time)}</span></span></div>${btns}</li>`;
    });
}
async function deletePlayer(table, id){
  if((table.includes('team') && !systemConfig.allowTeamEdit) || (!table.includes('team') && !systemConfig.allowPlayerEdit)) return;
  if(table.includes('_team') && !await canEditCaptain(table, id)) return;
  if(!table.includes('_team') && systemConfig.requireIndividualPin && !await verifyIndividualPin(table, id)) return;
  if(!confirm("Delete player?")) return;
  await supabase.from(table).delete().eq("id",id);
  if(table==="main_team") refillMainTeam();
  reloadList(table);
}
async function editPlayer(table,id,oldName){
  if((table.includes('team') && !systemConfig.allowTeamEdit) || (!table.includes('team') && !systemConfig.allowPlayerEdit)) return;
  if(table.includes('_team') && !await canEditCaptain(table, id)) return;
  if(!table.includes('_team') && systemConfig.requireIndividualPin && !await verifyIndividualPin(table, id)) return;
  const newName=prompt(`Edit name:`, oldName);
  if(!newName) return;
  await supabase.from(table).update({name:newName.trim()}).eq("id",id); 
  reloadList(table);
}
async function refillMainTeam(){
  const { data: team } = await supabase.from("main_team").select("id");
  const { data: waiting } = await supabase.from("waiting_list").select("*").order("id", { ascending: true }); 
  if(team.length < 24 && waiting.length > 0){
    const f = waiting[0];
    await supabase.from("main_team").insert([{ name: f.name, time: Date.now(), player_pin: f.player_pin }]);
    await supabase.from("waiting_list").delete().eq("id", f.id);
    sendSystemMessageToChat(f.name, `Moved to Main Team`);
  }
}
function reloadList(table){
  if(table.includes("main") || table.includes("waiting")) loadPlayers();
  else if(table==="blue_team") loadBlue(); else if(table==="yellow_team") loadYellow();
  else if(table.includes("chat")) { if(table.includes("blue")) loadTeamChatMessages('blue'); else if(table.includes("yellow")) loadTeamChatMessages('yellow'); else loadChatMessages(); }
  else if(table.includes("system_history")) loadSystemHistory(false);
}

// TEAM LOGIC
async function addTeam(team, inputId, providedName){
  if(!systemConfig.allowTeamEdit) return;
  let name = providedName || document.getElementById(inputId).value.trim();
  if(!name) return;
  const table = `${team}_team`;
  const { data: curr } = await supabase.from(table).select("id");
  if(curr.length >= 12) return alert("Team Full");
  let pin = null;
  if (curr.length === 0) { pin = prompt(`Captain (${name}) Create PIN:`); if (!pin) return; }
  const pos = FORMATIONS['4-3-3'][curr.length] || { left: '50%', top: '-15%', code: 'SUB' };
  await supabase.from(table).insert([{ name, time: Date.now(), position: JSON.stringify({left:pos.left, top:pos.top}), position_code: pos.code, player_pin: pin }]);
  if(!providedName) document.getElementById(inputId).value="";
  if(providedName) closeTeamAddModal();
  reloadList(table);
}
async function addBlue(n){ addTeam('blue', 'blueInput', n); }
async function addYellow(n){ addTeam('yellow', 'yellowInput', n); }

async function loadTeamData(team){
  const table = `${team}_team`;
  const { data } = await supabase.from(table).select("*").order("id");
  const ul=document.getElementById(`${team}List`);
  const field=document.getElementById(`${team}Plan`);
  ul.innerHTML=""; field.innerHTML=`<div class="mid-line"></div><div class="center-circle"></div><div class="penalty-box-left"></div><div class="penalty-box-right"></div>`; 
  if(data) data.forEach((p,i)=>{
    const btns = systemConfig.allowTeamEdit ? `<span><button class="action-btn edit-btn" onclick="editPlayer('${table}',${p.id},'${p.name}')">Edit</button><button class="action-btn delete-btn" onclick="deletePlayer('${table}',${p.id})">Delete</button></span>` : '';
    ul.innerHTML += `<li><div class="player-info"><span>${i+1}. ${p.name} ${i===0?'(C)':''}</span></div>${btns}</li>`;
    createPlayerMarker(team, p.name, p.id, JSON.parse(p.position), p.position_code, i + 1);
  });
  setupDraggable(team);
}
function loadBlue(){ loadTeamData('blue'); }
function loadYellow(){ loadTeamData('yellow'); }

// FORMATION LOGIC (UPDATED FOR HORIZONTAL)
async function canControlPlan(team) {
    if (!systemConfig.allowFormationEdit) { alert("Formation disabled."); return false; }
    if (sessionStorage.getItem(`${team}_captain_unlocked`) === 'true') return true;
    const table = `${team}_team`;
    const { data } = await supabase.from(table).select('id, player_pin').order('id', { ascending: true }).limit(1).single();
    if (!data || !data.player_pin) { alert("No Captain PIN."); return false; }
    const enteredPin = prompt(`Enter Captain PIN for ${team}:`);
    if (enteredPin === data.player_pin) { sessionStorage.setItem(`${team}_captain_unlocked`, 'true'); return true; } 
    else { alert("Wrong PIN."); return false; }
}

function getAutoPositionName(leftPct, topPct) {
    const x = parseFloat(leftPct); const y = parseFloat(topPct);
    if (x < 12) return 'GK';
    if (x < 32) { if (y < 30) return 'LB'; if (y > 70) return 'RB'; return 'CB'; }
    if (x < 60) { if (y < 25) return 'LM'; if (y > 75) return 'RM'; if (x < 45) return 'DM'; return 'CM'; }
    if (y < 30) return 'LW'; if (y > 70) return 'RW'; if (x < 80) return 'CF'; return 'ST';
}

function setupDraggable(team) {
  const fieldId = `#${team}Plan`; const table = `${team}_team`; const field = document.getElementById(`${team}Plan`);
  interact(`${fieldId} .player-marker`).unset();
  if (!systemConfig.allowFormationEdit) return;
  interact(`${fieldId} .player-marker`).draggable({
      modifiers: [ interact.modifiers.restrictRect({ restriction: field }) ],
      listeners: {
        start: async (event) => {
            if (sessionStorage.getItem(`${team}_captain_unlocked`) !== 'true') {
                if (!await canControlPlan(team)) { event.interaction.stop(); return; }
            }
            const rect = field.getBoundingClientRect();
            event.target.dataset.x = (parseFloat(event.target.style.left)/100) * rect.width;
            event.target.dataset.y = (parseFloat(event.target.style.top)/100) * rect.height;
        },
        move (event) {
          if (sessionStorage.getItem(`${team}_captain_unlocked`) !== 'true') return;
          let x = (parseFloat(event.target.dataset.x) || 0) + event.dx;
          let y = (parseFloat(event.target.dataset.y) || 0) + event.dy;
          event.target.style.left = `${x}px`; event.target.style.top = `${y}px`;
          event.target.dataset.x = x; event.target.dataset.y = y;
        },
        end: (event) => {
          if (sessionStorage.getItem(`${team}_captain_unlocked`) !== 'true') return;
          const rect = field.getBoundingClientRect();
          let lp = (parseFloat(event.target.dataset.x) / rect.width) * 100;
          let tp = (parseFloat(event.target.dataset.y) / rect.height) * 100;
          const newCode = getAutoPositionName(lp, tp);
          event.target.querySelector('.player-position-label').innerText = newCode;
          event.target.style.left = `${lp.toFixed(2)}%`; event.target.style.top = `${tp.toFixed(2)}%`;
          event.target.style.transform = `translate(-50%, -50%)`;
          supabase.from(table).update({ position: JSON.stringify({ left: `${lp.toFixed(2)}%`, top: `${tp.toFixed(2)}%` }), position_code: newCode }).eq('id', event.target.dataset.playerId).then();
        }
      }
  });
}

async function applyFormation(team, name) {
    if (!await canControlPlan(team)) return;
    const table = `${team}_team`; const form = FORMATIONS[name];
    const { data: players } = await supabase.from(table).select('id').order('id');
    players.slice(0, 12).map((p, i) => {
        const pos = i < form.length ? form[i] : { left: '50%', top: '-15%', code: 'SUB' };
        supabase.from(table).update({ position: JSON.stringify({ left: pos.left, top: pos.top }), position_code: pos.code }).eq('id', p.id).then();
    });
    reloadList(table);
}
async function applyDynamicPlan(team) {
    if (!await canControlPlan(team)) return;
    alert("Dynamic plan logic applied (Simulated).");
}

function createPlayerMarker(team, name, id, pos, code, num) { 
  const m = document.createElement('div'); m.classList.add('player-marker'); m.id = `marker-${team}-${id}`; m.dataset.playerId = id; 
  m.style.background = team==='blue'? '#1976d2' : '#fbc02d'; m.style.left = pos.left; m.style.top = pos.top;
  
  const textColor = team === 'blue' ? '#fff' : '#000';
  const numBg = team === 'blue' ? 'rgba(0,0,0,0.5)' : 'rgba(255,255,255,0.8)';
  
  m.innerHTML = `
    <span class="player-position-label">${code || 'SUB'}</span>
    <div class="player-name" style="color:${textColor}; display:flex; align-items:center; gap:3px; justify-content:center;">
        <span style="background:${numBg}; padding:1px 4px; border-radius:4px; font-size:10px;">${num}</span>
        ${name}
    </div>
  `;
  m.addEventListener('click', (e) => { if (e.detail === 1) showPositionMenu(team, id, name); });
  document.getElementById(`${team}Plan`).appendChild(m);
}

async function showPositionMenu(team, id, name) {
    if (!await canControlPlan(team)) return;
    currentPositionTarget = { team, id, name }; document.getElementById('positionMenuTitle').innerText = `Pos: ${name}`;
    const g = document.getElementById('positionMenuGrid'); g.innerHTML = ''; 
    POSITIONS_LIST.forEach(p => { const b = document.createElement('button'); b.innerText = p.code; b.onclick = () => selectPosition(p.code); g.appendChild(b); });
    document.getElementById('positionMenuOverlay').style.display = 'flex';
}
function closePositionMenu() { document.getElementById('positionMenuOverlay').style.display = 'none'; }
async function selectPosition(code) {
    const { team, id } = currentPositionTarget; const table = `${team}_team`;
    await supabase.from(table).update({ position_code: code }).eq('id', id);
    closePositionMenu(); reloadList(table);
}

// CHAT & UTILS
function showToast(m) { const c=document.getElementById('toastContainer'); const t=document.createElement('div'); t.innerText=m; t.style.cssText='position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px;border-radius:20px;'; c.appendChild(t); setTimeout(()=>t.remove(),3000); }

async function loadMatchAddress() {
    const { data } = await supabase.from('app_config').select('match_address').eq('id', 1).single(); 
    matchAddress = data ? data.match_address : "Address üìç";
    document.getElementById('addressBtn').textContent = (matchAddress.length > 20 && !matchAddress.includes("set")) ? "Match Address üìç" : `${matchAddress} üìç`;
}
function playNotificationSound() { document.getElementById('notification-sound').play().catch(()=>{}); }

async function loadSystemHistory(toggle = true) {
  const historyContainer = document.getElementById('systemHistoryContainer');
  const historyList = document.getElementById('historyList');
  if (toggle) { historyContainer.style.display = historyContainer.style.display === 'block' ? 'none' : 'block'; }
  if (historyContainer.style.display === 'none') return;
  
  historyList.innerHTML = '<li style="text-align:center; color:#aaa;">Loading...</li>'; 

  const { data, error } = await supabase.from('system_history').select('*').order('created_at', { ascending: false }).limit(50);

  if (error || !data || data.length === 0) {
    historyList.innerHTML = '<li style="text-align:center; color:#aaa;">No recent events.</li>';
    return;
  }
  
  historyList.innerHTML = ''; 
  
  data.forEach(item => {
    const dateObj = new Date(item.created_at);
    const time = dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    
    let bgColor = '#424242'; 
    let textColor = '#fff';
    let icon = '';
    const contentLower = item.content.toLowerCase();

    if (contentLower.includes('joined')) {
        bgColor = '#2e7d32'; 
        icon = '‚úî';
    } else if (contentLower.includes('left')) {
        bgColor = '#c62828'; 
        icon = '‚úñ';
    } else if (contentLower.includes('moved') || contentLower.includes('waiting list')) {
        bgColor = '#f57f17'; 
        textColor = '#000';
        icon = '‚ö†';
    }

    historyList.innerHTML += `
      <li style="background-color: ${bgColor}; color: ${textColor}; padding: 10px 15px; border-radius: 15px; margin-bottom: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; flex-direction: column; align-items: flex-start; text-align: left; border: 1px solid rgba(255,255,255,0.1);">
        <div style="font-size: 14px; font-weight: bold; width:100%;"><span style="margin-right:5px;">${icon}</span> ${item.content}</div>
        <div style="font-size: 11px; opacity: 0.8; margin-top: 5px; align-self: flex-end;">${time}</div>
      </li>`;
  });
}

async function sendSystemMessageToChat(name, msg) { await supabase.from('system_history').insert([{ content: msg, username: 'System' }]); }

// FILE UPLOAD
async function handleFileUpload(input, context) {
    const file = input.files[0]; if (!file) return;
    const nameInputId = context === 'global' ? 'chatNameInput' : (context==='blue'?'blueChatNameInput':'yellowChatNameInput');
    const name = document.getElementById(nameInputId).value.trim();
    if (!name) return alert("Enter name");
    localStorage.setItem('chat_username', name);

    const ext = file.name.split('.').pop(); const fileName = `${Date.now()}.${ext}`;
    const { error } = await supabase.storage.from('chat_images').upload(fileName, file);
    if(error) return alert("Upload failed");
    const { data } = supabase.storage.from('chat_images').getPublicUrl(fileName);
    const content = ['mp4','webm'].includes(ext) ? `[VID]${data.publicUrl}` : `[IMG]${data.publicUrl}`;
    const table = context === 'global' ? 'chat_messages' : `${context}_chat`;
    await supabase.from(table).insert([{ username: name, content }]);
    input.value = '';
}

// --- NEW FEATURES LOGIC ---
function toggleRadio() { const e=document.getElementById('radioPlayerSection'); e.style.display = e.style.display==='block'?'none':'block'; }
function playRadio() { const a=document.getElementById('radioStreamPlayer'); const s=document.getElementById('radioSelect'); if(a.src!==s.value) a.src=s.value; a.play(); }
function stopRadio() { 
    document.getElementById('radioStreamPlayer').pause(); 
    document.getElementById('radioPlayerSection').style.display='none';
}
function changeRadioChannel() { playRadio(); document.getElementById('radioPlayerSection').style.display='none'; }

function toggleStickerMenu(context) {
    const id = context === 'global' ? 'stickerPopupGlobal' : (context === 'blue' ? 'stickerPopupBlue' : 'stickerPopupYellow');
    const el = document.getElementById(id);
    el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
    if(el.style.display === 'flex') showStickerTab(context, 'football');
}
function showStickerTab(context, category) {
    const gridId = context === 'global' ? 'stickerGridGlobal' : (context === 'blue' ? 'stickerGridBlue' : 'stickerGridYellow');
    const grid = document.getElementById(gridId);
    grid.innerHTML = '';
    STICKERS[category].forEach(url => {
        const img = document.createElement('img'); img.src = url; img.classList.add('sticker-item');
        img.onclick = () => sendSticker(context, url);
        grid.appendChild(img);
    });
}
async function sendSticker(context, url) {
    const nameInputId = context === 'global' ? 'chatNameInput' : (context==='blue'?'blueChatNameInput':'yellowChatNameInput');
    const name = document.getElementById(nameInputId).value.trim();
    if(!name) return alert("Enter name");
    localStorage.setItem('chat_username', name);
    const table = context === 'global' ? 'chat_messages' : `${context}_chat`;
    await supabase.from(table).insert([{ username: name, content: `[IMG]${url}` }]);
    toggleStickerMenu(context);
}

// --- NEW RECORDING LOGIC (Bar Style) ---
async function startVoiceRecording(context) {
    if (!navigator.mediaDevices) return alert("Microphone not supported");
    const nameInputId = context === 'global' ? 'chatNameInput' : (context==='blue'?'blueChatNameInput':'yellowChatNameInput');
    if (!document.getElementById(nameInputId).value.trim()) return alert("Enter name first");

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        
        // Show the specific recording bar
        const barId = context === 'global' ? 'recordingBar_global' : (context === 'blue' ? 'recordingBar_blue' : 'recordingBar_yellow');
        document.getElementById(barId).style.display = 'flex';
        
        isRecording = true;
        mediaRecorder.start();
    } catch (e) { console.error(e); alert("Mic access denied"); }
}

async function finishVoiceRecording(context, action) {
    if (!mediaRecorder || !isRecording) return;
    
    const barId = context === 'global' ? 'recordingBar_global' : (context === 'blue' ? 'recordingBar_blue' : 'recordingBar_yellow');
    
    mediaRecorder.onstop = async () => {
        document.getElementById(barId).style.display = 'none'; // Hide bar
        if (action === 'send') {
             const blob = new Blob(audioChunks, { type: 'audio/webm' });
             const file = new File([blob], `voice_${Date.now()}.webm`, { type: 'audio/webm' });
             const nameInputId = context === 'global' ? 'chatNameInput' : (context==='blue'?'blueChatNameInput':'yellowChatNameInput');
             const name = document.getElementById(nameInputId).value.trim();
             
             const fileName = `${Date.now()}.webm`;
             const { error } = await supabase.storage.from('chat_images').upload(fileName, file);
             if(error) return alert("Audio upload failed");
             const { data } = supabase.storage.from('chat_images').getPublicUrl(fileName);
             const table = context === 'global' ? 'chat_messages' : `${context}_chat`;
             await supabase.from(table).insert([{ username: name, content: `[AUDIO]${data.publicUrl}` }]);
        }
        // clear tracks
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
    };
    
    mediaRecorder.stop();
    isRecording = false;
}

// ---- CUSTOM AUDIO PLAYER LOGIC ----
function toggleCustomAudio(uniqueId) {
    const audio = document.getElementById(uniqueId);
    const btn = document.getElementById('btn-' + uniqueId);
    
    // Pause all other audios
    document.querySelectorAll('audio').forEach(a => {
        if (a.id !== uniqueId && !a.paused) {
            a.pause();
            // Reset their buttons if they are custom players
            if (a.id && a.id.startsWith('audio-')) {
                const otherBtn = document.getElementById('btn-' + a.id);
                if (otherBtn) otherBtn.innerText = '‚ñ∂';
            }
        }
    });

    if (audio.paused) {
        audio.play();
        btn.innerText = '‚è∏';
    } else {
        audio.pause();
        btn.innerText = '‚ñ∂';
    }
}

function updateAudioTime(uniqueId) {
    const audio = document.getElementById(uniqueId);
    const timeDisplay = document.getElementById('time-' + uniqueId);
    if (!audio || !timeDisplay) return;

    const current = formatTime(audio.currentTime);
    const duration = formatTime(audio.duration || 0);
    
    timeDisplay.innerText = `${current} / ${duration}`;
}

function resetAudio(uniqueId) {
    const btn = document.getElementById('btn-' + uniqueId);
    if (btn) btn.innerText = '‚ñ∂';
}

function formatTime(seconds) {
    if (isNaN(seconds)) return "0:00";
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);
    return `${m}:${s < 10 ? '0' : ''}${s}`;
}
// -----------------------------------

// RENDER MESSAGES (UPDATED WITH CUSTOM AUDIO)
function renderMessage(m, id) {
    const div = document.getElementById(id); const isMe = m.username === localStorage.getItem('chat_username');
    let c = m.content;
    
    if (c.startsWith('[IMG]')) {
        c = `<img src="${c.substring(5)}" class="chat-media-content" onclick="window.open(this.src)">`;
    } else if (c.startsWith('[VID]')) {
        c = `<video src="${c.substring(5)}" controls class="chat-media-content"></video>`;
    } else if (c.startsWith('[AUDIO]')) {
        // Generate a unique ID for this specific audio message
        const uniqueId = 'audio-' + Math.random().toString(36).substr(2, 9);
        const src = c.substring(7);
        
        c = `
        <div class="custom-audio-player">
            <button id="btn-${uniqueId}" class="audio-play-btn" onclick="toggleCustomAudio('${uniqueId}')">‚ñ∂</button>
            <span id="time-${uniqueId}" class="audio-time-display">0:00 / 0:00</span>
            <audio id="${uniqueId}" src="${src}" ontimeupdate="updateAudioTime('${uniqueId}')" onloadedmetadata="updateAudioTime('${uniqueId}')" onended="resetAudio('${uniqueId}')" style="display:none;"></audio>
        </div>`;
    }
    
    let delBtn = '';
    const table = id.includes('blue') ? 'blue_chat' : (id.includes('yellow') ? 'yellow_chat' : 'chat_messages');
    // Use '‚úï' instead of trash can
    if (isMe) delBtn = `<button class="delete-msg-btn" title="Delete" onclick="deleteSingleMessage('${table}', ${m.id})">‚úï</button>`;

    const timeSpan = new Date(m.created_at).toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12:true});

    div.innerHTML += `<div class="message ${isMe?'my-message':''}" style="border-color:${getColorForUsername(m.username)}">
        <div style="font-size:12px; color:${getColorForUsername(m.username)}; font-weight:bold;">${m.username} <span style="font-weight:normal; color:#888; font-size:10px;">${timeSpan}</span></div>
        <div>${c}</div>
        ${delBtn}
    </div>`;
    div.scrollTop = div.scrollHeight;
}

async function deleteSingleMessage(table, id) {
    if(!confirm("Delete?")) return;
    await supabase.from(table).delete().eq('id', id);
    reloadList(table);
}

async function loadChatMessages() { const { data } = await supabase.from('chat_messages').select('*').order('created_at', {ascending:true}).limit(50); document.getElementById('chatMessages').innerHTML=''; data.forEach(m=>renderMessage(m,'chatMessages')); }
async function loadTeamChatMessages(team) { 
    const { data } = await supabase.from(`${team}_chat`).select('*').order('created_at', {ascending:true}).limit(50); 
    document.getElementById(`${team}ChatMessages`).innerHTML=''; 
    data.forEach(m=>renderMessage(m,`${team}ChatMessages`)); 
}
async function sendMessage() {
    const n = document.getElementById('chatNameInput').value; const c = document.getElementById('chatMsgInput').value;
    if(!n || !c) return; localStorage.setItem('chat_username', n);
    await supabase.from('chat_messages').insert([{ username:n, content:c }]); document.getElementById('chatMsgInput').value='';
}
async function sendTeamMessage(team) {
    const n = document.getElementById(`${team}ChatNameInput`).value; const c = document.getElementById(`${team}ChatMsgInput`).value;
    if(!n || !c) return; localStorage.setItem('chat_username', n);
    await supabase.from(`${team}_chat`).insert([{ username:n, content:c }]); document.getElementById(`${team}ChatMsgInput`).value='';
}

// --- ARCADE LOGIC (Updated with 5 Games) ---
let gameInterval, gameActive = false, currentScore = 0, currentGameType = '';
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let ball = { x: 160, y: 200, r: 15, dy: 0, dx: 0, state: 'ready' };
let obstacles = []; let goalTarget = {}; let playerTargetX = 160;

// Mouse/Touch tracking for Dribbler & Keeper
canvas.addEventListener('mousemove', (e) => {
    if (!gameActive) return;
    const rect = canvas.getBoundingClientRect();
    playerTargetX = (e.clientX - rect.left) * (canvas.width / rect.width);
});
canvas.addEventListener('touchmove', (e) => {
    if (!gameActive) return;
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    playerTargetX = (e.touches[0].clientX - rect.left) * (canvas.width / rect.width);
}, {passive: false});

function openGameCenter() { document.getElementById('gameCenterOverlay').style.display = 'flex'; document.getElementById('gameMenu').style.display='block'; document.getElementById('gameArea').style.display='none'; }
function closeGameCenter() { exitGame(); document.getElementById('gameCenterOverlay').style.display = 'none'; }
function exitGame() { gameActive = false; cancelAnimationFrame(gameInterval); document.getElementById('gameArea').style.display = 'none'; document.getElementById('gameMenu').style.display = 'block'; }
async function loadLeaderboard(gid) {
    const list = document.getElementById('leaderboardList'); list.innerHTML='<li>Loading...</li>';
    const { data } = await supabase.from('game_scores').select('username,score').eq('game_name', gid).order('score',{ascending:false}).limit(10);
    list.innerHTML = data && data.length ? data.map((e,i)=>`<li>${i+1}. ${e.username}: ${e.score}</li>`).join('') : '<li>No scores</li>';
}

function startGame(type) { 
    currentGameType = type; document.getElementById('gameMenu').style.display='none'; document.getElementById('gameArea').style.display='block'; 
    currentScore=0; gameActive=false; document.getElementById('scoreDisplay').innerText="Score: 0";
    document.getElementById('startPrompt').style.display='block';
    
    // Reset Game States
    if(type==='juggling') ball = { x: 160, y: 200, r: 20, dy: 0, dx: 2 };
    if(type==='flappy') { ball = { x: 50, y: 200, r: 12, dy: 0, dx: 0 }; obstacles = []; }
    if(type==='penalty') { ball = { x: 160, y: 360, r: 15, state:'ready' }; goalTarget={x:50, w:80, spd:3, dir:1}; }
    if(type==='dribbler') { ball = { x: 160, y: 350, r: 15 }; obstacles = []; playerTargetX = 160; }
    if(type==='keeper') { ball = { x: 160, y: 340, r: 20 }; obstacles = []; playerTargetX = 160; } // obstacles = balls array here

    // Input Handler for Tap games
    canvas.onmousedown = canvas.ontouchstart = (e) => {
        e.preventDefault();
        if (!gameActive) { gameActive=true; document.getElementById('startPrompt').style.display='none'; gameLoop(); 
            if(type==='juggling'){ ball.dy=-10; ball.dx=(Math.random()-0.5)*4; }
            if(type==='flappy') ball.dy=-7;
            return; 
        }
        if(type==='juggling') { ball.dy = -10; ball.dx = (Math.random()-0.5)*5; currentScore++; }
        if(type==='flappy') ball.dy = -7;
        if(type==='penalty' && ball.state==='ready') ball.state='shooting';
    };
    drawGame();
}

function drawGame() { ctx.clearRect(0,0,320,400); } // Initial clear

function gameLoop() {
    if(!gameActive) return;
    ctx.clearRect(0,0,320,400);
    
    if (currentGameType === 'juggling') updateJuggling();
    else if (currentGameType === 'flappy') updateFlappy();
    else if (currentGameType === 'penalty') updatePenalty();
    else if (currentGameType === 'dribbler') updateDribbler();
    else if (currentGameType === 'keeper') updateKeeper();

    document.getElementById('scoreDisplay').innerText = `Score: ${currentScore}`;
    gameInterval = requestAnimationFrame(gameLoop);
}

async function gameOver() {
    gameActive = false; cancelAnimationFrame(gameInterval);
    const u = document.getElementById('chatNameInput').value || 'Guest';
    if(currentScore>0) await supabase.from('game_scores').insert([{game_name:currentGameType, username:u, score:currentScore}]);
    alert(`Game Over! Score: ${currentScore}`); exitGame(); loadLeaderboard(currentGameType);
}

// --- GAME LOGICS ---
function updateJuggling() {
    ball.dy += 0.5; ball.y += ball.dy; ball.x += ball.dx;
    if(ball.x+ball.r>320 || ball.x-ball.r<0) ball.dx = -ball.dx;
    if(ball.y+ball.r>400) gameOver();
    drawBall(ball.x, ball.y, ball.r, "#fff");
}
function updateFlappy() {
    ball.dy += 0.4; ball.y += ball.dy;
    if(Math.random()<0.02) obstacles.push({x:320, topH: Math.random()*200+50, passed:false});
    ctx.fillStyle="#4CAF50";
    obstacles.forEach(o => {
        o.x-=2; ctx.fillRect(o.x,0,40,o.topH); ctx.fillRect(o.x,o.topH+120,40,400);
        if(o.x+40<ball.x && !o.passed) { currentScore++; o.passed=true; }
        if(ball.x+12>o.x && ball.x-12<o.x+40 && (ball.y-12<o.topH || ball.y+12>o.topH+120)) gameOver();
    });
    if(ball.y>400 || ball.y<0) gameOver();
    drawBall(ball.x, ball.y, 12, "#FFD700");
}
function updatePenalty() {
    goalTarget.x += goalTarget.spd*goalTarget.dir;
    if(goalTarget.x+goalTarget.w>320 || goalTarget.x<0) goalTarget.dir *= -1;
    ctx.fillStyle="#333"; ctx.fillRect(0,0,320,100);
    ctx.fillStyle="#d32f2f"; ctx.fillRect(goalTarget.x,60,goalTarget.w,20);
    if(ball.state==='shooting') {
        ball.y-=15; ball.r-=0.2;
        if(ball.y<80) {
            if(ball.x>goalTarget.x && ball.x<goalTarget.x+goalTarget.w) { currentScore++; ball.state='ready'; ball.y=360; ball.r=15; goalTarget.spd+=0.5; }
            else gameOver();
        }
    }
    drawBall(ball.x, ball.y, ball.r, "#fff");
}
// NEW: DRIBBLER
function updateDribbler() {
    // Background field
    ctx.fillStyle="#388E3C"; ctx.fillRect(0,0,320,400); ctx.strokeStyle="rgba(255,255,255,0.2)"; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(0, (currentScore*10)%400); ctx.lineTo(320, (currentScore*10)%400); ctx.stroke(); // Moving line effect
    
    // Player movement
    ball.x += (playerTargetX - ball.x) * 0.1;
    
    // Spawn obstacles (Defenders/Cones)
    if(Math.random() < 0.03 + (currentScore*0.001)) {
        obstacles.push({x: Math.random() * 280 + 20, y: -20, type: Math.random()>0.5?'cone':'defender'});
    }
    
    obstacles.forEach((o, i) => {
        o.y += 4 + (currentScore * 0.1);
        // Draw Obstacle
        ctx.fillStyle = o.type==='cone' ? '#FF9800' : '#d32f2f';
        ctx.beginPath(); ctx.arc(o.x, o.y, 10, 0, Math.PI*2); ctx.fill();
        
        // Collision
        const dist = Math.hypot(ball.x - o.x, 350 - o.y);
        if(dist < 25) gameOver();
        
        // Score & Cleanup
        if(o.y > 420) { obstacles.splice(i, 1); currentScore++; }
    });
    
    drawBall(ball.x, 350, 15, "#fff"); // Player is white ball
}
// NEW: KEEPER
function updateKeeper() {
    // Background goal
    ctx.fillStyle="#444"; ctx.fillRect(0,360,320,40); // Ground
    ctx.strokeStyle="#fff"; ctx.lineWidth=5; ctx.strokeRect(20, 20, 280, 340); // Goal Frame
    
    // Gloves movement
    ball.x += (playerTargetX - ball.x) * 0.15;
    
    // Spawn Balls
    if(Math.random() < 0.02 + (currentScore*0.002)) {
        obstacles.push({x: Math.random() * 260 + 30, y: -20, caught: false}); // obstacles = balls
    }
    
    obstacles.forEach((b, i) => {
        b.y += 5 + (currentScore * 0.1);
        drawBall(b.x, b.y, 12, "#fff"); // Incoming ball
        
        // Catch collision
        const dist = Math.hypot(ball.x - b.x, 340 - b.y);
        if(dist < 30 && !b.caught) {
            b.caught = true; currentScore++; obstacles.splice(i, 1);
        }
        
        // Missed ball
        if(b.y > 400) gameOver();
    });
    
    // Draw Gloves
    ctx.fillStyle="#FFEB3B"; 
    ctx.fillRect(ball.x-20, 330, 40, 20); 
}

function drawBall(x,y,r,c){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle=c; ctx.fill(); ctx.stroke(); }

// TEAM ADD MODAL LOGIC
function openTeamAddModal() { document.getElementById('teamAddModalOverlay').style.display = 'flex'; document.getElementById('chatTeamAddInput').value = document.getElementById('chatNameInput').value; }
function closeTeamAddModal() { document.getElementById('teamAddModalOverlay').style.display = 'none'; }
function confirmAddToTeam(t) { const n = document.getElementById('chatTeamAddInput').value; if(t==='blue') addBlue(n); else addYellow(n); }

// INIT
function setupRealtime() {
  supabase.channel('global-chat-updates')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' }, (payload) => { renderMessage(payload.new, 'chatMessages'); })
    .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'chat_messages' }, () => { loadChatMessages(); })
    .subscribe();
    
  supabase.channel('system-history-updates')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'system_history' }, () => { 
        const hc = document.getElementById('systemHistoryContainer');
        if (hc.style.display === 'block') loadSystemHistory(false); 
    }).subscribe();

  supabase.channel('blue-chat-updates')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'blue_chat' }, (payload) => { 
        if(document.getElementById('blue').style.display === 'block') renderMessage(payload.new, 'blueChatMessages'); 
    }).subscribe();

  supabase.channel('yellow-chat-updates')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'yellow_chat' }, (payload) => { 
        if(document.getElementById('yellow').style.display === 'block') renderMessage(payload.new, 'yellowChatMessages'); 
    }).subscribe();
    
  supabase.channel('teams-updates')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'main_team' }, () => loadPlayers())
    .on('postgres_changes', { event: '*', schema: 'public', table: 'waiting_list' }, () => loadPlayers())
    .on('postgres_changes', { event: '*', schema: 'public', table: 'blue_team' }, () => loadBlue())
    .on('postgres_changes', { event: '*', schema: 'public', table: 'yellow_team' }, () => loadYellow())
    .subscribe();
}

(async function init() {
    const storedUsername = localStorage.getItem('chat_username');
    if (storedUsername) {
        document.getElementById('chatNameInput').value = storedUsername;
        document.getElementById('blueChatNameInput').value = storedUsername;
        document.getElementById('yellowChatNameInput').value = storedUsername;
    }

    // RE-ADDED ENTER KEY SUPPORT
    document.getElementById('chatMsgInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { sendMessage(); } });
    document.getElementById('blueChatMsgInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { sendTeamMessage('blue'); } });
    document.getElementById('yellowChatMsgInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { sendTeamMessage('yellow'); } });

    await loadSystemConfig(); loadMatchAddress(); loadPlayers(); loadBlue(); loadYellow(); loadChatMessages();
    setupRealtime();
})();
</script>
</body>
</html>
