<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Eternal Brothers FC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* -------------------- 1. GENERAL & BODY STYLES -------------------- */
body {
  font-family: "Cairo", sans-serif;
  background-color: #121212;
  color: #e0e0e0;
  margin:0;
  padding:10px;
  text-align:center;
}
.container {
  display:none;
  max-width:95%;
  margin:auto;
  background:#1e1e1ecc;
  padding:20px 10px;
  border-radius:15px;
  box-shadow:0 0 10px #000;
}
h1,h2,h3 { margin:10px 0; }
input[type=text] { 
    padding:8px; 
    width:80%; 
    border-radius:8px; 
    border:1px solid #555; 
    margin:5px 0; 
    background:#2c2c2c; 
    color:#fff; 
    text-align:center; 
}
button {
  padding:10px 16px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}
.formation-controls button {
    margin: 5px 3px;
    background: #009688; 
    color: #fff;
    padding: 8px 12px;
    font-size: 14px;
}
.formation-controls .dynamic-btn {
    background: #FF9800; 
    font-weight: 700;
}

/* -------------------- 2. NAV CONTROLS (UPDATED) -------------------- */
.nav-controls {
  margin-bottom: 20px;
  display: flex;
  flex-direction: column; 
  align-items: center; 
}
.nav-buttons-top {
  display: flex;
  flex-direction: row; 
  justify-content: space-between;
  width: 100%; 
  max-width: 400px; 
  margin-bottom: 5px; 
}
.nav-buttons-bottom {
  display: flex;
  justify-content: space-between; 
  width: 100%;
  max-width: 400px;
}
#homeBtn, #blueBtn, #yellowBtn, #addressBtn { /* Added #addressBtn */
    width: 100%; 
    margin: 0 5px; 
    font-size: 14px; 
}
#homeBtn { background:#d32f2f; color:#fff; }
#blueBtn { background:#1976d2; color:#fff; }
#yellowBtn { background:#fbc02d; color:#000; }
#addressBtn { 
    background:#9c27b0; 
    color:#fff; 
    font-size: 14px; 
    margin-right: 5px; /* Ensures consistent margin with the group */
    /* NEW: Adjusted to show address summary */
    white-space: nowrap; 
    overflow: hidden;
    text-overflow: ellipsis;
    display: block; 
    max-width: 160px;
}

/* New Settings/Audio Button Style Group */
.settings-audio-group {
    display: flex;
    gap: 5px; 
    /* The group width is calculated to occupy roughly the space of two buttons, 
       maintaining symmetry with the address button. */
    width: calc(66.66% - 5px); /* Adjusted for better visual balance */
    justify-content: center;
}
/* Ensure these buttons are smaller and fit into the new layout */
#audioToggleBtn, #settingsBtn { 
  background: #616161 !important;
  color: #fff !important;
  font-size: 14px; /* Smaller font for a smaller look */
  padding: 8px 5px !important; /* Smaller padding */
  width: 50% !important; /* Half of the settings-audio-group */
  margin: 0 !important; 
  border-radius: 8px; 
  box-sizing: border-box; 
}
#settingsBtn {
  background: #795548 !important;
}

/* -------------------- 3. LISTS & PLAYER INFO -------------------- */
ul { 
    list-style:none; 
    padding:0; 
    margin-top:10px; 
    text-align:left; 
    font-weight:bold; 
}
li { 
    margin:5px 0; 
    padding:6px; 
    border-radius:8px; 
    display:flex; 
    justify-content:space-between; 
    align-items:center;
    flex-direction: row; 
    min-height: 40px; 
}
#teamList li { background:#a8e6a1; color:black; }
#waitingList li { background:#ffe0e0; color:black; }
#blueList li { background:rgba(25,118,210,0.7); color:white; }
#yellowList li { background:rgba(251,192,42,0.7); color:#000; }

.player-info {
    display: flex;
    flex-direction: row; 
    align-items: center; 
    font-size: 16px;
    font-weight: bold;
}
.player-time {
    font-size: 12px;
    font-weight: normal;
    color: #616161; 
    margin-left: 5px; 
}

.action-btn {
  margin-left:6px;
  border:none;
  border-radius:5px;
  padding:4px 8px;
  cursor:pointer;
  font-weight:bold;
}
.edit-btn { background:#4caf50; color:#fff; }
.delete-btn { background:#e53935; color:#fff; }

/* -------------------- 4. FIELD & MARKER STYLES -------------------- */
.field { width:100%; max-width:400px; height:250px; background:#4CAF50; margin:10px auto; border:2px solid #fff; border-radius:10px; position:relative; touch-action:none; }
.field .center-circle { position:absolute; width:50px;height:50px;border-radius:50%;border:2px solid #fff; top:50%; left:50%; transform:translate(-50%,-50%); }
.field .penalty-box-left, .field .penalty-box-right { position:absolute;width:60px;height:120px;border:2px solid #fff; top:50%; transform:translateY(-50%); }
.field .penalty-box-left { left:0; }
.field .penalty-box-right { right:0; }
.field .mid-line { position:absolute; width:0;height:100%;border-left:2px solid #fff; top:0; left:50%; transform:translateX(-50%); }

.player-marker { 
  width:35px; 
  height:35px; 
  border-radius:50%; 
  color:#fff; 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  font-size:14px; 
  font-weight:bold; 
  position:absolute; 
  cursor:pointer; 
  user-select:none; 
  border: 2px solid rgba(255, 255, 255, 0.5); 
  touch-action: none; 
  transform: translate(-50%, -50%); 
}
.player-name {
  position: absolute;
  top: -18px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 12px;
  color: black;
  white-space: nowrap;
  font-weight: bold;
}
.player-position-label {
    font-size: 14px;
    font-weight: bold;
    color: white;
}

/* -------------------- 5. CHAT STYLES -------------------- */
.chat-container {
  width: 100%; 
  max-width: 100%; 
  margin: 20px 0 0 0;
  background: #242424;
  border-radius: 10px;
  padding: 10px;
  box-shadow: 0 0 5px #000;
  text-align: left; 
}
.team-chat-container {
  background: none;
  box-shadow: none;
  margin: 5px 0 0 0;
  padding: 0;
}
.chat-messages {
  height: 250px;
  overflow-y: auto;
  margin-bottom: 10px;
  padding: 5px;
  background: #1e1e1e;
  border-radius: 5px;
  display: flex;
  flex-direction: column;
  text-align: left; 
}
#blueChatMessages { background: rgba(25, 118, 210, 0.1); }
#yellowChatMessages { background: rgba(251, 192, 42, 0.1); }
.message {
  margin-bottom: 8px;
  padding: 8px;
  border-radius: 10px;
  background: #333; 
  word-wrap: break-word;
  max-width: 90%;
  align-self: flex-start;
  font-size: 14px;
  line-height: 1.4;
  text-align: left; 
  border: 1px solid transparent; 
  color: #e0e0e0;
  position: relative; 
}
.my-message {
  background: #d32f2f;
  color: #fff;
  align-self: flex-end;
  text-align: left; 
  border: 1px solid #d32f2f; 
}
.delete-msg-btn {
    background: transparent !important;
    border: none;
    color: #ffeb3b; 
    cursor: pointer;
    font-size: 14px;
    margin-left: 8px;
    padding: 0 5px;
    line-height: 1;
}
.delete-msg-btn:hover {
    color: #fff;
    background-color: rgba(0,0,0,0.2) !important;
    border-radius: 50%;
}

.chat-input-group {
  display: flex;
  gap: 5px;
  align-items: center;
}
#chatNameInput, .team-chat-input-group input[type=text]:first-child {
  width: 25%;
  text-align: center; 
  order: 1; 
}
#chatMsgInput, .team-chat-input-group input[type=text]:nth-child(2) {
  flex-grow: 1;
  text-align: left; 
  order: 2;
}
.img-upload-btn {
  background: #555 !important;
  color: #fff !important;
  padding: 8px 12px !important;
  order: 3;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
#sendChatBtn, .team-chat-input-group button[id^="send"] {
  background: #d32f2f;
  color: #fff;
  padding: 8px 15px;
  order: 4; 
}
.chat-uploaded-img {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 5px;
    display: block;
    cursor: pointer;
    border: 1px solid #555;
}

/* -------------------- 6. POSITION MENU MODAL STYLES -------------------- */
.position-menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
.position-menu-box {
    background-color: #2c2c2c;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    width: 90%;
    max-width: 350px;
    text-align: center;
}
.position-menu-box h3 {
    margin-top: 0;
    color: #fff;
    font-size: 18px;
}
.position-menu-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 15px;
}
.position-menu-grid button {
    padding: 12px 5px;
    font-size: 14px;
    background-color: #444;
    color: #fff;
    border-radius: 6px;
    transition: background-color 0.2s;
}
.position-menu-grid button:hover {
    background-color: #d32f2f;
}

/* -------------------- 7. SETTINGS MODAL STYLES -------------------- */
.settings-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    display: none; 
    justify-content: center;
    align-items: center;
    z-index: 2000;
    padding: 10px;
}
.settings-modal-content {
    background-color: #1e1e1e;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.8);
    width: 95%;
    max-width: 450px;
    text-align: left;
    color: #fff;
    display: flex;
    flex-direction: column;
    max-height: 90vh; 
}
.settings-modal-content h2 {
    text-align: center;
    color: #d32f2f;
    margin-bottom: 20px;
    flex-shrink: 0; 
}
.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #333;
}
.setting-item:last-child {
    border-bottom: none;
}
.setting-item label {
    font-weight: 600;
    font-size: 15px;
}
.setting-item input[type="checkbox"] {
    transform: scale(1.5);
    cursor: pointer;
}
.password-input-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
}
.password-input-group input[type="password"] {
    width: 70%;
    text-align: center;
    font-size: 16px;
}
.settings-options-container {
    overflow-y: auto; 
    padding: 10px;
    border: 1px solid #333;
    border-radius: 8px;
    margin-bottom: 15px;
    flex-grow: 1; 
}
.settings-footer {
    text-align: center;
    margin-top: 0; 
    flex-shrink: 0; 
    padding-top: 15px; 
    border-top: 1px solid #333;
}
#saveSettingsBtn {
    background: #1976d2;
    color: #fff;
    width: 100%;
    padding: 12px;
}

.danger-zone {
    margin-top: 20px;
    padding-top: 10px;
    border-top: 1px solid #555;
}
.danger-zone h2 {
    color: #ffeb3b; 
    text-align: center;
    font-size: 18px;
}
.danger-btn {
    background-color: #d32f2f; 
    color: #fff;
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    font-size: 14px;
}
.danger-btn:hover {
    background-color: #e57373;
}

/* NEW ADDRESS INPUT STYLE */
#matchAddressInput {
    width: 100%;
    text-align: left;
    margin-top: 5px;
    margin-bottom: 15px;
}
</style>
</head>
<body>

<audio id="musicPlayer" loop preload="auto">
    <source src="https://raw.githubusercontent.com/ahmadalshaear/eternal-brothers-audio/main/Eternal_Brothers%20_FC_new.mp3" type="audio/mp3">
</audio>
<audio id="notification-sound" preload="auto">
    <source src="https://www.soundjay.com/button/button-3.mp3" type="audio/mp3">
</audio>

<div id="toastContainer"></div> 

<div class="nav-controls">
  <div class="nav-buttons-top">
    <button id="blueBtn" onclick="showSection('blue')">Blue Team</button>
    <button id="homeBtn" onclick="showSection('main')">Home</button>
    <button id="yellowBtn" onclick="showSection('yellow')">Yellow Team</button>
  </div>
  <div class="nav-buttons-bottom">
    <button id="addressBtn" onclick="openGoogleMaps()">Address üìç</button> 
    <div class="settings-audio-group">
        <button id="audioToggleBtn" onclick="toggleBackgroundMusic()">
            Audio</button>
        <button id="settingsBtn" onclick="showSettingsModal()">
            ‚öô</button> 
    </div>
  </div>
</div>
<div id="main" class="container">
  <h1 style="margin-top:0; font-size:28px; display:flex; align-items:center; justify-content:center; gap:8px;">
    ‚öΩ <span style="color:#1976d2;">Eternal</span> <span style="color:#fbc02d;">Brothers</span> ‚öΩ
  </h1>

  <p style="margin:5px 0; font-weight:bold; color:#fb8c00; font-size:16px;">
    The game will be at 9:40 AM
  </p>

  <div id="playerManagement">
    <h2>Add Player</h2>
    <input type="text" id="nameInput" placeholder="Enter player name">
    <button id="addPlayerBtn" onclick="addPlayer()">Add</button>
  </div>

  <h2>Main Team (24 max)</h2>
  <ul id="teamList"></ul>

  <h2>Waiting List</h2>
  <ul id="waitingList"></ul>
  
  <button onclick="loadSystemHistory()" style="background:#6a1b9a; color:#fff; margin-top:15px; width:80%;">Show Join/Leave History</button>
  <div id="systemHistoryContainer" style="margin-top:10px; padding:10px; background:#2c2c2c; border-radius:8px; max-width: 400px; margin-left: auto; margin-right: auto; text-align:left; display:none;">
      <h3 style="margin-top:0;">Event History</h3>
      <ul id="historyList" style="text-align:left; font-weight:normal; font-size:14px; color:#ccc;">
      </ul>
  </div>

  <p style="margin-top:15px; font-size:12px; color:#ccc;">
    We might need to change the football field at any time. Please follow the group chat in case of any changes
  </p>
  
  <div class="chat-container">
    <h2>Group Chat</h2>
    <div id="chatMessages" class="chat-messages">
      </div>
    <div class="chat-input-group">
      <input type="text" id="chatNameInput" placeholder="Your name" value="" style="text-align: center;">
      <input type="text" id="chatMsgInput" placeholder="Type a message...">
      
      <input type="file" id="globalChatFile" accept="image/*" style="display:none" onchange="handleImageUpload(this, 'global')">
      <button class="img-upload-btn" onclick="document.getElementById('globalChatFile').click()">üì∑</button>
      
      <button id="sendChatBtn" onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<div id="blue" class="container" style="background:#1565c0aa;">
  <h2>Blue Team</h2>
  <div id="bluePlayerManagement">
    <input type="text" id="blueInput" placeholder="Enter player name">
    <button id="addBlueBtn" onclick="addBlue()">Add</button>
  </div>
  <ul id="blueList"></ul>
  
  <div class="formation-controls">
    <button class="formation-btn" onclick="applyFormation('blue', '4-3-3')">4-3-3</button>
    <button class="formation-btn" onclick="applyFormation('blue', '4-4-2')">4-4-2</button>
    <button class="formation-btn" onclick="applyFormation('blue', '3-4-3')">3-4-3</button>
    <button id="blueDynamicBtn" class="dynamic-btn" onclick="applyDynamicPlan('blue')">Apply Dynamic Plan</button>
  </div>
  
  <h3>Plan</h3>
  <div id="bluePlan" class="field">
    <div class="mid-line"></div>
    <div class="center-circle"></div>
    <div class="penalty-box-left"></div>
    <div class="penalty-box-right"></div>
  </div>

  <div class="chat-container team-chat-container">
    <h3>Blue Team Chat üó©</h3>
    <div id="blueChatMessages" class="chat-messages"></div>
    <div class="chat-input-group team-chat-input-group">
      <input type="text" id="blueChatNameInput" placeholder="Your name" value="">
      <input type="text" id="blueChatMsgInput" placeholder="Message to Blue Team...">
      
      <input type="file" id="blueChatFile" accept="image/*" style="display:none" onchange="handleImageUpload(this, 'blue')">
      <button class="img-upload-btn" onclick="document.getElementById('blueChatFile').click()">üì∑</button>
      
      <button id="sendBlueChatBtn" onclick="sendTeamMessage('blue')">Send</button>
    </div>
  </div>
</div>

<div id="yellow" class="container" style="background:#fdd835aa; color:#000;">
  <h2>Yellow Team</h2>
  <div id="yellowPlayerManagement">
    <input type="text" id="yellowInput" placeholder="Enter player name">
    <button id="addYellowBtn" onclick="addYellow()">Add</button>
  </div>
  <ul id="yellowList"></ul>
  
  <div class="formation-controls">
    <button class="formation-btn" onclick="applyFormation('yellow', '4-3-3')">4-3-3</button>
    <button class="formation-btn" onclick="applyFormation('yellow', '4-4-2')">4-4-2</button>
    <button class="formation-btn" onclick="applyFormation('yellow', '3-4-3')">3-4-3</button>
    <button id="yellowDynamicBtn" class="dynamic-btn" onclick="applyDynamicPlan('yellow')">Apply Dynamic Plan</button>
  </div>
  
  <h3>Plan</h3>
  <div id="yellowPlan" class="field">
    <div class="mid-line"></div>
    <div class="center-circle"></div>
    <div class="penalty-box-left"></div>
    <div class="penalty-box-right"></div>
  </div>

  <div class="chat-container team-chat-container">
    <h3 style="color: #000;">Yellow Team Chat üó©</h3>
    <div id="yellowChatMessages" class="chat-messages"></div>
    <div class="chat-input-group team-chat-input-group">
      <input type="text" id="yellowChatNameInput" placeholder="Your name" value="">
      <input type="text" id="yellowChatMsgInput" placeholder="Message to Yellow Team...">
      
      <input type="file" id="yellowChatFile" accept="image/*" style="display:none" onchange="handleImageUpload(this, 'yellow')">
      <button class="img-upload-btn" onclick="document.getElementById('yellowChatFile').click()">üì∑</button>
      
      <button id="sendYellowChatBtn" onclick="sendTeamMessage('yellow')">Send</button>
    </div>
  </div>
</div>

<div id="positionMenuOverlay" class="position-menu-overlay" style="display:none;">
    <div class="position-menu-box">
        <h3 id="positionMenuTitle">Select Position for Player Name</h3>
        <div id="positionMenuGrid" class="position-menu-grid">
            </div>
        <button onclick="closePositionMenu()" style="margin-top: 15px; background: #555;">Cancel</button>
    </div>
</div>

<div id="settingsModalOverlay" class="settings-modal-overlay">
    <div class="settings-modal-content">
        <div id="passwordSection">
            <h2>Admin Settings</h2>
            <div class="password-input-group">
                <input type="password" id="settingsPassword" placeholder="Password">
                <button onclick="authenticateSettings()" style="background: #d32f2f; color: #fff; width: 70%;">Enter</button>
                <p id="passwordError" style="color: #ffeb3b; display: none; margin: 5px 0;">Incorrect password.</p>
            </div>
        </div>

        <div id="settingsControls" style="display:none; flex-grow: 1; display: flex; flex-direction: column; min-height: 0;">
            
            <div class="settings-options-container">
                <h2>Match Details</h2>
                <label for="matchAddressInput" style="font-weight: bold; display: block; margin-bottom: 5px;">Match Address (Google Maps)</label>
                <input type="text" id="matchAddressInput" placeholder="Enter full match address or coordinates">
                <h2>System Options</h2>
                <div class="setting-item">
                    <label for="allowPlayerEdit">Allow Player Add/Edit/Delete (Main Lists)</label>
                    <input type="checkbox" id="allowPlayerEdit">
                </div>
                <div class="setting-item">
                    <label for="allowTeamEdit">Allow Player Add/Edit/Delete (Teams)</label>
                    <input type="checkbox" id="allowTeamEdit">
                </div>
                <div class="setting-item">
                    <label for="allowFormationEdit">Allow Applying Formations (Plan)</label>
                    <input type="checkbox" id="allowFormationEdit">
                </div>
                <div class="setting-item">
                    <label for="allowAddressEdit">Allow Editing Match Address</label>
                    <input type="checkbox" id="allowAddressEdit">
                </div>
                <div class="setting-item">
                    <label for="allowChat">Allow Sending Chat Messages</label>
                    <input type="checkbox" id="allowChat">
                </div>
                <div class="setting-item">
                    <label for="allowImageUpload">Allow Image Uploads in Chat</label>
                    <input type="checkbox" id="allowImageUpload">
                </div>
                <div class="setting-item">
                    <label for="allowMusic">Allow Toggling Music</label>
                    <input type="checkbox" id="allowMusic">
                </div>
                <div class="setting-item">
                    <label for="enforceTimeRestriction">Enforce Time Restriction (Wed-Sun)</label>
                    <input type="checkbox" id="enforceTimeRestriction">
                </div>
                <div class="setting-item">
                    <label for="requireIndividualPin">Require Individual Player PIN (Main List)</label>
                    <input type="checkbox" id="requireIndividualPin">
                </div>
                <div class="setting-item">
                    <label for="requireTeamPinForAdd">Require Team PIN for Main List</label>
                    <input type="checkbox" id="requireTeamPinForAdd">
                </div>
                
                <div class="danger-zone">
                    <h2>Danger Zone - Data Deletion</h2>
                    <button class="danger-btn" onclick="clearGroupChat()">Clear Group Chat (Player Msgs)</button>
                    <button class="danger-btn" onclick="clearSystemHistory()">Clear System History (Alerts)</button>
                    <button class="danger-btn" onclick="clearBlueChat()">Clear Blue Team Chat</button>
                    <button class="danger-btn" onclick="clearYellowChat()">Clear Yellow Team Chat</button>
                    <button class="danger-btn" onclick="clearMainTeam()">Clear Main Team List</button>
                    <button class="danger-btn" onclick="clearWaitingList()">Clear Waiting List</button>
                    <button class="danger-btn" onclick="clearBlueTeam()">Clear Blue Team List</button>
                    <button class="danger-btn" onclick="clearYellowTeam()">Clear Yellow Team List</button>
                </div>
            </div> 

            <div class="settings-footer">
                <button id="saveSettingsBtn" onclick="saveSettings()">Save & Close</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script> 

<script>
// =========================================================================================
// ---- 1. GENERAL CONFIGURATION & DATA STRUCTURES ----
// =========================================================================================

// Supabase Configuration
const supabaseUrl = "https://wihhlvgkjglphjzhivdn.supabase.co"; 
const supabaseServiceKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndpaGhsdmdramdscGhqemhpdmRuIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Mjk0MzA5NiwiZXhwIjoyMDc4NTE5MDk2fQ.qVT2CKqMKRW1Y1qEox9_cl4JvuLY659_UQxVDMBWBFA"; 
const supabase = window.supabase.createClient(supabaseUrl, supabaseServiceKey);

// Global state variables
let currentPositionTarget = { team: null, playerId: null, playerName: null };
const nameColors = ["#e53935", "#1e88e5", "#fbc02d","#43a047","#8e24aa","#fb8c00","#00acc1","#d81b60","#6d4c41","#3949ab","#f4511e","#7cb342"];
let audioInitialized = false; 
let matchAddress = "Address üìç"; // NEW: Default Address text for the button

// Admin PINs
const ADMIN_PASSWORD = "2023"; 
const TEAM_ADD_PIN = "1111"; 

// System Configuration State
let systemConfig = {
    allowPlayerEdit: true, 
    allowTeamEdit: true, 
    allowFormationEdit: true, 
    allowAddressEdit: true, 
    allowChat: true, 
    allowImageUpload: true, 
    allowMusic: true, 
    enforceTimeRestriction: true, 
    requireIndividualPin: true, 
    requireTeamPinForAdd: false, 
};

// List of available positions
const POSITIONS_LIST = [
    { code: 'GK', label: 'Goalkeeper' },
    { code: 'CB', label: 'Center Back' },
    { code: 'RB', label: 'Right Back' },
    { code: 'LB', label: 'Left Back' },
    { code: 'DM', label: 'Defensive Midfielder' }, 
    { code: 'CM', label: 'Center Midfield' },
    { code: 'RM', label: 'Right Midfield' },
    { code: 'LM', label: 'Left Midfield' },
    { code: 'CAM', label: 'Attacking Mid' },
    { code: 'CF', label: 'Center Forward' }, 
    { code: 'RW', label: 'Right Winger' }, 
    { code: 'LW', label: 'Left Winger' }, 
    { code: 'ST', label: 'Striker' }, 
    { code: 'SUB', label: 'Substitute' }
];

// Formation Definitions
const FORMATIONS = {
    '4-3-3': [
        { left: '5%', top: '50%', code: 'GK' },  
        { left: '20%', top: '25%', code: 'LB' }, 
        { left: '20%', top: '40%', code: 'CB' }, 
        { left: '20%', top: '60%', code: 'CB' }, 
        { left: '20%', top: '75%', code: 'RB' }, 
        { left: '50%', top: '35%', code: 'CM' }, 
        { left: '50%', top: '50%', code: 'DM' }, 
        { left: '50%', top: '65%', code: 'CM' }, 
        { left: '80%', top: '25%', code: 'LW' }, 
        { left: '80%', top: '50%', code: 'CF' }, 
        { left: '80%', top: '75%', code: 'RW' }, 
        { left: '40%', top: '5%', code: 'SUB' },
    ],
    '4-4-2': [
        { left: '5%', top: '50%', code: 'GK' },  
        { left: '25%', top: '10%', code: 'LB' }, 
        { left: '25%', top: '35%', code: 'CB' }, 
        { left: '25%', top: '65%', code: 'CB' }, 
        { left: '25%', top: '90%', code: 'RB' }, 
        { left: '55%', top: '10%', code: 'LM' }, 
        { left: '55%', top: '35%', code: 'DM' }, 
        { left: '55%', top: '65%', code: 'CM' }, 
        { left: '55%', top: '90%', code: 'RM' }, 
        { left: '80%', top: '35%', code: 'CF' }, 
        { left: '80%', top: '65%', code: 'ST' }, 
        { left: '40%', top: '5%', code: 'SUB' }, 
    ],
    '3-4-3': [
        { left: '5%', top: '50%', code: 'GK' },  
        { left: '20%', top: '20%', code: 'CB' }, 
        { left: '20%', top: '50%', code: 'CB' }, 
        { left: '20%', top: '80%', code: 'CB' }, 
        { left: '45%', top: '10%', code: 'LM' }, 
        { left: '45%', top: '35%', code: 'DM' }, 
        { left: '45%', top: '65%', code: 'CM' }, 
        { left: '45%', top: '90%', code: 'RM' }, 
        { left: '75%', top: '25%', code: 'LW' }, 
        { left: '75%', top: '50%', code: 'CF' }, 
        { left: '75%', top: '75%', code: 'RW' }, 
        { left: '10%', top: '95%', code: 'SUB' }, 
    ]
};

function stringToHash(str) {
  let hash = 0;
  if (str.length === 0) return hash;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash |= 0; 
  }
  return Math.abs(hash);
}

function getColorForUsername(username) {
    const hash = stringToHash(username.trim().toUpperCase());
    const index = hash % nameColors.length;
    return nameColors[index];
}

// =========================================================================================
// ---- 2. UI & AUDIO CONTROL (UPDATED) ----
// =========================================================================================

function showSection(id){
  document.querySelectorAll('.container').forEach(c=>c.style.display='none');
  document.getElementById(id).style.display='block';
  applyUIRestrictions();

  if (id === 'blue') {
    loadTeamChatMessages('blue');
    document.getElementById('blueChatNameInput').value = localStorage.getItem('chat_username') || '';
    setupDraggable('blue'); 
  } else if (id === 'yellow') {
    loadTeamChatMessages('yellow');
    document.getElementById('yellowChatNameInput').value = localStorage.getItem('chat_username') || '';
    setupDraggable('yellow'); 
  } else if (id === 'main') {
    loadChatMessages();
  }
}
showSection('main'); 

function toggleBackgroundMusic() {
    if (!systemConfig.allowMusic) {
        alert("Audio control is currently disabled by the system administrator.");
        return;
    }
    const audio = document.getElementById('musicPlayer');
    const toggleBtn = document.getElementById('audioToggleBtn');
    
    if (audio.paused) {
        audio.play().then(() => {
            toggleBtn.innerHTML = 'Stop Audio'; 
        }).catch(e => {
            console.error("Autoplay failed for music player:", e);
        });
    } else {
        audio.pause();
        toggleBtn.innerHTML = 'Audio'; 
    }
}

// UPDATED FUNCTION: Open Google Maps with the saved address
async function openGoogleMaps() {
    const { data } = await supabase.from('app_config').select('match_address').eq('id', 1).single(); 
    const savedAddress = data ? data.match_address : null;

    if (!savedAddress || savedAddress.trim() === '' || savedAddress.includes("set match address")) {
        alert("ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿπŸäŸäŸÜ ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖÿ®ÿßÿ±ÿßÿ© ÿ®ÿπÿØ. Ÿäÿ±ÿ¨Ÿâ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿπŸÜŸàÿßŸÜ ŸÅŸä ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™.");
        return;
    }
    
    // Encode the address for the URL
    // Fix: Use the correct Google Maps URL format
    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(savedAddress)}`;
    window.open(mapUrl, '_blank');
}

// =========================================================================================
// ---- 3. SYSTEM SETTINGS & PIN CHECKS (MODIFIED) ----
// =========================================================================================

async function showSettingsModal() {
    document.getElementById('settingsPassword').value = '';
    document.getElementById('passwordError').style.display = 'none';
    document.getElementById('passwordSection').style.display = 'block';
    document.getElementById('settingsControls').style.display = 'none'; 
    document.getElementById('settingsModalOverlay').style.display = 'flex';
    
    // NEW: Load current match address into the settings field
    const { data } = await supabase.from('app_config').select('match_address').eq('id', 1).single(); 
    document.getElementById('matchAddressInput').value = data ? data.match_address : '';
}

function authenticateSettings() {
    const passwordInput = document.getElementById('settingsPassword').value;
    const errorElement = document.getElementById('passwordError');
    
    if (passwordInput === ADMIN_PASSWORD) {
        errorElement.style.display = 'none';
        document.getElementById('passwordSection').style.display = 'none';
        document.getElementById('settingsControls').style.display = 'flex'; 
        
        document.getElementById('allowPlayerEdit').checked = systemConfig.allowPlayerEdit;
        document.getElementById('allowTeamEdit').checked = systemConfig.allowTeamEdit;
        document.getElementById('allowFormationEdit').checked = systemConfig.allowFormationEdit;
        document.getElementById('allowAddressEdit').checked = systemConfig.allowAddressEdit;
        document.getElementById('allowChat').checked = systemConfig.allowChat;
        document.getElementById('allowImageUpload').checked = systemConfig.allowImageUpload; 
        document.getElementById('allowMusic').checked = systemConfig.allowMusic;
        document.getElementById('enforceTimeRestriction').checked = systemConfig.enforceTimeRestriction;
        document.getElementById('requireIndividualPin').checked = systemConfig.requireIndividualPin;
        document.getElementById('requireTeamPinForAdd').checked = systemConfig.requireTeamPinForAdd;

    } else {
        errorElement.style.display = 'block';
    }
}

async function saveSettings() {
    const newConfig = {
        allowPlayerEdit: document.getElementById('allowPlayerEdit').checked,
        allowTeamEdit: document.getElementById('allowTeamEdit').checked,
        allowFormationEdit: document.getElementById('allowFormationEdit').checked,
        allowAddressEdit: document.getElementById('allowAddressEdit').checked,
        allowChat: document.getElementById('allowChat').checked,
        allowImageUpload: document.getElementById('allowImageUpload').checked, 
        allowMusic: document.getElementById('allowMusic').checked,
        enforceTimeRestriction: document.getElementById('enforceTimeRestriction').checked,
        requireIndividualPin: document.getElementById('requireIndividualPin').checked,
        requireTeamPinForAdd: document.getElementById('requireTeamPinForAdd').checked,
    };
    
    // NEW: Get match address from input field
    const newMatchAddress = document.getElementById('matchAddressInput').value.trim();

    const { error } = await supabase
        .from('app_config')
        .update({ 
            system_config: JSON.stringify(newConfig),
            match_address: newMatchAddress 
        }) // NEW: Include address update
        .eq('id', 1);

    if (error) {
        console.error('Error saving system config and address:', error);
        alert(`Failed to save settings: ${error.message}`);
        return;
    }
    
    systemConfig = newConfig;
    matchAddress = newMatchAddress; // NEW: Update local state
    loadMatchAddress(); // NEW: Refresh the address button display
    applyUIRestrictions();
    document.getElementById('settingsModalOverlay').style.display = 'none';
    alert('System settings and address saved successfully!');
}

async function clearTableData(tableName, confirmMessage, friendlyName) {
    if (!confirm(confirmMessage)) return;
    const { error } = await supabase.from(tableName).delete().gt('id', 0); 

    if (error) {
        alert(`Error clearing ${friendlyName}: ${error.message}`);
        console.error(`Error clearing ${tableName}:`, error);
    } else {
        alert(`${friendlyName} has been cleared successfully.`);
        reloadList(tableName);
        if (tableName.includes('chat_messages')) loadChatMessages();
        if (tableName.includes('system_history')) loadSystemHistory(false);
        if (tableName.includes('_chat')) loadTeamChatMessages(tableName.split('_')[0]);
    }
}

async function clearGroupChat() {
    const confirmMessage = "Are you sure you want to delete ALL player messages in the Group Chat?";
    if (!confirm(confirmMessage)) return;
    const { error } = await supabase
        .from('chat_messages')
        .delete()
        .gt('id', 0);

    if (error) {
        alert(`Error clearing Group Chat: ${error.message}`);
    } else {
        alert("Group Chat (player messages) has been cleared successfully.");
        loadChatMessages(); 
    }
}

async function clearSystemHistory() {
    const confirmMessage = "Are you sure you want to clear all System History logs?";
    if (!confirm(confirmMessage)) return;

    const { error } = await supabase
        .from('system_history')
        .delete()
        .gt('id', 0); 

    if (error) {
        alert(`Error clearing System History: ${error.message}`);
    } else {
        alert("System History has been cleared successfully.");
        if (document.getElementById('systemHistoryContainer').style.display === 'block') {
             loadSystemHistory(false); 
        }
    }
}

function clearBlueChat() {
    clearTableData('blue_chat', 'Are you sure you want to delete ALL messages in the Blue Team Chat?', 'Blue Team Chat');
}
function clearYellowChat() {
    clearTableData('yellow_chat', 'Are you sure you want to delete ALL messages in the Yellow Team Chat?', 'Yellow Team Chat');
}
function clearMainTeam() {
    clearTableData('main_team', 'Are you sure you want to delete ALL players from the Main Team?', 'Main Team List');
}
function clearWaitingList() {
    clearTableData('waiting_list', 'Are you sure you want to delete ALL players from the Waiting List?', 'Waiting List');
}
function clearBlueTeam() {
    clearTableData('blue_team', 'Are you sure you want to delete ALL players from the Blue Team?', 'Blue Team List');
}
function clearYellowTeam() {
    clearTableData('yellow_team', 'Are you sure you want to delete ALL players from the Yellow Team?', 'Yellow Team List');
}

async function canEditCaptain(table, playerId) {
    if (table !== 'blue_team' && table !== 'yellow_team') {
        return true; 
    }
    
    const { data: allPlayers, error: fetchError } = await supabase
        .from(table)
        .select('id, player_pin')
        .order('id', { ascending: true });

    if (fetchError || !allPlayers || allPlayers.length === 0) {
        return false;
    }

    const captain = allPlayers[0]; 
    if (captain.id !== playerId) {
        return true; 
    }

    const storedPin = captain.player_pin;

    if (!storedPin) {
        alert("Captain (Player #1) does not have a PIN set. Action blocked for security.");
        return false;
    }

    const enteredPin = prompt(`Player #1 (Captain): Enter your 4-digit PIN to perform this action:`);
    
    if (enteredPin === null) {
        alert("Operation cancelled.");
        return false;
    }
    
    if (enteredPin === storedPin) {
        return true;
    } else {
        alert("Incorrect PIN. Captain action cancelled.");
        return false;
    }
}

async function verifyIndividualPin(table, id) {
    const { data, error } = await supabase
        .from(table)
        .select('player_pin')
        .eq('id', id)
        .single();
    
    if (error || !data) {
        console.error("Could not find player to verify PIN:", error);
        alert("Error finding player data.");
        return false;
    }

    const storedPin = data.player_pin;
    if (!storedPin) {
        return true; 
    }

    const enteredPin = prompt("Enter your 4-digit PIN to confirm this action:");
    if (enteredPin === null) {
        alert("Operation cancelled.");
        return false;
    }
    
    if (enteredPin === storedPin) {
        return true;
    } else {
        alert("Incorrect PIN. Operation cancelled.");
        return false;
    }
}

async function canControlPlan(team) {
    if (!systemConfig.allowFormationEdit) {
        alert("Formation editing is currently disabled by the administrator.");
        return false;
    }

    if (sessionStorage.getItem(`${team}_captain_unlocked`) === 'true') {
        return true;
    }

    const table = team === 'blue' ? 'blue_team' : 'yellow_team';
    const { data, error } = await supabase
        .from(table)
        .select('id, player_pin')
        .order('id', { ascending: true }) 
        .limit(1)
        .single();

    if (error || !data) {
        alert(`No Captain (Player #1) found for the ${team} team. Cannot edit plan.`);
        return false;
    }

    if (!data.player_pin) {
        alert(`Captain (Player #1) of the ${team} team does not have a PIN set. Cannot edit plan.`);
        return false;
    }
    
    const storedPin = data.player_pin;
    const enteredPin = prompt(`Enter 4-digit Captain PIN for ${team} team to edit the plan:`);

    if (enteredPin === storedPin) {
        sessionStorage.setItem(`${team}_captain_unlocked`, 'true'); 
        return true; 
    } else {
        alert("Incorrect Captain PIN. Action cancelled.");
        return false;
    }
}

async function loadSystemConfig() {
    const { data } = await supabase.from('app_config').select('system_config').eq('id', 1).single(); 
    
    if (data && data.system_config) {
        try {
            const loadedConfig = JSON.parse(data.system_config);
            systemConfig = { ...systemConfig, ...loadedConfig }; 
        } catch (e) {
            console.error("Error parsing system config from database:", e);
        }
    }
    applyUIRestrictions(); 
}

function applyUIRestrictions() {
    const playerManagement = document.getElementById('playerManagement');
    playerManagement.style.display = systemConfig.allowPlayerEdit ? 'block' : 'none';
    
    document.querySelectorAll('.action-btn').forEach(btn => {
        const isTeamBtn = btn.parentNode.parentNode.id === 'blueList' || btn.parentNode.parentNode.id === 'yellowList';
        if (isTeamBtn) {
            btn.style.display = systemConfig.allowTeamEdit ? 'inline-block' : 'none';
        } else {
            btn.style.display = systemConfig.allowPlayerEdit ? 'inline-block' : 'none';
        }
    });

    document.getElementById('bluePlayerManagement').style.display = systemConfig.allowTeamEdit ? 'block' : 'none';
    document.getElementById('yellowPlayerManagement').style.display = systemConfig.allowTeamEdit ? 'block' : 'none';
    
    const displayFormation = systemConfig.allowFormationEdit ? 'inline-block' : 'none';
    document.querySelectorAll('.formation-btn, .dynamic-btn').forEach(btn => {
        btn.style.display = displayFormation;
    });
    
    const chatControls = systemConfig.allowChat ? 'flex' : 'none';
    document.querySelector('.chat-container .chat-input-group').style.display = chatControls;
    document.querySelector('.team-chat-container #blueChatMessages + .chat-input-group').style.display = chatControls;
    document.querySelector('.team-chat-container #yellowChatMessages + .chat-input-group').style.display = chatControls;
    
    const displayImages = (systemConfig.allowChat && systemConfig.allowImageUpload) ? 'flex' : 'none';
    document.querySelectorAll('.img-upload-btn').forEach(btn => {
        btn.style.display = displayImages;
    });
}

// =========================================================================================
// ---- 4. TIME & WEEKLY CLEANUP (MODIFIED) ----
// =========================================================================================

function isWithinAllowedTime(){
    if (!systemConfig.enforceTimeRestriction) {
        return true;
    }
    const now = new Date();
    const currentDay = now.getDay(); 
    const currentHour = now.getHours(); 
    const currentMinute = now.getMinutes();

    if (currentDay >= 3 && currentDay <= 6) { 
        if (currentDay === 3) {
            return currentHour >= 15;
        }
        return true; 
    } else if (currentDay === 0) {
        if (currentHour < 12) {
            return true;
        } else if (currentHour === 12 && currentMinute === 0) {
            return true;
        }
        return false; 
    }
    return false;
}

function formatPlayerTime(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    return date.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true,
        numberingSystem: 'latn' 
    });
}

async function checkAndClearData() {
    const now = new Date();
    let cleanupTimepoint = new Date(now);
    const currentDay = now.getDay(); 
    const currentHour = now.getHours();
    
    cleanupTimepoint.setDate(now.getDate() - currentDay);
    cleanupTimepoint.setHours(18, 0, 0, 0); 
    
    if (currentDay === 0 && currentHour < 18) {
        cleanupTimepoint.setDate(cleanupTimepoint.getDate() - 7);
    } 
    
    const lastCleanupTimestamp = localStorage.getItem('last_cleanup_timestamp');
    let lastCleanupDate = lastCleanupTimestamp ? new Date(parseInt(lastCleanupTimestamp)) : new Date(0);

    if (cleanupTimepoint.getTime() > lastCleanupDate.getTime()) {
        console.log("Weekly cleanup required. Clearing data..."); 
        const tablesToClear = ["main_team", "waiting_list", "blue_team", "yellow_team", "chat_messages", "blue_chat", "yellow_chat", "system_history"];
        
        await Promise.all(tablesToClear.map(table => {
            const deleteQuery = supabase.from(table).delete().gt('id', 0); 
            return deleteQuery
                .then(() => console.log(`Table ${table} cleared.`)) 
                .catch(error => console.error(`Error clearing table ${table}:`, error)); 
        }));
        
        // NEW: Updated default match address text
        const defaultMatchAddress = "Click here to set match address"; 
        const { error: configError } = await supabase
            .from('app_config')
            .update({ match_address: defaultMatchAddress })
            .eq('id', 1);
        if (configError) console.error("Error resetting match address:", configError.message);

        localStorage.setItem('last_cleanup_timestamp', now.getTime().toString());
        console.log("Cleanup complete. Timestamp updated."); 
        
        loadPlayers();
        loadBlue();
        loadYellow();
        loadChatMessages();
        loadTeamChatMessages('blue');
        loadTeamChatMessages('yellow');
        loadMatchAddress();
        loadSystemHistory(false); 
    } 
}


// =========================================================================================
// ---- 5. MAIN & WAITING LISTS MANAGEMENT (MODIFIED for Notifications) ----
// =========================================================================================

async function addPlayer(){
  if(!systemConfig.allowPlayerEdit){
    alert("Player addition is currently disabled by the system administrator.");
    return;
  }
  if(!isWithinAllowedTime()){
    alert("Adding players is only allowed from Wednesday 3 PM to Sunday 12 PM.");
    return;
  }
  const name = document.getElementById("nameInput").value.trim();
  if(!name) return alert("Enter a name");
  
  if (systemConfig.requireTeamPinForAdd) {
      const teamPin = prompt("Enter the 4-digit Team PIN to join:");
      if (teamPin !== TEAM_ADD_PIN) {
          alert("Incorrect Team PIN. Operation cancelled.");
          return;
      }
  }
  
  let newPin = null;
  if (systemConfig.requireIndividualPin) {
      const pin1 = prompt("Create your 4-digit PIN (you will need this to edit/delete your name):");
      if (!pin1 || pin1.length !== 4 || isNaN(pin1)) {
          alert("Invalid PIN. Must be 4 numbers. Operation cancelled.");
          return;
      }
      const pin2 = prompt("Confirm your 4-digit PIN:");
      if (pin1 !== pin2) {
          alert("PINs do not match. Operation cancelled.");
          return;
      }
      newPin = pin1; 
  }

  const { data: team } = await supabase.from("main_team").select("id");
  const playerData = { name, time: Date.now() };
  if (newPin) { playerData.player_pin = newPin; }

  if(team.length < 24){
    const { error } = await supabase.from("main_team").insert([playerData]);
    if(error) return alert(error.message);
    
    const message = `Player ${name} joined the Main Team!`; 
    await sendSystemMessageToChat(name, message);

  } else {
    const { error } = await supabase.from("waiting_list").insert([playerData]);
    if(error) {
        return alert("Main team is full (24). Player could not be added to waiting list."); 
    }
    alert("The Main Team is full (24 players). You have been added to the Waiting List.");
    const systemMessage = `Player ${name} was added to the Waiting List because the main team is full.`; 
    await sendSystemMessageToChat(name, systemMessage);
  }
  
  document.getElementById("nameInput").value="";
  loadPlayers();
}

async function loadPlayers(){
  const { data: team } = await supabase.from("main_team").select("*").order("id");
  const { data: waiting } = await supabase.from("waiting_list").select("*").order("id");
  const teamList = document.getElementById("teamList");
  const waitingList = document.getElementById("waitingList");
  teamList.innerHTML = "";
  waitingList.innerHTML = "";
  
  const isPlayerEditAllowed = systemConfig.allowPlayerEdit;

  if(team) team.forEach((p,i) => {
    const time = formatPlayerTime(p.time); 
    const buttons = isPlayerEditAllowed ? 
        `<span>
          <button class="action-btn edit-btn" onclick="editPlayer('main_team',${p.id},'${p.name}')">Edit</button> 
          <button class="action-btn delete-btn" onclick="deletePlayer('main_team',${p.id})">Delete</button>
        </span>` : '';
    teamList.innerHTML += `
      <li>
        <div class="player-info">
            <span>${i+1}. ${p.name} <span class="player-time">${time}</span></span>
        </div>
        ${buttons}
      </li>`;
  });

  if(waiting) waiting.forEach((p,i) => {
    const time = formatPlayerTime(p.time); 
    const buttons = isPlayerEditAllowed ? 
        `<span>
          <button class="action-btn edit-btn" onclick="editPlayer('waiting_list',${p.id},'${p.name}')">Edit</button>
          <button class="action-btn delete-btn" onclick="deletePlayer('waiting_list',${p.id})">Delete</button>
        </span>` : '';
    waitingList.innerHTML += `
      <li>
        <div class="player-info">
            <span>${i+1}. ${p.name} <span class="player-time">${time}</span></span>
        </div>
        ${buttons}
      </li>`;
  });
}

async function refillMainTeam(){
  const { data: team } = await supabase.from("main_team").select("id");
  const { data: waiting } = await supabase.from("waiting_list").select("*").order("id", { ascending: true }); 
  
  if(team.length < 24 && waiting.length > 0){
    const first = waiting[0];
    const addPromise = supabase.from("main_team").insert([{ 
        name: first.name, 
        time: Date.now(), 
        player_pin: first.player_pin 
    }]);
    const deletePromise = supabase.from("waiting_list").delete().eq("id", first.id);
    const [addResult, deleteResult] = await Promise.all([addPromise, deletePromise]);
    
    if(addResult.error) { console.error("Error adding player from waiting list to main team:", addResult.error); return; }
    
    const message = `Player ${first.name} moved from Waiting List to Main Team.`;
    await sendSystemMessageToChat(first.name, message);
  }
}

async function deletePlayer(table, id){
  let playerName = "";
  let isMainTeam = table === "main_team";
  let isMainOrWaiting = isMainTeam || table === "waiting_list"; 
  let isTeamTable = table === "blue_team" || table === "yellow_team";
  
  if (isMainOrWaiting && !systemConfig.allowPlayerEdit) {
      alert("Player deletion is disabled.");
      return;
  }
  if (isTeamTable && !systemConfig.allowTeamEdit) {
      alert("Team editing is disabled.");
      return;
  }

  if (isTeamTable) {
      const canEdit = await canEditCaptain(table, id);
      if (!canEdit) return;
  }

  if (isMainOrWaiting && systemConfig.requireIndividualPin) { 
      const pinVerified = await verifyIndividualPin(table, id);
      if (!pinVerified) return; 
  }

  const { data, error } = await supabase.from(table).select('name').eq("id", id).single();
  if (data) {
      playerName = data.name;
  }

  if(!confirm(`Are you sure you want to delete ${playerName || 'this player'}?`)) return;
  
  const { error: deleteError } = await supabase.from(table).delete().eq("id",id);
  if (deleteError) {
      alert(`Error deleting: ${deleteError.message}`);
      return;
  }

  if ((table === "main_team" || table === "waiting_list") && playerName) {
      const listName = table === "main_team" ? "Main Team" : "Waiting List";
      const message = `Player ${playerName} left the ${listName}.`; 
      await sendSystemMessageToChat(playerName, message);
  }

  if(table==="main_team") {
    await refillMainTeam(); 
  }
  
  reloadList(table);
}

async function editPlayer(table,id,oldName){
  const isMainOrWaiting = table === "main_team" || table === "waiting_list";
  const isTeamTable = table === "blue_team" || table === "yellow_team";

  if (isMainOrWaiting && !systemConfig.allowPlayerEdit) {
      alert("Player editing in main/waiting lists is currently disabled by the system administrator.");
      return;
  }
  if (isTeamTable && !systemConfig.allowTeamEdit) {
      alert("Player editing in team lists is currently disabled by the system administrator.");
      return;
  }
  
  if (isTeamTable) {
      const canEdit = await canEditCaptain(table, id);
      if (!canEdit) return;
  }
  
  if (isMainOrWaiting && systemConfig.requireIndividualPin) { 
      const pinVerified = await verifyIndividualPin(table, id);
      if (!pinVerified) return; 
  }

  const newName=prompt(`Edit name for ${oldName}:`, oldName);
  if(!newName || newName.trim()==="") return;
  
  const { error } = await supabase.from(table).update({name:newName.trim()}).eq("id",id); 
  
  if (error) {
      alert(`Error editing player name: ${error.message}`);
      return;
  }
  
  reloadList(table);
}

function reloadList(table){
  if(table==="main_team" || table==="waiting_list") loadPlayers();
  else if(table==="blue_team") loadBlue();
  else if(table==="yellow_team") loadYellow();
  else if(table==="chat_messages") loadChatMessages();
  else if(table==="blue_chat") loadTeamChatMessages('blue');
  else if(table==="yellow_chat") loadTeamChatMessages('yellow');
  else if(table==="system_history") loadSystemHistory(false);
  applyUIRestrictions(); 
}

// =========================================================================================
// ---- 6. BLUE/YELLOW TEAM MANAGEMENT ----
// =========================================================================================

async function addBlue(){
  if(!systemConfig.allowTeamEdit){
    alert("Player addition to teams is currently disabled by the system administrator.");
    return;
  }
  const name=document.getElementById("blueInput").value.trim();
  if(!name) return;

  const { data: team } = await supabase.from("blue_team").select("id");
  if(team.length >= 12) return alert("Blue team is full (12 players).");

  let newPin = null;
  if (team.length === 0) { 
      newPin = prompt("Create 4-digit PIN for Player #1 (Captain):");
      if (!newPin || newPin.length !== 4 || isNaN(newPin)) {
          alert("Invalid PIN. Must be 4 numbers. Aborting.");
          return;
      }
      const pin2 = prompt("Confirm Captain PIN:");
      if (newPin !== pin2) {
          alert("PINs do not match. Aborting.");
          return;
      }
  }

  const defaultPos = FORMATIONS['4-3-3'][0];
  const positionString = JSON.stringify({ left: defaultPos.left, top: defaultPos.top });
  
  const playerData = {
      name, 
      time: Date.now(), 
      position: positionString, 
      position_code: defaultPos.code
  };
  if (newPin) { playerData.player_pin = newPin; }

  await supabase.from("blue_team").insert([playerData]);
  document.getElementById("blueInput").value="";
  loadBlue();
}

async function loadBlue(){
  const { data } = await supabase.from("blue_team").select("*").order("id");
  const ul=document.getElementById("blueList");
  const field=document.getElementById("bluePlan");
  ul.innerHTML=""; 
  field.innerHTML=`<div class="mid-line"></div><div class="center-circle"></div><div class="penalty-box-left"></div><div class="penalty-box-right"></div>`; 
  
  const isTeamEditAllowed = systemConfig.allowTeamEdit;
  
  if(data) data.forEach((p,i)=>{
    const time = formatPlayerTime(p.time); 
    const displayName = (i === 0) ? `${p.name} (C)` : p.name;
    const buttons = isTeamEditAllowed ?
        `<span>
          <button class="action-btn edit-btn" onclick="editPlayer('blue_team',${p.id},'${p.name}')">Edit</button>
          <button class="action-btn delete-btn" onclick="deletePlayer('blue_team',${p.id})">Delete</button>
        </span>` : '';
    ul.innerHTML += `
      <li>
        <div class="player-info">
            <span>${i+1}. ${displayName} <span class="player-time">${time}</span></span>
        </div>
        ${buttons}
      </li>`;
    let pos = p.position ? JSON.parse(p.position) : null;
    createPlayerMarker('blue', p.name, p.id, pos, p.position_code, i + 1);
  });
  setupDraggable('blue');
}

async function addYellow(){
  if(!systemConfig.allowTeamEdit){
    alert("Player addition to teams is currently disabled by the system administrator.");
    return;
  }
  const name=document.getElementById("yellowInput").value.trim();
  if(!name) return;
  
  const { data: team } = await supabase.from("yellow_team").select("id");
  if(team.length >= 12) return alert("Yellow team is full (12 players).");

  let newPin = null;
  if (team.length === 0) { 
      newPin = prompt("Create 4-digit PIN for Player #1 (Captain):");
      if (!newPin || newPin.length !== 4 || isNaN(newPin)) {
          alert("Invalid PIN. Must be 4 numbers. Aborting.");
          return;
      }
      const pin2 = prompt("Confirm Captain PIN:");
      if (newPin !== pin2) {
          alert("PINs do not match. Aborting.");
          return;
      }
  }

  const defaultPos = FORMATIONS['4-3-3'][0];
  const positionString = JSON.stringify({ left: defaultPos.left, top: defaultPos.top });
  
  const playerData = {
      name, 
      time: Date.now(), 
      position: positionString, 
      position_code: defaultPos.code
  };
  if (newPin) { playerData.player_pin = newPin; }

  await supabase.from("yellow_team").insert([playerData]);
  document.getElementById("yellowInput").value="";
  loadYellow();
}

async function loadYellow(){
  const { data } = await supabase.from("yellow_team").select("*").order("id");
  const ul=document.getElementById("yellowList");
  const field=document.getElementById("yellowPlan");
  ul.innerHTML=""; 
  field.innerHTML=`<div class="mid-line"></div><div class="center-circle"></div><div class="penalty-box-left"></div><div class="penalty-box-right"></div>`; 
  
  const isTeamEditAllowed = systemConfig.allowTeamEdit;
  
  if(data) data.forEach((p,i)=>{
    const time = formatPlayerTime(p.time); 
    const displayName = (i === 0) ? `${p.name} (C)` : p.name;
    const buttons = isTeamEditAllowed ?
        `<span>
          <button class="action-btn edit-btn" onclick="editPlayer('yellow_team',${p.id},'${p.name}')">Edit</button>
          <button class="action-btn delete-btn" onclick="deletePlayer('yellow_team',${p.id})">Delete</button>
        </span>` : '';
    ul.innerHTML += `
      <li>
        <div class="player-info">
            <span>${i+1}. ${displayName} <span class="player-time">${time}</span></span>
        </div>
        ${buttons}
      </li>`;
    let pos = p.position ? JSON.parse(p.position) : null;
    createPlayerMarker('yellow', p.name, p.id, pos, p.position_code, i + 1);
  });
  setupDraggable('yellow');
}

// =========================================================================================
// ---- 7. FORMATIONS & TACTICS ----
// =========================================================================================

async function applyFormation(team, formationName) {
    if (!await canControlPlan(team)) {
        return;
    }

    const table = team === 'blue' ? 'blue_team' : 'yellow_team';
    const formation = FORMATIONS[formationName];
    
    const { data: players, error } = await supabase.from(table).select('id').order('id', { ascending: true });
    
    if (error || !players || players.length === 0) {
        alert(`No players found in the ${team} team to apply formation.`);
        return;
    }

    const updates = players.slice(0, 12).map((player, index) => {
        let pos;
        if (index < formation.length) {
            pos = formation[index];
        } else {
            pos = { left: '40%', top: '5%', code: 'SUB' };
        }

        const positionString = JSON.stringify({ left: pos.left, top: pos.top });
        
        return supabase.from(table)
            .update({ position: positionString, position_code: pos.code })
            .eq('id', player.id)
            .select(); 
    });

    await Promise.all(updates);
    
    if (team === 'blue') loadBlue(); else loadYellow();
    alert(`${formationName} formation applied successfully to the ${team} team.`);
}

function getDynamicFormation(N) {
    if (N === 0) return [];

    const distributionMap = [];
    distributionMap.push({ X: 5, Y_count: 1, code: 'GK' }); 
    distributionMap.push({ X: 25, Y_count: 4, code: 'CB' }); 
    distributionMap.push({ X: 55, Y_count: 4, code: 'CM' }); 
    distributionMap.push({ X: 80, Y_count: 3, code: 'CF' }); 
    
    if (N > 12) {
        distributionMap.push({ X: 10, Y_count: N - 12, code: 'SUB' }); 
    }

    const positions = [];
    let currentPlayerIndex = 1;

    for (const zone of distributionMap) {
        if (currentPlayerIndex > N) break;

        let playersInZone = Math.min(zone.Y_count, N - currentPlayerIndex + 1);
        if (playersInZone === 0) continue;
        
        const Y_min = 10;
        const Y_max = 90;
        let deltaY = playersInZone > 1 ? (Y_max - Y_min) / (playersInZone - 1) : 0;

        for (let j = 0; j < playersInZone; j++) {
            let top;
            if (playersInZone === 1) {
                top = 50; 
            } else {
                top = Y_min + j * deltaY;
            }
            positions.push({ left: `${zone.X}%`, top: `${top.toFixed(2)}%`, code: zone.code });
            currentPlayerIndex++;
        }
    }
    return positions;
}

async function applyDynamicPlan(team) {
    if (!await canControlPlan(team)) { return; }
    
    const table = team === 'blue' ? 'blue_team' : 'yellow_team';
    const { data: players, error } = await supabase.from(table).select('id').order('id', { ascending: true });
    
    if (error || !players || players.length === 0) {
        alert(`No players found in the ${team} team to apply the dynamic plan.`);
        return;
    }
    
    const N = players.length;
    const dynamicFormation = getDynamicFormation(N);
    
    const updates = players.map((player, index) => {
        if (index < dynamicFormation.length) {
            const pos = dynamicFormation[index];
            const positionString = JSON.stringify({ left: pos.left, top: pos.top });
            return supabase.from(table)
                .update({ position: positionString, position_code: pos.code })
                .eq('id', player.id)
                .select();
        }
        return null; 
    }).filter(update => update !== null); 

    await Promise.all(updates);
    if (team === 'blue') loadBlue(); else loadYellow();
    alert(`Dynamic plan applied successfully for ${N} players in the ${team} team.`);
}

// =========================================================================================
// ---- 8. PLAYER MARKERS & DRAGGING ----
// =========================================================================================

function distance(x1, y1, x2, y2) {
    const dx = x1 - x2;
    const dy = y1 - y2;
    return Math.sqrt(dx * dx + dy * dy);
}

function getNearestPositionCode(newLeftPercent, newTopPercent) {
    const referenceFormation = FORMATIONS['4-3-3'].concat(
        FORMATIONS['4-4-2'].filter(p => !FORMATIONS['4-3-3'].some(fp => fp.code === p.code))
    ).concat(
        FORMATIONS['3-4-3'].filter(p => !FORMATIONS['4-3-3'].some(fp => fp.code === p.code) && !FORMATIONS['4-4-2'].some(fp => fp.code === p.code))
    );
    
    let nearestCode = 'SUB';
    let minDistance = Infinity;

    referenceFormation.forEach(pos => {
        const refLeft = parseFloat(pos.left);
        const refTop = parseFloat(pos.top);
        const dist = distance(newLeftPercent, newTopPercent, refLeft, refTop);

        if (dist < minDistance) {
            minDistance = dist;
            nearestCode = pos.code;
        }
    });
    return nearestCode;
}

function createPlayerMarker(team, playerName, playerId, storedPosition=null, positionCode='SUB', playerNumber=null) { 
  const fieldId = team === 'blue' ? 'bluePlan' : 'yellowPlan';
  const field = document.getElementById(fieldId);

  const existingMarker = document.getElementById(`marker-${team}-${playerId}`);
  if (existingMarker) existingMarker.remove();

  const marker = document.createElement('div');
  marker.classList.add('player-marker');
  marker.id = `marker-${team}-${playerId}`; 
  marker.dataset.playerId = playerId;
  marker.dataset.team = team;
  marker.dataset.table = team === 'blue' ? 'blue_team' : 'yellow_team';
  marker.style.background = team==='blue'? '#1976d2' : '#fbc02d';
  
  const displayPlayerName = playerNumber === 1 ? `${playerNumber}. ${playerName} (C)` : (playerNumber !== null ? `${playerNumber}. ${playerName}` : playerName);
  let leftPercent = '50%';
  let topPercent = '50%';
  if (storedPosition) { leftPercent = storedPosition.left; topPercent = storedPosition.top; }

  marker.style.left = leftPercent;
  marker.style.top = topPercent;
  marker.innerHTML = `<span class="player-position-label">${positionCode || 'SUB'}</span>`;

  const label = document.createElement('div');
  label.classList.add('player-name');
  label.innerText = displayPlayerName; 
  label.style.color = team==='blue' ? '#fff' : '#000'; 
  marker.appendChild(label);
  
  marker.addEventListener('click', (e) => {
    if (e.detail === 1) { showPositionMenu(team, playerId, playerName); }
  });

  field.appendChild(marker);
}


function setupDraggable(team) {
  const fieldId = team === 'blue' ? '#bluePlan' : '#yellowPlan';
  const table = team === 'blue' ? 'blue_team' : 'yellow_team';
  const field = document.getElementById(team === 'blue' ? 'bluePlan' : 'yellowPlan');

  interact(`${fieldId} .player-marker`).unset(); 

  if (!systemConfig.allowFormationEdit) { return; }

  interact(`${fieldId} .player-marker`)
    .draggable({
      inertia: false, 
      modifiers: [ interact.modifiers.restrictRect({ restriction: field }) ],
      listeners: {
        start (event) {
            const target = event.target;
            const fieldRect = field.getBoundingClientRect();
            
            let left_percent = parseFloat(target.style.left);
            let top_percent = parseFloat(target.style.top);
            
            let x = (left_percent / 100) * fieldRect.width;
            let y = (top_percent / 100) * fieldRect.height;

            target.dataset.x = x;
            target.dataset.y = y;
            target.style.left = `${x}px`;
            target.style.top = `${y}px`;
            target.style.transform = `translate(-50%, -50%)`;
        },
        move (event) {
          const target = event.target;
          let x = (parseFloat(target.dataset.x) || 0) + event.dx;
          let y = (parseFloat(target.dataset.y) || 0) + event.dy;

          target.style.left = `${x}px`;
          target.style.top = `${y}px`;
          target.dataset.x = x;
          target.dataset.y = y;

          const fieldRect = field.getBoundingClientRect();
          let left_percent = (x / fieldRect.width) * 100;
          let top_percent = (y / fieldRect.height) * 100;
          left_percent = Math.max(0, Math.min(100, left_percent));
          top_percent = Math.max(0, Math.min(100, top_percent));

          const newPositionCode = getNearestPositionCode(left_percent, top_percent);
          const labelElement = target.querySelector('.player-position-label');
          if (labelElement && labelElement.textContent !== newPositionCode) {
              labelElement.textContent = newPositionCode;
          }
        },
        end: async (event) => {
          const target = event.target;
          const table = target.dataset.table;
          const team = target.dataset.team;

          const hasPermission = await canControlPlan(team);
          if (!hasPermission) {
              alert("PIN check failed. Position change was not saved.");
              if (team === 'blue') loadBlue(); else loadYellow();
              return;
          }

          const fieldRect = field.getBoundingClientRect();
          const x_end_px = parseFloat(target.dataset.x);
          const y_end_px = parseFloat(target.dataset.y);
          
          let left_percent = (x_end_px / fieldRect.width) * 100;
          let top_percent = (y_end_px / fieldRect.height) * 100;
          left_percent = Math.max(0, Math.min(100, left_percent));
          top_percent = Math.max(0, Math.min(100, top_percent));

          const newPositionCode = getNearestPositionCode(left_percent, top_percent);
          const labelElement = target.querySelector('.player-position-label');
          if (labelElement) { labelElement.textContent = newPositionCode; }

          target.style.left = `${left_percent.toFixed(2)}%`;
          target.style.top = `${top_percent.toFixed(2)}%`;
          target.style.transform = `translate(-50%, -50%)`;

          target.dataset.x = 0; 
          target.dataset.y = 0; 

          const playerId = target.dataset.playerId;
          const newPosition = JSON.stringify({ left: `${left_percent.toFixed(2)}%`, top: `${top_percent.toFixed(2)}%` });
          
          supabase.from(table)
              .update({ position: newPosition, position_code: newPositionCode })
              .eq('id', playerId)
              .then(({ error }) => { if (error) console.error("Error saving drag position:", error); });
        }
      }
    });
}


// =========================================================================================
// ---- 9. POSITION SELECTION MENU ----
// =========================================================================================

async function showPositionMenu(team, playerId, playerName) {
    if (!await canControlPlan(team)) { return; }
    
    currentPositionTarget = { team, playerId, playerName };
    document.getElementById('positionMenuTitle').textContent = `Select Position for ${playerName}`;
    
    const grid = document.getElementById('positionMenuGrid');
    grid.innerHTML = ''; 

    POSITIONS_LIST.forEach(pos => {
        const button = document.createElement('button');
        button.textContent = `${pos.code} (${pos.label})`;
        button.onclick = () => selectPosition(pos.code);
        grid.appendChild(button);
    });

    document.getElementById('positionMenuOverlay').style.display = 'flex';
}

async function closePositionMenu() {
    document.getElementById('positionMenuOverlay').style.display = 'none';
    currentPositionTarget = { team: null, playerId: null, playerName: null }; 
}

async function selectPosition(positionCode) {
    const { team, playerId } = currentPositionTarget;
    if (!team || !playerId) {
        closePositionMenu();
        return;
    }

    const table = team === 'blue' ? 'blue_team' : 'yellow_team';
    const refPos = FORMATIONS['4-3-3'].find(p => p.code === positionCode) || 
                   FORMATIONS['4-4-2'].find(p => p.code === positionCode) ||
                   FORMATIONS['3-4-3'].find(p => p.code === positionCode) ||
                   { left: '50%', top: '50%', code: positionCode };
    
    const newPosition = { left: refPos.left, top: refPos.top };

    const { error } = await supabase.from(table)
        .update({ position_code: positionCode, position: JSON.stringify(newPosition) })
        .eq('id', playerId);

    if (error) {
        console.error('Error updating position:', error);
        alert(`Failed to update position: ${error.message}`);
    }

    closePositionMenu();
    reloadList(table);
}


// =========================================================================================
// ---- 10. ADDRESS, CHAT, HISTORY, REALTIME (UPDATED) ----
// =========================================================================================

function showToast(message) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.innerText = message;
    toast.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:10px 20px; border-radius:20px; box-shadow:0 2px 10px rgba(0,0,0,0.5); z-index:3000; font-weight:bold;';
    container.appendChild(toast);
    setTimeout(() => { toast.remove(); }, 3000);
}

// UPDATED FUNCTION: Only load the address and update the button text
async function loadMatchAddress() {
    const { data } = await supabase.from('app_config').select('match_address').eq('id', 1).single(); 
    const savedAddress = data ? data.match_address : "Address üìç";
    matchAddress = savedAddress;
    
    const addressBtn = document.getElementById('addressBtn');
    if (savedAddress.length > 20 && !savedAddress.includes("set match address")) {
        // Show a truncated version or just "Address" on the button
        addressBtn.textContent = "Match Address üìç"; 
    } else if (savedAddress.includes("set match address")) {
         addressBtn.textContent = "Set Address üìç"; 
    } else {
        addressBtn.textContent = `${savedAddress} üìç`;
    }
}

// Function no longer needed since address editing moved to Settings modal only
function setupAddressEditor() {
    // This function is obsolete and remains for compatibility but does nothing new.
    console.log("setupAddressEditor is disabled/modified.");
}

// Function is now part of saveSettings() - kept for modularity/re-use if needed
async function saveMatchAddress(address) {
    if (!systemConfig.allowAddressEdit) {
        alert("Match address editing is currently disabled by the system administrator.");
        return;
    }
    const addressToSave = address.trim() || '';

    const { error } = await supabase
        .from('app_config')
        .upsert({ id: 1, match_address: addressToSave })
        .select();

    if (error) {
        console.error("Error saving address:", error);
        alert("Failed to save address. Check connection.");
        return;
    }
    
    showToast("Address Saved Successfully!");
}

function playNotificationSound() {
    const sound = document.getElementById('notification-sound');
    sound.currentTime = 0; 
    sound.play().catch(e => console.log("Notification sound blocked:", e));
}

async function sendSystemMessageToChat(playerName, content) {
    const { error } = await supabase
        .from('system_history')
        .insert([{ content: content, username: 'System' }]); 
    
    if (error) { console.error('Error sending system message to history:', error); } 
    else {
        const historyContainer = document.getElementById('systemHistoryContainer');
        if (historyContainer.style.display === 'block') { loadSystemHistory(false); }
    }
}

async function handleImageUpload(inputElement, context) {
    const file = inputElement.files[0];
    if (!file) return;
    
    if (!systemConfig.allowImageUpload) {
        alert("Image uploads are currently disabled by the system administrator.");
        inputElement.value = '';
        return;
    }
    
    if (!systemConfig.allowChat) {
        alert("Sending messages is currently disabled by the system administrator.");
        inputElement.value = '';
        return;
    }

    let nameInputId;
    if (context === 'global') nameInputId = 'chatNameInput';
    else if (context === 'blue') nameInputId = 'blueChatNameInput';
    else if (context === 'yellow') nameInputId = 'yellowChatNameInput';
    
    const username = document.getElementById(nameInputId).value.trim();
    if (!username) {
        alert("Please enter your name before sending an image.");
        inputElement.value = '';
        return;
    }
    localStorage.setItem('chat_username', username);

    const fileName = `${Date.now()}_${file.name.replace(/\s/g, '_')}`;
    const { data, error } = await supabase.storage.from('chat_images').upload(fileName, file);

    if (error) {
        console.error("Upload error:", error);
        alert("Failed to upload image. Make sure you created a Public Bucket named 'chat_images'.");
        inputElement.value = '';
        return;
    }

    const { data: urlData } = supabase.storage.from('chat_images').getPublicUrl(fileName);
    const publicUrl = urlData.publicUrl;
    const content = `[IMG]${publicUrl}`;
    const table = context === 'global' ? 'chat_messages' : `${context}_chat`;

    const { error: msgError } = await supabase.from(table).insert([{ username, content }]);
    if (msgError) {
        console.error("Message send error:", msgError);
        alert("Image uploaded but failed to send message.");
    } else {
        playNotificationSound();
    }
    inputElement.value = '';
}

// =========================================================================================
// ---- UPDATED: DELETE SINGLE MESSAGE LOGIC ----
// =========================================================================================

function renderMessage(message, containerId) {
  const messagesContainer = document.getElementById(containerId);
  if (!messagesContainer) return;

  const msgDiv = document.createElement('div');
  msgDiv.classList.add('message');
  
  const storedName = localStorage.getItem('chat_username');
  const isMyMessage = storedName && storedName.trim() === message.username.trim();
  const nameColor = getColorForUsername(message.username);

  if (isMyMessage) { msgDiv.classList.add('my-message'); } 
  else {
    msgDiv.style.borderColor = nameColor;
    msgDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.05)'; 
  }

  const date = new Date(message.created_at).toLocaleTimeString('en-US', {
    hour: '2-digit', minute: '2-digit', hour12: true, numberingSystem: 'latn' 
  });
  const timeSpan = `<span style="color:#888;">${date}</span>`;
  
  let contentHtml = `<span>${message.content}</span>`;
  if (message.content.startsWith('[IMG]')) {
      const imageUrl = message.content.replace('[IMG]', '');
      contentHtml = `<img src="${imageUrl}" class="chat-uploaded-img" onclick="window.open(this.src, '_blank')">`;
  }
  
  let deleteBtnHtml = '';
  if (isMyMessage) {
      let tableName = 'chat_messages';
      if(containerId.includes('blue')) tableName = 'blue_chat';
      if(containerId.includes('yellow')) tableName = 'yellow_chat';
      
      deleteBtnHtml = `<button class="delete-msg-btn" onclick="deleteSingleMessage('${tableName}', ${message.id})">üóëÔ∏è</button>`;
  }

  msgDiv.innerHTML = `<span class="message-header" style="color: ${nameColor};">${message.username} ${timeSpan}</span>${contentHtml} ${deleteBtnHtml}`;
  messagesContainer.appendChild(msgDiv); 
  messagesContainer.scrollTop = messagesContainer.scrollHeight; 
}

async function deleteSingleMessage(table, id) {
    if(!confirm("Delete this message?")) return;
    const { error } = await supabase.from(table).delete().eq('id', id);
    if(error) {
        alert("Error deleting message: " + error.message);
    }
}

async function loadChatMessages() {
  const { data, error } = await supabase.from('chat_messages').select('*').order('created_at', { ascending: true }).limit(50); 
  if (error) return;
  const messagesContainer = document.getElementById('chatMessages');
  messagesContainer.innerHTML = ''; 
  data.forEach(msg => renderMessage(msg, 'chatMessages'));
  messagesContainer.scrollTop = messagesContainer.scrollHeight; 
}

async function sendMessage() {
  if (!systemConfig.allowChat) { alert("Sending messages is currently disabled."); return; }
  const nameInput = document.getElementById('chatNameInput');
  const msgInput = document.getElementById('chatMsgInput');
  const username = nameInput.value.trim();
  const content = msgInput.value.trim();
  if (!username) { return alert("Please enter your name."); }
  if (!content) { return alert("Cannot send an empty message."); }
  localStorage.setItem('chat_username', username);
  const { error } = await supabase.from('chat_messages').insert([{ username, content }]); 
  if (error) return alert(`Error sending message: ${error.message}`);
  msgInput.value = ''; 
  playNotificationSound();
}

async function loadTeamChatMessages(team) {
    const table = `${team}_chat`; 
    const containerId = `${team}ChatMessages`;
    const { data, error } = await supabase.from(table).select('*').order('created_at', { ascending: true }).limit(50); 
    const messagesContainer = document.getElementById(containerId);
    if (error) { messagesContainer.innerHTML = '<div class="message">Error loading chat.</div>'; return; }
    messagesContainer.innerHTML = ''; 
    data.forEach(msg => renderMessage(msg, containerId));
    messagesContainer.scrollTop = messagesContainer.scrollHeight; 
}

async function sendTeamMessage(team) {
    if (!systemConfig.allowChat) { alert("Sending messages is disabled."); return; }
    const nameInputId = `${team}ChatNameInput`;
    const msgInputId = `${team}ChatMsgInput`;
    const table = `${team}_chat`; 
    const username = document.getElementById(nameInputId).value.trim();
    const content = document.getElementById(msgInputId).value.trim();
    if (!username) { return alert("Please enter your name."); }
    if (!content) { return alert("Cannot send an empty message."); }
    localStorage.setItem('chat_username', username); 
    document.getElementById('chatNameInput').value = username;
    document.getElementById('blueChatNameInput').value = username;
    document.getElementById('yellowChatNameInput').value = username;
    const { error } = await supabase.from(table).insert([{ username, content }]); 
    if (error) return alert(`Error: ${error.message}`);
    document.getElementById(msgInputId).value = ''; 
    playNotificationSound();
}

async function loadSystemHistory(toggle = true) {
  const historyContainer = document.getElementById('systemHistoryContainer');
  const historyList = document.getElementById('historyList');
  if (toggle) { historyContainer.style.display = historyContainer.style.display === 'block' ? 'none' : 'block'; }
  if (historyContainer.style.display === 'none') return;
  
  historyList.innerHTML = '<li style="text-align:center; color:#aaa;">Loading...</li>'; 

  const { data, error } = await supabase.from('system_history').select('*').order('created_at', { ascending: false }).limit(50);

  if (error || !data || data.length === 0) {
    historyList.innerHTML = '<li style="text-align:center; color:#aaa;">No recent events.</li>';
    return;
  }
  
  historyList.innerHTML = ''; 
  
  data.forEach(item => {
    const dateObj = new Date(item.created_at);
    const time = dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    
    let bgColor = '#424242'; 
    let textColor = '#fff';
    let icon = '';
    const contentLower = item.content.toLowerCase();

    // Color Logic
    if (contentLower.includes('joined')) {
        bgColor = '#2e7d32'; // Green
        icon = '‚úî';
    } else if (contentLower.includes('left')) {
        bgColor = '#c62828'; // Red
        icon = '‚úñ';
    } else if (contentLower.includes('moved') || contentLower.includes('waiting list')) {
        bgColor = '#f57f17'; // Orange
        textColor = '#000';
        icon = '‚ö†';
    }

    historyList.innerHTML += `
      <li style="background-color: ${bgColor}; color: ${textColor}; padding: 10px 15px; border-radius: 15px; margin-bottom: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; flex-direction: column; align-items: flex-start; text-align: left; border: 1px solid rgba(255,255,255,0.1);">
        <div style="font-size: 14px; font-weight: bold; width:100%;"><span style="margin-right:5px;">${icon}</span> ${item.content}</div>
        <div style="font-size: 11px; opacity: 0.8; margin-top: 5px; align-self: flex-end;">${time}</div>
      </li>`;
  });
}

// =========================================================================================
// ---- 11. REALTIME SETUP & INITIALIZATION ----
// =========================================================================================

function setupRealtime() {
  supabase.channel('global-chat-updates')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' },
      (payload) => {
        const storedName = localStorage.getItem('chat_username'); 
        if (storedName && storedName.trim() !== payload.new.username.trim()) { playNotificationSound(); }
        renderMessage(payload.new, 'chatMessages'); 
      }
    )
    .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'chat_messages' },
      (payload) => { loadChatMessages(); }
    )
    .subscribe();
    
    supabase.channel('system-history-updates')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'system_history' },
      (payload) => {
         const historyContainer = document.getElementById('systemHistoryContainer');
         if (historyContainer.style.display === 'block') { loadSystemHistory(false); }
      }
    )
    .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'system_history' },
        (payload) => {
           const historyContainer = document.getElementById('systemHistoryContainer');
           if (historyContainer.style.display === 'block') { loadSystemHistory(false); }
        }
    )
    .subscribe();

    supabase.channel('blue-chat-updates')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'blue_chat' },
        (payload) => {
            const storedName = localStorage.getItem('chat_username');
            if (storedName && storedName.trim() !== payload.new.username.trim()) { playNotificationSound(); }
            if(document.getElementById('blue').style.display === 'block') { renderMessage(payload.new, 'blueChatMessages'); }
        }
    )
    .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'blue_chat' }, (payload) => { loadTeamChatMessages('blue'); })
    .subscribe();

    supabase.channel('yellow-chat-updates')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'yellow_chat' },
        (payload) => {
            const storedName = localStorage.getItem('chat_username');
            if (storedName && storedName.trim() !== payload.new.username.trim()) { playNotificationSound(); }
            if(document.getElementById('yellow').style.display === 'block') { renderMessage(payload.new, 'yellowChatMessages'); }
        }
    )
    .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'yellow_chat' }, (payload) => { loadTeamChatMessages('yellow'); })
    .subscribe();
    
    supabase.channel('main-team-updates')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'main_team' }, async (payload) => { loadPlayers(); })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'waiting_list' }, async (payload) => { loadPlayers(); })
    
    .on('postgres_changes', { event: '*', schema: 'public', table: 'blue_team' }, async (payload) => { 
        loadBlue(); 
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'yellow_team' }, async (payload) => { 
        loadYellow(); 
    })
    
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'app_config', filter: 'id=eq.1' },
        async (payload) => {
            // Update System Config
            if (payload.new.system_config) {
                const loadedConfig = JSON.parse(payload.new.system_config);
                systemConfig = { ...systemConfig, ...loadedConfig }; 
                applyUIRestrictions();
            }
            // Update Address
            if (payload.new.match_address !== undefined) {
                loadMatchAddress();
            }
        }
    )
    .subscribe();
}

(async function init() {
    const storedUsername = localStorage.getItem('chat_username');
    if (storedUsername) {
      document.getElementById('chatNameInput').value = storedUsername;
      document.getElementById('blueChatNameInput').value = storedUsername;
      document.getElementById('yellowChatNameInput').value = storedUsername;
    }

    document.getElementById('chatMsgInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { sendMessage(); } });
    document.getElementById('blueChatMsgInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { sendTeamMessage('blue'); } });
    document.getElementById('yellowChatMsgInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { sendTeamMessage('yellow'); } });

    await loadSystemConfig(); 
    
    // üî¥üî¥üî¥ DISABLED AUTOMATIC DELETION TO PREVENT DATA LOSS üî¥üî¥üî¥
    // await checkAndClearData(); // <--- This line is now disabled permanently.
    
    loadMatchAddress(); 

    if (new Date().getDay() !== 0 || new Date().getHours() < 18) {
        loadPlayers(); 
        loadBlue(); 
        loadYellow(); 
        loadChatMessages();
    }
    setupAddressEditor(); // Still called, but function body is empty/modified
    setupRealtime();
})();
</script>
</body>
</html>
