<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Eternal Brothers FC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* -------------------- 1. GENERAL & BODY STYLES -------------------- */
body { font-family: "Cairo", sans-serif; background-color: #121212; color: #e0e0e0; margin:0; padding:10px; text-align:center; }
.container { display:none; max-width:95%; margin:auto; background:#1e1e1ecc; padding:20px 10px; border-radius:15px; box-shadow:0 0 10px #000; }
h1,h2,h3 { margin:10px 0; }
input[type=text] { padding:8px; width:80%; border-radius:8px; border:1px solid #555; margin:5px 0; background:#2c2c2c; color:#fff; text-align:center; }
button { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:700; }
.formation-controls button { margin: 5px 3px; background: #009688; color: #fff; padding: 8px 12px; font-size: 14px; }
.formation-controls .dynamic-btn { background: #FF9800; font-weight: 700; }

/* -------------------- 2. NAV CONTROLS -------------------- */
.nav-controls { margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; }
.nav-buttons-top { display: flex; flex-direction: row; justify-content: space-between; width: 100%; max-width: 400px; margin-bottom: 5px; }
.nav-buttons-bottom { display: flex; justify-content: space-between; width: 100%; max-width: 400px; gap: 5px; }
#homeBtn, #blueBtn, #yellowBtn, #addressBtn, #arcadeBtn, #kitWashBtn { border-radius: 8px; font-size: 14px; }
#homeBtn { background:#d32f2f; color:#fff; width: 100%; margin: 0 5px; }
#blueBtn { background:#1976d2; color:#fff; width: 100%; margin: 0 5px; }
#yellowBtn { background:#fbc02d; color:#000; width: 100%; margin: 0 5px; }
#addressBtn { background:#9c27b0; color:#fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 2; }
#arcadeBtn { background: #673AB7; color: #fff; flex: 1; }
#kitWashBtn { background: #009688; color: #fff; flex: 1.5; }

.settings-audio-group { display: flex; gap: 5px; flex: 1.5; justify-content: center; }
#audioToggleBtn, #settingsBtn { background: #616161 !important; color: #fff !important; font-size: 14px; padding: 8px 5px !important; width: 50% !important; margin: 0 !important; border-radius: 8px; box-sizing: border-box; }
#settingsBtn { background: #795548 !important; }

/* -------------------- 3. LISTS & PLAYER INFO -------------------- */
ul { list-style:none; padding:0; margin-top:10px; text-align:left; font-weight:bold; }
li { margin:5px 0; padding:6px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; flex-direction: row; min-height: 40px; }
#teamList li { background:#a8e6a1; color:black; }
#waitingList li { background:#ffe0e0; color:black; }
#blueList li { background:rgba(25,118,210,0.7); color:white; }
#yellowList li { background:rgba(251,192,42,0.7); color:#000; }
.player-info { display: flex; flex-direction: row; align-items: center; font-size: 16px; font-weight: bold; }
.player-time { font-size: 12px; font-weight: normal; color: #616161; margin-left: 5px; }
.action-btn { margin-left:6px; border:none; border-radius:5px; padding:4px 8px; cursor:pointer; font-weight:bold; }
.edit-btn { background:#4caf50; color:#fff; }
.delete-btn { background:#e53935; color:#fff; }

/* -------------------- 4. FIELD & MARKER STYLES -------------------- */
.field { width:100%; max-width:400px; height:250px; background:#4CAF50; margin:10px auto; border:2px solid #fff; border-radius:10px; position:relative; touch-action:none; }
.field .center-circle { position:absolute; width:50px;height:50px;border-radius:50%;border:2px solid #fff; top:50%; left:50%; transform:translate(-50%,-50%); }
.field .penalty-box-left, .field .penalty-box-right { position:absolute;width:60px;height:120px;border:2px solid #fff; top:50%; transform:translateY(-50%); }
.field .penalty-box-left { left:0; } .field .penalty-box-right { right:0; }
.field .mid-line { position:absolute; width:0;height:100%;border-left:2px solid #fff; top:0; left:50%; transform:translateX(-50%); }

.player-marker { width:35px; height:35px; border-radius:50%; color:#fff; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:bold; position:absolute; cursor:pointer; user-select:none; border: 2px solid rgba(255, 255, 255, 0.5); touch-action: none; transform: translate(-50%, -50%); z-index: 10; }
.player-name { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 12px; color: black; white-space: nowrap; font-weight: bold; text-shadow: 0 0 2px rgba(0,0,0,0.5); }
.player-position-label { font-size: 13px; font-weight: bold; color: white; }

/* -------------------- 5. CHAT STYLES -------------------- */
.chat-container { width: 100%; max-width: 100%; margin: 20px 0 0 0; background: #242424; border-radius: 10px; padding: 10px; box-shadow: 0 0 5px #000; text-align: left; }
.team-chat-container { background: none; box-shadow: none; margin: 5px 0 0 0; padding: 0; }
#onlineUsersBar { display: flex; flex-wrap: wrap; gap: 8px; padding: 8px; margin-bottom: 10px; background: #1a1a1a; border-radius: 8px; min-height: 25px; border-bottom: 1px solid #333; }
.online-user-pill { background: #333; border-radius: 15px; padding: 4px 10px; font-size: 12px; display: flex; align-items: center; color: #fff; border: 1px solid #555; font-weight: bold; }
.online-dot { width: 8px; height: 8px; background-color: #00e676; border-radius: 50%; margin-left: 6px; box-shadow: 0 0 6px #00e676; animation: blink 2s infinite; }
@keyframes blink { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }
#typingIndicator { font-size: 12px; color: #00e676; height: 18px; margin-top: 5px; margin-bottom: 5px; font-style: italic; padding-left: 5px; font-weight: bold; text-align: right; }
.chat-messages { height: 250px; overflow-y: auto; margin-bottom: 5px; padding: 5px; background: #1e1e1e; border-radius: 5px; display: flex; flex-direction: column; text-align: left; }
#blueChatMessages { background: rgba(25, 118, 210, 0.1); } #yellowChatMessages { background: rgba(251, 192, 42, 0.1); }
.message { margin-bottom: 8px; padding: 8px; padding-right: 25px; border-radius: 10px; background: #333; word-wrap: break-word; max-width: 90%; align-self: flex-start; font-size: 14px; line-height: 1.4; text-align: left; border: 1px solid transparent; color: #e0e0e0; position: relative; }
.my-message { background: #d32f2f; color: #fff; align-self: flex-end; text-align: left; border: 1px solid #d32f2f; }
.delete-msg-btn { position: absolute; top: 5px; right: 5px; background: transparent !important; border: none; color: #ffeb3b; cursor: pointer; font-size: 16px; line-height: 1; font-weight: bold; padding: 2px 5px; }
.delete-msg-btn:hover { color: #fff; background-color: rgba(0,0,0,0.2) !important; border-radius: 50%; }

/* Custom Audio Player */
.custom-audio-player { display: flex; align-items: center; background-color: #f5f5f5; border-radius: 12px; padding: 8px 15px; width: 100%; min-width: 240px; margin-top: 8px; box-sizing: border-box; }
.audio-play-btn { background: none; border: none; color: #333; font-size: 20px; cursor: pointer; margin-right: 15px; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px; }
.audio-time-display { color: #333; font-size: 14px; font-family: monospace; font-weight: bold; flex-grow: 1; text-align: left; }

/* Media */
.chat-media-content { max-width: 220px; max-height: 250px; width: auto; height: auto; border-radius: 8px; margin-top: 5px; display: block; border: 1px solid #555; object-fit: contain; }
.chat-sticker { width: 100px; height: auto; display: block; margin-top: 5px; }

.chat-input-area { display: flex; flex-direction: column; gap: 8px; margin-top: 5px; position: relative; }
.chat-row-inputs { display: flex; gap: 5px; width: 100%; }
.chat-row-tools { display: flex; gap: 5px; justify-content: flex-start; align-items: center; width: 100%; padding: 2px 0; }
#chatNameInput, .chat-row-inputs input[type=text]:first-child { width: 25%; text-align: center; }
#chatMsgInput, .chat-row-inputs input[type=text]:nth-child(2) { flex-grow: 1; text-align: left; }
#sendChatBtn, .send-btn { background: #d32f2f; color: #fff; padding: 0 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
.tool-btn { background: #424242; color: #fff; padding: 5px 8px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; min-width: 30px; }
.tool-btn:active { background: #616161; }
.sticker-btn { background: #FF9800 !important; } 
.radio-btn { background: #9C27B0 !important; }
.team-add-custom { background: #009688 !important; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1; font-size: 10px; font-weight: bold; padding: 3px 6px; min-width: 35px; }
.team-dots { display: flex; gap: 3px; margin-top: 2px; }
.dot { width: 7px; height: 7px; border-radius: 50%; border: 1px solid #fff; } .dot-b { background: #2196F3; } .dot-y { background: #FFEB3B; }

/* RECORDING UI */
.recording-overlay { display: none; width: 100%; height: 50px; background: #2c2c2c; border-radius: 10px; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; position: absolute; bottom: 0; left: 0; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.5); }
.recording-text { color: #ff1744; font-weight: bold; font-size: 16px; flex-grow: 1; text-align: center; animation: pulseText 1.5s infinite; }
@keyframes pulseText { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }
.rec-action-btn { background: transparent; border: none; cursor: pointer; font-size: 20px; padding: 5px 10px; }
.rec-send-btn { color: #FFD700; font-size: 24px; } 
.rec-trash-btn { color: #ccc; font-size: 22px; } .rec-trash-btn:hover { color: #ff1744; }

.sticker-popup { position: absolute; bottom: 60px; left: 0; right: 0; margin: auto; background: #2c2c2c; border: 1px solid #555; border-radius: 10px; width: 90%; max-width: 280px; height: 200px; display: none; flex-direction: column; z-index: 2500; box-shadow: 0 -2px 15px rgba(0,0,0,0.7); }
.sticker-tabs { display: flex; justify-content: space-between; background: #1e1e1e; border-radius: 10px 10px 0 0; padding: 5px; }
.sticker-tab { background: none; border: none; color: #aaa; font-size: 11px; padding: 5px; cursor: pointer; flex: 1; }
.sticker-tab.active { color: #fff; border-bottom: 2px solid #FF9800; }
.sticker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; padding: 5px; overflow-y: auto; height: 100%; }
.sticker-item { width: 100%; height: auto; cursor: pointer; border-radius: 5px; }
.sticker-item:hover { transform: scale(1.1); }

#radioPlayerSection { display: none; position: absolute; bottom: 60px; left: 0; right: 0; margin: auto; width: 90%; max-width: 300px; background: #333; border-radius: 8px; padding: 10px; border: 1px solid #9C27B0; z-index: 2600; box-shadow: 0 -2px 15px #000; }
#radioSelect { width: 100%; padding: 8px; background: #1e1e1e; color: #fff; border: 1px solid #555; border-radius: 5px; margin-bottom: 8px; }
.radio-controls { display: flex; justify-content: space-between; gap: 5px; }
.radio-control-btn { flex: 1; padding: 8px; background: #009688; color: #fff; border-radius: 5px; border: none; cursor: pointer; }
.stop-btn { background: #d32f2f; }

/* --- SMART TEAM MAKER STYLES --- */
.tm-container {
    border: 1px solid #FFD700;
    padding: 10px;
    border-radius: 8px;
    margin-top: 15px;
    background: #252525;
    margin-bottom: 15px; /* Added spacing */
}
.tm-header {
    margin-top: 0;
    color: #FFD700;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
}
.tm-player-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #333;
    margin-bottom: 5px;
    padding: 6px 8px;
    border-radius: 5px;
    border-left: 3px solid #777;
}
.tm-name {
    flex: 2;
    font-size: 13px;
    font-weight: bold;
    color: #e0e0e0;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.tm-controls {
    display: flex;
    gap: 5px;
}
.tm-select {
    background: #111;
    color: #fff;
    border: 1px solid #555;
    border-radius: 4px;
    padding: 4px;
    font-size: 11px;
    cursor: pointer;
}
.tm-select:focus { border-color: #FFD700; outline: none; }
.tm-rating { width: 45px; text-align: center; font-weight: bold; color: #FF9800; }
.tm-pos { width: 65px; }

/* -------------------- 6. MODALS STYLES -------------------- */
.position-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
.position-menu-box { background-color: #2c2c2c; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); width: 90%; max-width: 350px; text-align: center; }
.position-menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
.position-menu-grid button { padding: 12px 5px; font-size: 14px; background-color: #444; color: #fff; border-radius: 6px; transition: background-color 0.2s; }
.position-menu-grid button:hover { background-color: #d32f2f; }

.settings-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 10px; }
.settings-modal-content { background-color: #1e1e1e; padding: 25px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.8); width: 95%; max-width: 450px; text-align: left; color: #fff; display: flex; flex-direction: column; max-height: 90vh; }
.settings-modal-content h2 { text-align: center; color: #d32f2f; margin-bottom: 20px; flex-shrink: 0; }
.setting-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #333; }
.setting-item:last-child { border-bottom: none; }
.setting-item input[type="checkbox"] { transform: scale(1.5); cursor: pointer; }
.password-input-group { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 20px; }
.password-input-group input[type="password"] { width: 70%; text-align: center; font-size: 16px; }
.settings-options-container { overflow-y: auto; padding: 10px; border: 1px solid #333; border-radius: 8px; margin-bottom: 15px; flex-grow: 1; }
.settings-footer { text-align: center; margin-top: 0; flex-shrink: 0; padding-top: 15px; border-top: 1px solid #333; }
#saveSettingsBtn { background: #1976d2; color: #fff; width: 100%; padding: 12px; }

.danger-zone { margin-top: 20px; padding-top: 10px; border-top: 1px solid #555; }
.danger-zone h2 { color: #ffeb3b; text-align: center; font-size: 18px; }
.danger-btn { background-color: #d32f2f; color: #fff; width: 100%; padding: 10px; margin-top: 8px; font-size: 14px; }
.danger-btn:hover { background-color: #e57373; }
#matchAddressInput { width: 100%; text-align: left; margin-top: 5px; margin-bottom: 15px; }

.mini-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 2500; }
.mini-modal-box { background: #2c2c2c; padding: 20px; border-radius: 10px; width: 85%; max-width: 300px; text-align: center; border: 1px solid #555; box-shadow: 0 4px 15px #000; }
.mini-modal-box input { width: 90% !important; margin-bottom: 15px; }
.team-select-btns { display: flex; justify-content: space-around; gap: 10px; }

/* ---- JAR VISUAL STYLES ---- */
#washModalOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; justify-content:center; align-items:center; z-index:3000; flex-direction:column; }
.jar-container { position: relative; width: 200px; height: 250px; margin-bottom: 20px; }
.jar { 
    width: 100%; height: 100%; 
    background: rgba(255, 255, 255, 0.1); 
    border: 4px solid rgba(255,255,255,0.5); 
    border-radius: 15px; 
    border-top: none;
    position: relative; 
    overflow: hidden; 
    backdrop-filter: blur(2px);
    box-shadow: inset 0 0 20px rgba(255,255,255,0.2);
}
.jar::before { 
    content:''; position:absolute; top:-15px; left:10%; width:80%; height:15px; 
    border: 4px solid rgba(255,255,255,0.5); border-bottom:none; border-radius: 5px 5px 0 0;
}
.paper-slip {
    position: absolute;
    width: 40px; height: 30px;
    background: #fff;
    box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    display: flex; justify-content: center; align-items: center;
    font-size: 8px; color: #000; overflow: hidden;
    transition: all 0.2s;
}
.paper-slip.folded { width: 20px; height: 20px; background: #e0e0e0; border-radius: 2px; }
@keyframes shakeJar {
  0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); }
  50% { transform: rotate(0deg); } 75% { transform: rotate(-5deg); }
  100% { transform: rotate(0deg); }
}
.shaking { animation: shakeJar 0.1s infinite; }
#resultCard { 
    background: #fff; color:#000; padding: 20px; border-radius: 10px; text-align: center; 
    display: none; flex-direction: column; gap: 10px; animation: popIn 0.5s; 
    min-width: 250px;
}
@keyframes popIn { 0%{transform:scale(0);} 100%{transform:scale(1);} }
.wash-btn-group { display:flex; gap:10px; justify-content:center; }

/* --- LAUNDRY HISTORY --- */
#laundryHistoryContainer {
    margin-top: 10px;
    padding: 10px;
    background: #2c2c2c;
    border-radius: 8px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
    text-align: left;
    display: none; /* Hidden by default */
}
#laundryHistoryContainer h3 { margin-top: 0; color: #009688; display:flex; align-items:center; justify-content:space-between;}
#laundryList { padding: 0; margin: 0; list-style: none; }
#laundryList li {
    background: #333;
    border-bottom: 1px solid #444;
    padding: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 4px;
    margin-bottom: 4px;
}
#kitWashBtn { background: #009688; color: #fff; width: 100%; margin: 0; }
</style>
</head>
<body>

<audio id="musicPlayer" loop preload="auto"><source src="https://raw.githubusercontent.com/ahmadalshaear/eternal-brothers-audio/main/Eternal_Brothers%20_FC_new.mp3" type="audio/mp3"></audio>
<audio id="radioStreamPlayer" preload="none"></audio>
<audio id="notification-sound" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2346/2346-preview.mp3" type="audio/mp3"></audio>


<div id="toastContainer"></div> 

<div class="nav-controls">
  <div class="nav-buttons-top">
    <button id="blueBtn" onclick="showSection('blue')">Blue Team</button>
    <button id="homeBtn" onclick="showSection('main')">Home</button>
    <button id="yellowBtn" onclick="showSection('yellow')">Yellow Team</button>
  </div>
  <div class="nav-buttons-bottom">
    <button id="addressBtn" onclick="openGoogleMaps()">Address üìç</button> 
    <button id="arcadeBtn" onclick="openGameCenter()">Games üéÆ</button>
    <div class="settings-audio-group">
        <button id="audioToggleBtn" onclick="toggleBackgroundMusic()">Audio</button>
        <button id="settingsBtn" onclick="showSettingsModal()">‚öô</button> 
    </div>
  </div>
</div>

<div id="main" class="container">
  <h1 style="margin-top:0; font-size:28px; display:flex; align-items:center; justify-content:center; gap:8px;">
    ‚öΩ <span style="color:#1976d2;">Eternal</span> <span style="color:#fbc02d;">Brothers</span> ‚öΩ
  </h1>
<p id="gameTimeDisplay" style="margin:5px 0; font-weight:bold; color:#fb8c00; font-size:16px;">The Game will be on Sunday at 9:40AM</p>


  <div id="playerManagement">
    <h2>Add Player</h2>
    <input type="text" id="nameInput" placeholder="Enter player name">
    <button id="addPlayerBtn" onclick="addPlayer()">Add</button>
  </div>

  <h2>Main Team (24 max)</h2>
  <ul id="teamList"></ul>

  <h2>Waiting List</h2>
  <ul id="waitingList"></ul>
  
  <button onclick="loadSystemHistory()" style="background:#6a1b9a; color:#fff; margin-top:15px; width:80%;">Show Join/Leave History</button>
  <div id="systemHistoryContainer" style="margin-top:10px; padding:10px; background:#2c2c2c; border-radius:8px; max-width: 400px; margin-left: auto; margin-right: auto; text-align:left; display:none;">
      <h3 style="margin-top:0;">Event History</h3>
      <ul id="historyList" style="text-align:left; font-weight:normal; font-size:14px; color:#ccc;"></ul>
  </div>


  <div id="kitWashSection">
      <div style="width: 80%; margin: 15px auto; max-width: 400px;">
          <hr style="border-color: #444; margin-bottom: 15px;">
          <button id="kitWashBtn" onclick="openWashModal()">Kit Wash üßº</button>
      </div>
      
      <button id="showLaundryHistoryBtn" onclick="loadLaundryHistory()" style="background:#009688; color:#fff; margin-top:5px; width:80%;">Show Laundry History üßº</button>
      
      <div id="laundryHistoryContainer">
          <h3>üßº Laundry Log</h3>
          <ul id="laundryList"></ul>
      </div>
  </div>

  <button onclick="loadUserLogs()" style="background:#455A64; color:#fff; margin-top:5px; width:80%;">Show Activity Log üïí</button>

<div id="userLogContainer" style="margin-top:10px; padding:10px; background:#2c2c2c; border-radius:8px; max-width: 400px; margin-left: auto; margin-right: auto; text-align:left; display:none;">
    <h3 style="margin-top:0; color:#90a4ae; border-bottom: 1px solid #555; padding-bottom: 5px; display:flex; justify-content:space-between; align-items:center;">
        User Status 
        <span style="font-size:11px; color:#00e676; border:1px solid #00e676; padding:2px 5px; border-radius:4px;">Live Updates</span>
    </h3>
    <ul id="userLogList" style="text-align:left; font-weight:normal; font-size:14px; color:#ccc; max-height: 250px; overflow-y: auto; padding-right: 5px;"></ul>
</div>

  <div class="chat-container">
    <h2>Group Chat</h2>
    <div id="onlineUsersBar"></div>
    <div id="chatMessages" class="chat-messages"></div>
    <div id="typingIndicator"></div>
    
    <div class="chat-input-area">
        <div id="recordingBar_global" class="recording-overlay">
            <button class="rec-action-btn rec-send-btn" onclick="finishVoiceRecording('global', 'send')">‚û§</button>
            <span class="recording-text">Recording...</span>
            <button class="rec-action-btn rec-trash-btn" onclick="finishVoiceRecording('global', 'cancel')">üóëÔ∏è</button>
        </div>
        <div class="chat-row-inputs">
            <input type="text" id="chatNameInput" placeholder="Name" value="">
            <input type="text" id="chatMsgInput" placeholder="Type a message..." oninput="handleTyping('global')">
            <button id="sendChatBtn" class="send-btn" onclick="sendMessage()">Send</button>
        </div>
        <div class="chat-row-tools">
            <input type="file" id="globalChatFile" accept="image/*,video/*" style="display:none" onchange="handleFileUpload(this, 'global')">
            <button class="tool-btn" onclick="document.getElementById('globalChatFile').click()" title="Upload">üì∑</button>
            <button id="recordBtnGlobal" class="tool-btn record-btn" style="margin-left:5px;" onmousedown="startVoiceRecording('global')" title="Record">üé§</button>
            <button class="tool-btn sticker-btn" style="margin-left:5px;" onclick="toggleStickerMenu('global')" title="Stickers">‚ò∫</button>
            <button class="tool-btn team-add-custom" style="margin-left:5px;" onclick="openTeamAddModal()" title="Add to Team"><span>Add</span><div class="team-dots"><span class="dot dot-b"></span><span class="dot dot-y"></span></div></button>
            <button class="tool-btn radio-btn" style="margin-left:5px;" onclick="toggleRadio()" title="Radio">üìª</button>
        </div>
        
                    <div id="radioPlayerSection">
            <select id="radioSelect" onchange="changeRadioChannel()">
                <optgroup label="Quran">
                    <option value="https://server8.mp3quran.net/afs/001.mp3">Mishary Alafasy</option>
                    <option value="https://server7.mp3quran.net/basit/001.mp3">Abdulbasit Abdulsamad</option>
                </optgroup>
                <optgroup label="News & Talk">
                    <option value="https://live-hls-web-aja.getaj.net/AJA/01.m3u8">Al Jazeera Arabic</option>
                </optgroup>
                <optgroup label="Music (FM)">
                    <option value="https://stream.rotana.net/rotana_radio/rotana_fm_ksa/playlist.m3u8">Rotana FM (KSA)</option>
                    <option value="https://media-ice.musicradio.com/CapitalMP3">Capital FM (London Hits)</option>
                </optgroup>
            </select>
            <div class="radio-controls">
                <button class="radio-control-btn" onclick="playRadio()">‚ñ∂ Play</button>
                <button class="radio-control-btn stop-btn" onclick="stopRadio()">‚èπ Stop</button>
            </div>
        </div>

        <div id="stickerPopupGlobal" class="sticker-popup">
            <div class="sticker-tabs">
                <button class="sticker-tab active" onclick="showStickerTab('global', 'football')">Football</button>
                <button class="sticker-tab" onclick="showStickerTab('global', 'funny')">Funny</button>
                <button class="sticker-tab" onclick="showStickerTab('global', 'action')">Action</button>
            </div>
            <div id="stickerGridGlobal" class="sticker-grid"></div>
        </div>
    </div>
  </div>
</div>

<div id="blue" class="container" style="background:#1565c0aa;">
  <h2>Blue Team</h2>
  <div id="bluePlayerManagement">
    <input type="text" id="blueInput" placeholder="Enter player name">
    <button id="addBlueBtn" onclick="addBlue()">Add</button>
  </div>
  <ul id="blueList"></ul>
  <div class="formation-controls">
    <button class="formation-btn" onclick="applyFormation('blue', '4-3-3')">4-3-3</button>
    <button class="formation-btn" onclick="applyFormation('blue', '4-4-2')">4-4-2</button>
    <button class="formation-btn" onclick="applyFormation('blue', '3-4-3')">3-4-3</button>
    <button id="blueDynamicBtn" class="dynamic-btn" onclick="applyDynamicPlan('blue')">Apply Dynamic Plan</button>
  </div>
  <h3>Plan</h3>
  <div id="bluePlan" class="field">
    <div class="mid-line"></div><div class="center-circle"></div><div class="penalty-box-left"></div><div class="penalty-box-right"></div>
  </div>
  <div class="chat-container team-chat-container">
    <h3>Blue Team Chat üó©</h3>
    <div id="blueChatMessages" class="chat-messages"></div>
    <div class="chat-input-area">
        <div id="recordingBar_blue" class="recording-overlay">
            <button class="rec-action-btn rec-send-btn" onclick="finishVoiceRecording('blue', 'send')">‚û§</button>
            <span class="recording-text">Recording...</span>
            <button class="rec-action-btn rec-trash-btn" onclick="finishVoiceRecording('blue', 'cancel')">üóëÔ∏è</button>
        </div>
        <div class="chat-row-inputs">
            <input type="text" id="blueChatNameInput" placeholder="Name" value="">
            <input type="text" id="blueChatMsgInput" placeholder="Message...">
            <button id="sendBlueChatBtn" class="send-btn" onclick="sendTeamMessage('blue')">Send</button>
        </div>
        <div class="chat-row-tools">
            <input type="file" id="blueChatFile" accept="image/*,video/*" style="display:none" onchange="handleFileUpload(this, 'blue')">
            <button class="tool-btn" onclick="document.getElementById('blueChatFile').click()">üì∑</button>
            <button id="recordBtnBlue" class="tool-btn record-btn" style="margin-left:5px;" onmousedown="startVoiceRecording('blue')" onmouseup="stopVoiceRecording('blue')" ontouchstart="startVoiceRecording('blue')" ontouchend="stopVoiceRecording('blue')">üé§</button>
            <button class="tool-btn sticker-btn" style="margin-left:5px;" onclick="toggleStickerMenu('blue')">‚ò∫</button>
        </div>
        <div id="stickerPopupBlue" class="sticker-popup">
            <div class="sticker-tabs">
                <button class="sticker-tab active" onclick="showStickerTab('blue', 'football')">Football</button>
            </div>
            <div id="stickerGridBlue" class="sticker-grid"></div>
        </div>
    </div>
  </div>
</div>

<div id="yellow" class="container" style="background:#fdd835aa; color:#000;">
  <h2>Yellow Team</h2>
  <div id="yellowPlayerManagement">
    <input type="text" id="yellowInput" placeholder="Enter player name">
    <button id="addYellowBtn" onclick="addYellow()">Add</button>
  </div>
  <ul id="yellowList"></ul>
  <div class="formation-controls">
    <button class="formation-btn" onclick="applyFormation('yellow', '4-3-3')">4-3-3</button>
    <button class="formation-btn" onclick="applyFormation('yellow', '4-4-2')">4-4-2</button>
    <button class="formation-btn" onclick="applyFormation('yellow', '3-4-3')">3-4-3</button>
    <button id="yellowDynamicBtn" class="dynamic-btn" onclick="applyDynamicPlan('yellow')">Apply Dynamic Plan</button>
  </div>
  <h3>Plan</h3>
  <div id="yellowPlan" class="field">
    <div class="mid-line"></div><div class="center-circle"></div><div class="penalty-box-left"></div><div class="penalty-box-right"></div>
  </div>
  <div class="chat-container team-chat-container">
    <h3 style="color: #000;">Yellow Team Chat üó©</h3>
    <div id="yellowChatMessages" class="chat-messages"></div>
    <div class="chat-input-area">
        <div id="recordingBar_yellow" class="recording-overlay">
            <button class="rec-action-btn rec-send-btn" onclick="finishVoiceRecording('yellow', 'send')">‚û§</button>
            <span class="recording-text">Recording...</span>
            <button class="rec-action-btn rec-trash-btn" onclick="finishVoiceRecording('yellow', 'cancel')">üóëÔ∏è</button>
        </div>
        <div class="chat-row-inputs">
            <input type="text" id="yellowChatNameInput" placeholder="Name" value="">
            <input type="text" id="yellowChatMsgInput" placeholder="Message...">
            <button id="sendYellowChatBtn" class="send-btn" onclick="sendTeamMessage('yellow')">Send</button>
        </div>
        <div class="chat-row-tools">
            <input type="file" id="yellowChatFile" accept="image/*,video/*" style="display:none" onchange="handleFileUpload(this, 'yellow')">
            <button class="tool-btn" onclick="document.getElementById('yellowChatFile').click()">üì∑</button>
            <button id="recordBtnYellow" class="tool-btn record-btn" style="margin-left:5px;" onmousedown="startVoiceRecording('yellow')" onmouseup="stopVoiceRecording('yellow')" ontouchstart="startVoiceRecording('yellow')" ontouchend="stopVoiceRecording('yellow')">üé§</button>
            <button class="tool-btn sticker-btn" style="margin-left:5px;" onclick="toggleStickerMenu('yellow')">‚ò∫</button>
        </div>
        <div id="stickerPopupYellow" class="sticker-popup">
            <div class="sticker-tabs">
                <button class="sticker-tab active" onclick="showStickerTab('yellow', 'football')">Football</button>
            </div>
            <div id="stickerGridYellow" class="sticker-grid"></div>
        </div>
    </div>
  </div>
</div>

<div id="washModalOverlay">
    <div class="jar-container">
        <div class="jar" id="jar"></div>
    </div>
    <button onclick="shakeJar()" style="background:#ffeb3b; color:#000; font-weight:bold; padding:10px 30px; border-radius:20px; z-index:3002;">üîÄ Shake!</button>
    <button onclick="closeWashModal()" style="margin-top:10px; background:transparent; border:1px solid #fff; color:#fff;">Close</button>
    
    <div id="resultCard">
        <h3>The Kit Wash Volunteer will be:</h3>
        <h1 id="winnerName" style="color:#d32f2f; margin:10px 0;"></h1>
        <div class="wash-btn-group">
            <button onclick="confirmWashWinner()" style="background:#4CAF50; color:#fff;">Confirm</button>
            <button onclick="volunteerInstead()" style="background:#2196F3; color:#fff;">Volunteer Instead üôã‚Äç‚ôÇÔ∏è</button>
        </div>
    </div>
</div>

<div id="positionMenuOverlay" class="position-menu-overlay" style="display:none;">
    <div class="position-menu-box">
        <h3 id="positionMenuTitle">Select Position for Player Name</h3>
        <div id="positionMenuGrid" class="position-menu-grid">
            </div>
        <button onclick="closePositionMenu()" style="margin-top: 15px; background: #555;">Cancel</button>
    </div>
</div>

<div id="settingsModalOverlay" class="settings-modal-overlay">
    <div class="settings-modal-content">
        <div id="passwordSection">
            <h2>Admin Settings</h2>
            <div class="password-input-group">
                <input type="password" id="settingsPassword" placeholder="Password">
                <button onclick="authenticateSettings()" style="background: #d32f2f; color: #fff; width: 70%;">Enter</button>
                <p id="passwordError" style="color: #ffeb3b; display: none; margin: 5px 0;">Incorrect password.</p>
            </div>
        </div>
        <div id="settingsControls" style="display:none; flex-grow: 1; display: flex; flex-direction: column; min-height: 0;">
            <div class="settings-options-container">
                
                <div class="tm-container">
                    <h3 class="tm-header">‚öñÔ∏è Smart Team Maker (The Sheikh)</h3>
                    <p style="font-size:11px; color:#aaa; margin-bottom:10px;">
                        Assign hidden roles & ratings, then auto-balance.
                    </p>

                    <button onclick="loadTeamMakerUI()" style="background:#424242; color:#fff; width:100%; margin-bottom:10px; border:1px solid #777;">
                        üîÑ Load Main List Players
                    </button>
                    
                    <div id="teamMakerList" style="max-height: 250px; overflow-y: auto; margin-bottom: 12px; padding-right:2px; border-top: 1px solid #444; padding-top: 5px;">
                        <p style="text-align:center; color:#555; font-size:12px;">Click 'Load' to start...</p>
                    </div>

                    <div style="display:flex; gap:5px;">
                        <button onclick="generateBalancedTeams()" style="background: linear-gradient(135deg, #1e88e5, #fdd835); color: #000; font-weight:bold; flex:1; padding: 12px; border: 2px solid #fff;">
                            ‚ö° Create Balanced Teams
                        </button>
                    </div>
                </div>

                <div style="border: 1px solid #009688; padding: 10px; border-radius: 8px; margin-bottom: 15px; background: #202020;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin-top:0; color:#009688;">üïµÔ∏è Multi-Add Monitor</h3>
                        <button onclick="toggleMultiAdd()" style="background:#333; color:#fff; padding:5px 10px; font-size:11px;">Show/Hide</button>
                    </div>
                    <p style="font-size:11px; color:#aaa;">Tracks who added whom to the Main Team.</p>
                    <ul id="multiAddList" style="list-style:none; padding:0; margin:0; display:none; max-height:200px; overflow-y:auto;">
                        </ul>
                </div>

                <div style="border: 1px solid #444; padding: 10px; border-radius: 8px; margin-bottom: 15px; background: #252525;">
                    <h3 style="margin-top:0; color:#00e676;">‚è≥ Auto-Add Players</h3>
                    <p style="font-size:12px; color:#aaa;">Schedule players to join Main Team automatically.</p>
                    
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input type="text" id="autoNameInput" placeholder="Player Name" style="flex:2; text-align:center;">
                        <input type="time" id="autoTimeInput" style="flex:1; background:#333; color:#fff; border:1px solid #555; border-radius:5px;">
                        <button onclick="addScheduledPlayer()" style="background:#009688; color:#fff; font-weight:bold;">+</button>
                    </div>

                    <ul id="scheduledPlayersList" style="list-style:none; padding:0; margin:0;">
                        </ul>
                </div>
                <h2>Match Details</h2>
                <label for="matchAddressInput" style="font-weight: bold; display: block; margin-bottom: 5px;">Match Address (Google Maps)</label>
                <input type="text" id="matchAddressInput" placeholder="Enter full match address or coordinates">
                <label for="gameTimeInput" style="font-weight: bold; display: block; margin-top: 10px; margin-bottom: 5px;">Game Time Text ‚è∞</label>
<input type="text" id="gameTimeInput" placeholder="Ex: Sunday at 9:00 PM" style="width: 100%; text-align: left; margin-bottom: 15px;">
                <h2>System Options</h2>
                <div class="setting-item"><label for="allowPlayerEdit">Allow Player Add/Edit/Delete (Main Lists)</label><input type="checkbox" id="allowPlayerEdit"></div>
                <div class="setting-item"><label for="allowTeamEdit">Allow Player Add/Edit/Delete (Teams)</label><input type="checkbox" id="allowTeamEdit"></div>
                <div class="setting-item"><label for="allowFormationEdit">Allow Applying Formations (Plan)</label><input type="checkbox" id="allowFormationEdit"></div>
                <div class="setting-item"><label for="allowChat">Allow Sending Chat Messages</label><input type="checkbox" id="allowChat"></div>
                <div class="setting-item"><label for="enforceTimeRestriction">Enforce Time Restriction (Wed-Sun)</label><input type="checkbox" id="enforceTimeRestriction"></div>
                <div class="setting-item"><label for="disableMainListPin" style="color:#00e676;">Disable PIN for Main List (No PIN)</label><input type="checkbox" id="disableMainListPin"></div>
                
                <div class="setting-item"><label for="hideLaundrySection" style="color:#ff9800;">Hide Kit Wash & Laundry History</label><input type="checkbox" id="hideLaundrySection"></div>

                
                <div class="danger-zone">
    <h2>Danger Zone - Data Deletion</h2>

    <h4 style="margin: 10px 0 5px; color: #aaa; text-align:center; border-bottom:1px solid #444; padding-bottom:5px;">üìú History Logs</h4>
    
    <button class="danger-btn" style="background-color: #9c27b0; color: #fff;" onclick="clearSystemHistory()">Clear System History (Alerts)</button>
    
    <button class="danger-btn" style="background-color: #009688; color: #fff;" onclick="clearLaundryHistory()">Clear Laundry History üßº</button>


    <h4 style="margin: 15px 0 5px; color: #aaa; text-align:center; border-bottom:1px solid #444; padding-bottom:5px;">üí¨ Clear Chats</h4>
    
    <button class="danger-btn" style="background-color: #d32f2f; color: #fff;" onclick="clearGroupChat()">Clear Group Chat (Global)</button>
    <button class="danger-btn" style="background-color: #1565c0; color: #fff;" onclick="clearBlueChat()">Clear Blue Team Chat üîµ</button>
    <button class="danger-btn" style="background-color: #fdd835; color: #000;" onclick="clearYellowChat()">Clear Yellow Team Chat üü°</button>


    <h4 style="margin: 15px 0 5px; color: #aaa; text-align:center; border-bottom:1px solid #444; padding-bottom:5px;">üìã Clear Lists</h4>
    
    <button class="danger-btn" style="background-color: #d32f2f; color: #fff;" onclick="clearMainTeam()">Clear Main Team List</button>
    <button class="danger-btn" style="background-color: #d32f2f; color: #fff;" onclick="clearWaitingList()">Clear Waiting List</button>
    <button class="danger-btn" style="background-color: #1565c0; color: #fff;" onclick="clearBlueTeam()">Clear Blue Team List üîµ</button>
    <button class="danger-btn" style="background-color: #fdd835; color: #000;" onclick="clearYellowTeam()">Clear Yellow Team List üü°</button>
</div>
            </div> 
            <div class="settings-footer"><button id="saveSettingsBtn" onclick="saveSettings()">Save & Close</button></div>
        </div>
    </div>
</div>

<div id="teamAddModalOverlay" class="mini-modal-overlay">
    <div class="mini-modal-box">
        <h3 style="color:#fff; margin-top:0;">Add Player to Team</h3>
        <p style="font-size:12px; color:#ccc;">Select from Main List</p>
        
        <select id="chatTeamAddSelect" style="width: 100%; padding: 12px; margin-bottom: 15px; background: #1e1e1e; color: #fff; border: 1px solid #555; border-radius: 8px; text-align: center; font-size: 16px;">
            <option value="">Loading...</option>
        </select>

        <div class="team-select-btns">
            <button onclick="confirmAddToTeam('blue')" style="background:#1565c0; color:#fff; flex:1; padding: 10px; border-radius: 6px; font-weight: bold;">To Blue üîµ</button>
            <button onclick="confirmAddToTeam('yellow')" style="background:#fdd835; color:#000; flex:1; padding: 10px; border-radius: 6px; font-weight: bold;">To Yellow üü°</button>
        </div>
        <button onclick="closeTeamAddModal()" style="background:#555; color:#fff; margin-top:10px; width:100%; padding: 8px;">Cancel</button>
    </div>
</div>


<div id="gameCenterOverlay" class="mini-modal-overlay">
    <div class="mini-modal-box" style="max-width: 360px; background: #222; border: 2px solid #673AB7; overflow-y:auto; max-height:80vh;">
        <h3 style="color:#fff; margin-top:0; font-family: 'Courier New', monospace;">üïπÔ∏è ETERNAL ARCADE üïπÔ∏è</h3>
        <div id="gameMenu">
            <p style="color:#ccc; font-size:12px;">Select a Game:</p>
            <button onclick="startGame('juggling')" style="background:linear-gradient(45deg, #FF9800, #F57C00); width:100%; margin-bottom:8px; padding:12px; font-weight:bold; border:2px solid #fff;">‚öΩ Keepy Uppy</button>
            <button onclick="startGame('flappy')" style="background:linear-gradient(45deg, #2196F3, #1976D2); width:100%; margin-bottom:8px; padding:12px; font-weight:bold; border:2px solid #fff;">üöÄ Flappy Ball</button>
            <button onclick="startGame('penalty')" style="background:linear-gradient(45deg, #4CAF50, #388E3C); width:100%; margin-bottom:8px; padding:12px; font-weight:bold; border:2px solid #fff;">ü•Ö Penalty Rush</button>
            <button onclick="startGame('dribbler')" style="background:linear-gradient(45deg, #9C27B0, #673AB7); width:100%; margin-bottom:8px; padding:12px; font-weight:bold; border:2px solid #fff;">üèÉ Dribble Challenge</button>
            <button onclick="startGame('keeper')" style="background:linear-gradient(45deg, #607D8B, #455A64); width:100%; margin-bottom:8px; padding:12px; font-weight:bold; border:2px solid #fff;">üß§ Goalkeeper Hero</button>
        </div>
        <div id="gameArea" style="display:none; position:relative;">
            <canvas id="gameCanvas" width="320" height="400" style="background:#333; border-radius:8px; cursor:pointer; box-shadow: 0 0 15px rgba(103, 58, 183, 0.5);"></canvas>
            <div id="scoreDisplay" style="position:absolute; top:10px; left:10px; color:#fff; font-size:20px; font-weight:bold; pointer-events:none; text-shadow: 2px 2px #000;">Score: 0</div>
            <div id="startPrompt" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; font-weight:bold; pointer-events:none; text-align:center; text-shadow: 2px 2px #000; background:rgba(0,0,0,0.5); padding:10px; border-radius:5px;">Tap to Start!</div>
            <button onclick="exitGame()" style="background:#d32f2f; margin-top:5px; width:100%;">Exit to Menu</button>
        </div>
        <div id="leaderboardSection" style="margin-top:15px; border-top:1px solid #555; padding-top:10px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4 style="color:#FFD700; margin:5px 0;">üèÜ High Scores</h4>
                <select id="lbGameSelector" onchange="loadLeaderboard(this.value)" style="background:#333; color:#fff; border:1px solid #555; font-size:12px;">
                    <option value="juggling">Keepy Uppy</option>
                    <option value="flappy">Flappy Ball</option>
                    <option value="penalty">Penalty Rush</option>
                    <option value="dribbler">Dribbler</option>
                    <option value="keeper">Keeper</option>
                </select>
            </div>
            <ul id="leaderboardList" style="font-size:12px; max-height:100px; overflow-y:auto; text-align:left; padding:5px; background:#111; border-radius:5px;">
                <li style="color:#aaa;">Loading...</li>
            </ul>
        </div>
        <button onclick="closeGameCenter()" id="closeGameBtn" style="background:#555; color:#fff; margin-top:10px; width:100%;">Close Arcade</button>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
<script>
// -------------------- GLOBAL CONFIG --------------------
const supabaseUrl = "https://wihhlvgkjglphjzhivdn.supabase.co"; 
const supabaseServiceKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndpaGhsdmdramdscGhqemhpdmRuIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Mjk0MzA5NiwiZXhwIjoyMDc4NTE5MDk2fQ.qVT2CKqMKRW1Y1qEox9_cl4JvuLY659_UQxVDMBWBFA"; 
const supabase = window.supabase.createClient(supabaseUrl, supabaseServiceKey);

// Declare globals BEFORE usage in functions
let currentPositionTarget = { team: null, playerId: null, playerName: null };
const nameColors = ["#e53935", "#1e88e5", "#fbc02d","#43a047","#8e24aa","#fb8c00","#00acc1","#d81b60","#6d4c41","#3949ab","#f4511e","#7cb342"];
let audioInitialized = false; 
let matchAddress = "Address üìç"; 
const ADMIN_PASSWORD = "2023"; 
const TEAM_ADD_PIN = "1111"; 
let mediaRecorder = null; let audioChunks = []; let isRecording = false;
let audioStream = null; 
let typingTimeout;
let roomChannel;
const myId = Math.random().toString(36).substr(2, 9);

const STICKERS = {
    football: ["https://media.giphy.com/media/xT9IgG50Fb7Mi0prBC/giphy.gif", "https://media.giphy.com/media/3o6vXNLzXdW4sbFRGo/giphy.gif", "https://media.giphy.com/media/l2JHZKNio4EjY6iqY/giphy.gif"],
    funny: ["https://media.giphy.com/media/10JhviFuU2gWD6/giphy.gif", "https://media.giphy.com/media/3oEjHAUOqG3lSS0f1C/giphy.gif", "https://media.giphy.com/media/26tP3M3i03qgDnhGU/giphy.gif"],
    action: ["https://media.giphy.com/media/3o7TKtnuHOHHUjR38Y/giphy.gif", "https://media.giphy.com/media/l0Iy8hSJalxlbkXIk/giphy.gif", "https://media.giphy.com/media/l41lS23ZZKo8hiiZ2/giphy.gif"]
};

let systemConfig = { allowPlayerEdit: true, allowTeamEdit: true, allowFormationEdit: true, allowChat: true, enforceTimeRestriction: true, disableMainListPin: false, hideLaundrySection: false };
const POSITIONS_LIST = [{ code: 'GK', label: 'Goalkeeper' }, { code: 'CB', label: 'Center Back' }, { code: 'RB', label: 'Right Back' }, { code: 'LB', label: 'Left Back' }, { code: 'DM', label: 'Defensive Mid' }, { code: 'CM', label: 'Center Mid' }, { code: 'RM', label: 'Right Mid' }, { code: 'LM', label: 'Left Mid' }, { code: 'CAM', label: 'Attacking Mid' }, { code: 'CF', label: 'Center Forward' }, { code: 'RW', label: 'Right Winger' }, { code: 'LW', label: 'Left Winger' }, { code: 'ST', label: 'Striker' }, { code: 'SUB', label: 'Substitute' }];

const FORMATIONS = {
    '4-3-3': [
        { left: '6%', top: '50%', code: 'GK' }, { left: '25%', top: '15%', code: 'LB' }, { left: '18%', top: '38%', code: 'CB' }, { left: '18%', top: '62%', code: 'CB' }, { left: '25%', top: '85%', code: 'RB' },
        { left: '40%', top: '50%', code: 'DM' }, { left: '55%', top: '30%', code: 'CM' }, { left: '55%', top: '70%', code: 'CM' },
        { left: '80%', top: '15%', code: 'LW' }, { left: '85%', top: '50%', code: 'ST' }, { left: '80%', top: '85%', code: 'RW' }, { left: '50%', top: '-15%', code: 'SUB' }
    ],
    '4-4-2': [
        { left: '6%', top: '50%', code: 'GK' }, { left: '25%', top: '15%', code: 'LB' }, { left: '20%', top: '38%', code: 'CB' }, { left: '20%', top: '62%', code: 'CB' }, { left: '25%', top: '85%', code: 'RB' },
        { left: '50%', top: '15%', code: 'LM' }, { left: '45%', top: '40%', code: 'CM' }, { left: '45%', top: '60%', code: 'CM' }, { left: '50%', top: '85%', code: 'RM' },
        { left: '80%', top: '35%', code: 'ST' }, { left: '80%', top: '65%', code: 'ST' }, { left: '50%', top: '-15%', code: 'SUB' }
    ],
    '3-4-3': [
        { left: '6%', top: '50%', code: 'GK' }, { left: '20%', top: '20%', code: 'CB' }, { left: '15%', top: '50%', code: 'CB' }, { left: '20%', top: '80%', code: 'CB' },
        { left: '45%', top: '10%', code: 'LM' }, { left: '40%', top: '40%', code: 'CM' }, { left: '40%', top: '60%', code: 'CM' }, { left: '45%', top: '90%', code: 'RM' },
        { left: '75%', top: '20%', code: 'LW' }, { left: '82%', top: '50%', code: 'ST' }, { left: '75%', top: '80%', code: 'RW' }, { left: '50%', top: '-15%', code: 'SUB' }
    ]
};

function stringToHash(str) { let hash = 0; if (str.length === 0) return hash; for (let i = 0; i < str.length; i++) { const char = str.charCodeAt(i); hash = ((hash << 5) - hash) + char; hash |= 0; } return Math.abs(hash); }
function getColorForUsername(username) { return nameColors[stringToHash(username.trim().toUpperCase()) % nameColors.length]; }

function showSection(id){
  document.querySelectorAll('.container').forEach(c=>c.style.display='none');
  document.getElementById(id).style.display='block';
  document.querySelectorAll('.sticker-popup').forEach(p => p.style.display = 'none');
  applyUIRestrictions();
  if (id === 'blue') { loadTeamChatMessages('blue'); document.getElementById('blueChatNameInput').value = localStorage.getItem('chat_username') || ''; setupDraggable('blue'); } 
  else if (id === 'yellow') { loadTeamChatMessages('yellow'); document.getElementById('yellowChatNameInput').value = localStorage.getItem('chat_username') || ''; setupDraggable('yellow'); } 
  else if (id === 'main') { loadChatMessages(); }
}

function toggleBackgroundMusic() {
    const audio = document.getElementById('musicPlayer');
    if (audio.paused) { audio.play(); document.getElementById('audioToggleBtn').innerHTML = 'Stop Audio'; } 
    else { audio.pause(); document.getElementById('audioToggleBtn').innerHTML = 'Audio'; }
}

// -------------------- ADDRESS LOGIC (UPDATED) --------------------
function openGoogleMaps() {
    // Uses the global matchAddress variable
    const addr = matchAddress; 
    
    if (!addr || addr === "Address üìç" || addr === "No address set" || addr.trim() === "") {
        alert("No address has been set by the admin yet.");
        return;
    }

    // Populate the read-only input
    const inputField = document.getElementById('addressDisplayInput');
    inputField.value = addr;
    
    // Show the modal
    document.getElementById('viewAddressModal').style.display = 'flex';
}

function closeAddressModal() {
    document.getElementById('viewAddressModal').style.display = 'none';
}

function copyToClipboard() {
    const copyText = document.getElementById("addressDisplayInput");
    
    // Select text for mobile and desktop
    copyText.select();
    copyText.setSelectionRange(0, 99999); 

    // Copy to clipboard
    navigator.clipboard.writeText(copyText.value).then(() => {
        alert("Address Copied to Clipboard! ‚úÖ");
    }).catch(err => {
        console.error('Failed to copy: ', err);
    });
}

function openMapDirectly() {
    const addr = document.getElementById('addressDisplayInput').value;
    // Use universal Google Maps search URL (works better on iPhone/Android)
    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
    window.open(mapUrl, '_blank');
}

// -------------------- KIT WASH LOGIC --------------------
async function openWashModal() {
    const pwd = prompt("Admin Password:");
    if (pwd !== ADMIN_PASSWORD) return alert("Access Denied");
    
    const { data: team } = await supabase.from("main_team").select("*");
    const { data: history } = await supabase.from("laundry_history").select("*");
    
    const twoMonthsMs = 60 * 24 * 60 * 60 * 1000;
    const now = Date.now();
    const lastWashMap = {};
    if(history) history.forEach(r => lastWashMap[r.player_name] = new Date(r.washed_at).getTime());

    const eligible = team.filter(p => {
        return (now - (lastWashMap[p.name] || 0)) > twoMonthsMs;
    });
    
    if(eligible.length === 0) return alert("Everyone is exempt!");
    
    const jar = document.getElementById('jar');
    jar.innerHTML = '';
    eligible.forEach(p => {
        const paper = document.createElement('div');
        paper.className = 'paper-slip';
        paper.innerText = p.name;
        paper.style.top = Math.random() * 200 + 'px';
        paper.style.left = Math.random() * 150 + 'px';
        paper.style.transform = `rotate(${Math.random()*360}deg)`;
        jar.appendChild(paper);
    });
    
    document.getElementById('washModalOverlay').style.display = 'flex';
    document.getElementById('resultCard').style.display = 'none';
    
    window.eligibleForWash = eligible;
}

function closeWashModal() { document.getElementById('washModalOverlay').style.display = 'none'; }

function shakeJar() {
    const jar = document.getElementById('jar');
    jar.classList.add('shaking');
    const papers = document.querySelectorAll('.paper-slip');
    
    let shakeInterval = setInterval(() => {
        papers.forEach(p => {
            p.style.top = Math.random() * 200 + 'px';
            p.style.left = Math.random() * 150 + 'px';
            p.style.transform = `rotate(${Math.random()*360}deg)`;
        });
    }, 100);
    
    setTimeout(() => {
        clearInterval(shakeInterval);
        jar.classList.remove('shaking');
        pickWinner();
    }, 2000);
}

function pickWinner() {
    const players = window.eligibleForWash;
    const winner = players[Math.floor(Math.random() * players.length)];
    window.washWinner = winner;
    
    document.getElementById('resultCard').style.display = 'flex';
    document.getElementById('winnerName').innerText = winner.name;
}

async function confirmWashWinner() {
    const winner = window.washWinner;
    await supabase.from("laundry_history").insert([{ player_name: winner.name }]);
    await sendMessageToGroup("System", `wash-winner:${winner.name}`);
    alert("Confirmed!");
    loadLaundryHistory(false);
    closeWashModal();
}

async function volunteerInstead() {
    const name = prompt("Enter volunteer name:");
    if(!name) return;
    await supabase.from("laundry_history").insert([{ player_name: name }]);
    await sendSystemMessageToChat(name, "Volunteered for Kit Wash üôã‚Äç‚ôÇÔ∏è");
    alert("Thanks!");
    loadLaundryHistory(false);
    closeWashModal();
}

async function loadLaundryHistory(toggle = true) {
    const container = document.getElementById('laundryHistoryContainer');
    if (toggle) { container.style.display = container.style.display === 'none' ? 'block' : 'none'; }
    if (container.style.display === 'none') return;

    const list = document.getElementById('laundryList');
    list.innerHTML = '<li style="color:#aaa; text-align:center;">Loading...</li>';
    
    const { data, error } = await supabase.from('laundry_history').select('*').order('washed_at', { ascending: false }).limit(20);

    if (error || !data || data.length === 0) { list.innerHTML = '<li style="color:#aaa; text-align:center;">No history yet.</li>'; return; }

    list.innerHTML = '';
    data.forEach(item => {
        const date = new Date(item.washed_at).toLocaleDateString();
        list.innerHTML += `<li><span style="font-weight:bold; color:#FF9800;">üßº The Kit Wash Volunteer will be: ${item.player_name}</span><span style="color:#aaa; font-size:12px;">${date}</span></li>`;
    });
}

async function sendMessageToGroup(sender, type) {
    let content = "";
    if (type === "jar-shuffling") { content = "üåÄ Shuffling names for Kit Wash... who will it be? ü§î"; } 
    else if (type === "gif-shuffling") { content = `[IMG]https://media.giphy.com/media/3o7bu3XilJ5BOiSGic/giphy.gif`; } 
    else if (type.startsWith("wash-winner:")) { const winnerName = type.split(":")[1]; content = `üßº The Kit Wash Volunteer will be: ${winnerName} üßº`; }
    
    if(content) { await supabase.from('chat_messages').insert([{ username: sender, content: content }]); }
}

async function showSettingsModal() {
    document.getElementById('settingsPassword').value = ''; 
    document.getElementById('passwordError').style.display = 'none'; 
    document.getElementById('passwordSection').style.display = 'block'; 
    document.getElementById('settingsControls').style.display = 'none'; 
    document.getElementById('settingsModalOverlay').style.display = 'flex';
    
    // ÿ¨ŸÑÿ® ÿßŸÑÿπŸÜŸàÿßŸÜ
    const { data } = await supabase.from('app_config').select('match_address').eq('id', 1).single(); 
    document.getElementById('matchAddressInput').value = data ? data.match_address : '';
    
    // ÿ¨ŸÑÿ® ŸàŸÇÿ™ ÿßŸÑŸÖÿ®ÿßÿ±ÿßÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏
    document.getElementById('gameTimeInput').value = systemConfig.gameTimeText || "The Game will be on Sunday at 9:40AM";

    // Show Auto-Schedule List
    renderScheduledList();
    // Show Multi-Add Monitor
    renderMultiAddMonitor();
}

function authenticateSettings() {
    if (document.getElementById('settingsPassword').value === ADMIN_PASSWORD) {
        document.getElementById('passwordSection').style.display = 'none'; document.getElementById('settingsControls').style.display = 'flex';
        document.getElementById('allowPlayerEdit').checked = systemConfig.allowPlayerEdit; 
        document.getElementById('allowTeamEdit').checked = systemConfig.allowTeamEdit; 
        document.getElementById('allowFormationEdit').checked = systemConfig.allowFormationEdit; 
        document.getElementById('allowChat').checked = systemConfig.allowChat; 
        document.getElementById('enforceTimeRestriction').checked = systemConfig.enforceTimeRestriction;
        document.getElementById('disableMainListPin').checked = systemConfig.disableMainListPin; 
        document.getElementById('hideLaundrySection').checked = systemConfig.hideLaundrySection;
    } else { document.getElementById('passwordError').style.display = 'block'; }
}
async function saveSettings() {
    const newConfig = { 
        allowPlayerEdit: document.getElementById('allowPlayerEdit').checked, 
        allowTeamEdit: document.getElementById('allowTeamEdit').checked, 
        allowFormationEdit: document.getElementById('allowFormationEdit').checked, 
        allowChat: document.getElementById('allowChat').checked, 
        enforceTimeRestriction: document.getElementById('enforceTimeRestriction').checked,
        disableMainListPin: document.getElementById('disableMainListPin').checked,
        hideLaundrySection: document.getElementById('hideLaundrySection').checked,
        
        scheduledList: systemConfig.scheduledList || [], 
        multiAddLog: systemConfig.multiAddLog || [], // Preserve Multi-Add log

        gameTimeText: document.getElementById('gameTimeInput').value.trim() 
    };

    await supabase.from('app_config').update({ system_config: JSON.stringify(newConfig), match_address: document.getElementById('matchAddressInput').value.trim() }).eq('id', 1);
    
    systemConfig = newConfig; 
    matchAddress = document.getElementById('matchAddressInput').value.trim(); 
    
    // --- ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿµ ŸÅŸàÿ±ÿßŸã ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿ© ---
    if(systemConfig.gameTimeText) {
        document.getElementById('gameTimeDisplay').innerText = systemConfig.gameTimeText;
    }

    loadMatchAddress(); 
    applyUIRestrictions(); 
    document.getElementById('settingsModalOverlay').style.display = 'none'; 
    alert('Settings saved!');
}


async function clearTableData(tableName, confirmMessage, friendlyName) { if (!confirm(confirmMessage)) return; await supabase.from(tableName).delete().gt('id', 0); alert(`${friendlyName} cleared.`); reloadList(tableName); }
function clearGroupChat() { clearTableData('chat_messages', "Clear Group Chat?", "Group Chat"); }
function clearSystemHistory() { clearTableData('system_history', "Clear History?", "History"); }
function clearBlueChat() { clearTableData('blue_chat', "Clear Blue Chat?", "Blue Chat"); }
function clearYellowChat() { clearTableData('yellow_chat', "Clear Yellow Chat?", "Yellow Chat"); }
function clearMainTeam() { clearTableData('main_team', "Clear Main Team?", "Main Team"); }
function clearWaitingList() { clearTableData('waiting_list', "Clear Waiting List?", "Waiting List"); }
function clearBlueTeam() { clearTableData('blue_team', "Clear Blue Team?", "Blue Team"); }
function clearYellowTeam() { clearTableData('yellow_team', "Clear Yellow Team?", "Yellow Team"); }
async function clearLaundryHistory() {
    const pin = prompt("Enter PIN (2023) to clear Laundry History:");
    if (pin !== "2023") return alert("Incorrect PIN! ‚ùå");
    
    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ±ŸÖÿ≤ ÿµÿ≠Ÿäÿ≠ÿßŸãÿå ÿ≥ŸäŸÇŸàŸÖ ÿ®ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑŸÖÿ≥ÿ≠
    clearTableData('laundry_history', "Are you sure you want to clear Laundry History?", "Laundry History");
}


async function canEditCaptain(table, playerId) {
    if (table !== 'blue_team' && table !== 'yellow_team') return true;
    const { data: allPlayers } = await supabase.from(table).select('id, player_pin').order('id', { ascending: true });
    if (!allPlayers || allPlayers.length === 0 || allPlayers[0].id !== playerId) return true;
    const enteredPin = prompt(`Captain Action: Enter PIN:`);
    return enteredPin === allPlayers[0].player_pin;
}

async function verifyIndividualPin(table, id) {
    if (systemConfig.disableMainListPin && (table === "main_team" || table === "waiting_list")) { return true; }
    const { data } = await supabase.from(table).select('player_pin').eq('id', id).single();
    if (!data) return false;
    const storedPin = data.player_pin;
    if (!storedPin) return true; 
    const enteredPin = prompt("Enter your 4-digit PIN to confirm:");
    if (enteredPin === ADMIN_PASSWORD) return true; 
    if (enteredPin === storedPin) { return true; } else { alert("Incorrect PIN. Action blocked."); return false; }
}

async function loadSystemConfig() {
    const { data } = await supabase.from('app_config').select('system_config').eq('id', 1).single(); 
    if (data && data.system_config) {
        systemConfig = { ...systemConfig, ...JSON.parse(data.system_config) };
        
        // --- Ÿáÿ∞ÿß ÿßŸÑÿ¨ÿ≤ÿ° ŸÉÿßŸÜ ŸÜÿßŸÇÿµÿßŸã ŸÑÿπÿ±ÿ∂ ÿßŸÑŸàŸÇÿ™ ÿπŸÜÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ---
        if (systemConfig.gameTimeText) {
            const el = document.getElementById('gameTimeDisplay');
            if(el) el.innerText = systemConfig.gameTimeText;
        }
    }
    applyUIRestrictions(); 
}

function applyUIRestrictions() {
    document.getElementById('playerManagement').style.display = systemConfig.allowPlayerEdit ? 'block' : 'none';
    document.querySelectorAll('.action-btn').forEach(btn => {
        const isTeam = btn.closest('#blueList') || btn.closest('#yellowList');
        btn.style.display = isTeam ? (systemConfig.allowTeamEdit ? 'inline-block' : 'none') : (systemConfig.allowPlayerEdit ? 'inline-block' : 'none');
    });
    document.getElementById('bluePlayerManagement').style.display = systemConfig.allowTeamEdit ? 'block' : 'none';
    document.getElementById('yellowPlayerManagement').style.display = systemConfig.allowTeamEdit ? 'block' : 'none';
    document.querySelectorAll('.formation-btn, .dynamic-btn').forEach(btn => btn.style.display = systemConfig.allowFormationEdit ? 'inline-block' : 'none');
    document.querySelectorAll('.chat-input-area').forEach(el => el.style.display = systemConfig.allowChat ? 'flex' : 'none');
    const laundrySection = document.getElementById('kitWashSection');
    if (laundrySection) { laundrySection.style.display = systemConfig.hideLaundrySection ? 'none' : 'block'; }
}

function isWithinAllowedTime(){
    if (!systemConfig.enforceTimeRestriction) return true;
    const now = new Date(); const d = now.getDay(); const h = now.getHours();
    if (d >= 3 && d <= 6) { if (d === 3) return h >= 15; return true; } else if (d === 0) return h < 12; return false;
}
function formatPlayerTime(timestamp) { if (!timestamp) return ''; return new Date(timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }); }

async function addPlayer(){
  if(!systemConfig.allowPlayerEdit) return alert("Add disabled");
  if(!isWithinAllowedTime()){ alert("Adding players is only allowed from Wednesday 3 PM to Sunday 12 PM."); return; }
  
  const name = document.getElementById("nameInput").value.trim();
  
  // --- Validation: English, Full Name, Last Name Length ---
  if(!name) return alert("Enter name");
  if (!/^[A-Za-z0-9\s]+$/.test(name)) return alert("English letters only allowed!");
  
  const nameParts = name.split(/\s+/);
  if (nameParts.length < 2) return alert("Full Name Required (First & Last Name)!");
  
  // STRICT NAME CHECK: Last name >= 3 chars
  if (nameParts[nameParts.length - 1].length < 3) {
      return alert("Last Name must be at least 3 characters long!");
  }
  
  // --- NEW: Check if Name Already Exists (Prevent Duplicates) ---
  const { data: existMain } = await supabase.from("main_team").select("id").ilike("name", name);
  const { data: existWait } = await supabase.from("waiting_list").select("id").ilike("name", name);

  if ((existMain && existMain.length > 0) || (existWait && existWait.length > 0)) {
      return alert("Name already exists! Please use a different name.");
  }
  
  let pin = "0000"; 
  if (!systemConfig.disableMainListPin) {
      pin = prompt("Create a 4-digit PIN (Required for deleting/editing later):");
      if (!pin || pin.length !== 4) return alert("PIN is required (4 digits).");
  }

  const { data: team } = await supabase.from("main_team").select("id");
  const table = team.length < 24 ? "main_team" : "waiting_list";
  await supabase.from(table).insert([{ name, time: Date.now(), player_pin: pin }]);

  // --- MULTI-ADD MONITOR LOGGING ---
  const adderName = localStorage.getItem('chat_username') || "Unknown User";
  if (!systemConfig.multiAddLog) systemConfig.multiAddLog = [];
  systemConfig.multiAddLog.unshift({
      adder: adderName,
      player: name,
      time: Date.now()
  });
  // Keep log size manageable (last 100)
  if (systemConfig.multiAddLog.length > 100) systemConfig.multiAddLog = systemConfig.multiAddLog.slice(0, 100);
  saveConfigToSupabase(); // Save the log to DB
  
  if(team.length < 24) { sendSystemMessageToChat(name, `joined the Main Team`); } 
  else { sendSystemMessageToChat(name, `added to the Waiting List`); alert(`Main team is full (24). ${name} has been added to the Waiting List.`); }
  document.getElementById("nameInput").value=""; loadPlayers();
}


async function loadPlayers(){
  const { data: team } = await supabase.from("main_team").select("*").order("id");
  const { data: waiting } = await supabase.from("waiting_list").select("*").order("id");
  renderList("teamList", team, "main_team"); renderList("waitingList", waiting, "waiting_list");
}
function renderList(id, data, table){
    const ul = document.getElementById(id); ul.innerHTML = "";
    if(data) data.forEach((p,i) => {
        const btns = systemConfig.allowPlayerEdit ? `<span><button class="action-btn edit-btn" onclick="editPlayer('${table}',${p.id},'${p.name}')">Edit</button><button class="action-btn delete-btn" onclick="deletePlayer('${table}',${p.id})">Delete</button></span>` : '';
        ul.innerHTML += `<li><div class="player-info"><span>${i+1}. ${p.name} <span class="player-time">${formatPlayerTime(p.time)}</span></span></div>${btns}</li>`;
    });
}
async function deletePlayer(table, id){
  if((table.includes('team') && !systemConfig.allowTeamEdit) || (!table.includes('team') && !systemConfig.allowPlayerEdit)) return;
  if(table.includes('_team') && !await canEditCaptain(table, id)) return;
  const pinOk = await verifyIndividualPin(table, id);
  if (!pinOk) return;

  if(!confirm("Delete player?")) return;
  let playerName = "Unknown";
  const { data: pData } = await supabase.from(table).select("name").eq("id", id).single();
  if(pData) playerName = pData.name;
  await supabase.from(table).delete().eq("id",id);
  if (table === "main_team" || table === "waiting_list") { const listName = table === "main_team" ? "Main Team" : "Waiting List"; sendSystemMessageToChat(playerName, `left the ${listName}`); }
  if(table==="main_team") refillMainTeam();
  reloadList(table);
}
async function editPlayer(table,id,oldName){
  if((table.includes('team') && !systemConfig.allowTeamEdit) || (!table.includes('team') && !systemConfig.allowPlayerEdit)) return;
  if(table.includes('_team') && !await canEditCaptain(table, id)) return;
  const pinOk = await verifyIndividualPin(table, id);
  if (!pinOk) return;
  const newName=prompt(`Edit name:`, oldName);
  if(!newName) return;
  await supabase.from(table).update({name:newName.trim()}).eq("id",id); 
  reloadList(table);
}
async function refillMainTeam(){
  const { data: team } = await supabase.from("main_team").select("id");
  const { data: waiting } = await supabase.from("waiting_list").select("*").order("id", { ascending: true }); 
  if(team.length < 24 && waiting.length > 0){
    const f = waiting[0];
    await supabase.from("main_team").insert([{ name: f.name, time: Date.now(), player_pin: f.player_pin }]);
    await supabase.from("waiting_list").delete().eq("id", f.id);
    sendSystemMessageToChat(f.name, `moved to the Main Team`);
  }
}
function reloadList(table){
  if(table.includes("main") || table.includes("waiting")) loadPlayers();
  else if(table==="blue_team") loadBlue(); else if(table==="yellow_team") loadYellow();
  else if(table.includes("chat")) { if(table.includes("blue")) loadTeamChatMessages('blue'); else if(table.includes("yellow")) loadTeamChatMessages('yellow'); else loadChatMessages(); }
  else if(table.includes("system_history")) loadSystemHistory(false);
  else if(table.includes("laundry_history")) loadLaundryHistory(false);
}

async function addTeam(team, inputId, providedName){
  if(!systemConfig.allowTeamEdit) return;
  let name = providedName || document.getElementById(inputId).value.trim();
  if(!name) return;
  const table = `${team}_team`;
  const { data: curr } = await supabase.from(table).select("id");
  if(curr.length >= 12) return alert("Team Full");
  let pin = null;
  if (curr.length === 0) { pin = prompt(`Captain (${name}) Create PIN:`); if (!pin) return; }
  const pos = FORMATIONS['4-3-3'][curr.length] || { left: '50%', top: '-15%', code: 'SUB' };
  await supabase.from(table).insert([{ name, time: Date.now(), position: JSON.stringify({left:pos.left, top:pos.top}), position_code: pos.code, player_pin: pin }]);
  if(!providedName) document.getElementById(inputId).value="";
  if(providedName) closeTeamAddModal();
  reloadList(table);
}
async function addBlue(n){ addTeam('blue', 'blueInput', n); }
async function addYellow(n){ addTeam('yellow', 'yellowInput', n); }

async function loadTeamData(team){
  const table = `${team}_team`;
  const { data } = await supabase.from(table).select("*").order("id");
  const ul=document.getElementById(`${team}List`);
  const field=document.getElementById(`${team}Plan`);
  ul.innerHTML=""; field.innerHTML=`<div class="mid-line"></div><div class="center-circle"></div><div class="penalty-box-left"></div><div class="penalty-box-right"></div>`; 
  if(data) data.forEach((p,i)=>{
    const btns = systemConfig.allowTeamEdit ? `<span><button class="action-btn edit-btn" onclick="editPlayer('${table}',${p.id},'${p.name}')">Edit</button><button class="action-btn delete-btn" onclick="deletePlayer('${table}',${p.id})">Delete</button></span>` : '';
    ul.innerHTML += `<li><div class="player-info"><span>${i+1}. ${p.name} ${i===0?'(C)':''}</span></div>${btns}</li>`;
    createPlayerMarker(team, p.name, p.id, JSON.parse(p.position), p.position_code, i + 1);
  });
  setupDraggable(team);
}
function loadBlue(){ loadTeamData('blue'); }
function loadYellow(){ loadTeamData('yellow'); }

async function canControlPlan(team) {
    if (!systemConfig.allowFormationEdit) { alert("Formation disabled."); return false; }
    if (sessionStorage.getItem(`${team}_captain_unlocked`) === 'true') return true;
    const table = `${team}_team`;
    const { data } = await supabase.from(table).select('id, player_pin').order('id', { ascending: true }).limit(1).single();
    if (!data || !data.player_pin) { alert("No Captain PIN."); return false; }
    const enteredPin = prompt(`Enter Captain PIN for ${team}:`);
    if (enteredPin === data.player_pin) { sessionStorage.setItem(`${team}_captain_unlocked`, 'true'); return true; } 
    else { alert("Wrong PIN."); return false; }
}

function getAutoPositionName(leftPct, topPct) {
    const x = parseFloat(leftPct); const y = parseFloat(topPct);
    if (x < 12) return 'GK';
    if (x < 32) { if (y < 30) return 'LB'; if (y > 70) return 'RB'; return 'CB'; }
    if (x < 60) { if (y < 25) return 'LM'; if (y > 75) return 'RM'; if (x < 45) return 'DM'; return 'CM'; }
    if (y < 30) return 'LW'; if (y > 70) return 'RW'; if (x < 80) return 'CF'; return 'ST';
}

function setupDraggable(team) {
  const fieldId = `#${team}Plan`; const table = `${team}_team`; const field = document.getElementById(`${team}Plan`);
  interact(`${fieldId} .player-marker`).unset();
  if (!systemConfig.allowFormationEdit) return;
  interact(`${fieldId} .player-marker`).draggable({
      modifiers: [ interact.modifiers.restrictRect({ restriction: field }) ],
      listeners: {
        start: async (event) => {
            if (sessionStorage.getItem(`${team}_captain_unlocked`) !== 'true') {
                if (!await canControlPlan(team)) { event.interaction.stop(); return; }
            }
            const rect = field.getBoundingClientRect();
            event.target.dataset.x = (parseFloat(event.target.style.left)/100) * rect.width;
            event.target.dataset.y = (parseFloat(event.target.style.top)/100) * rect.height;
        },
        move (event) {
          if (sessionStorage.getItem(`${team}_captain_unlocked`) !== 'true') return;
          let x = (parseFloat(event.target.dataset.x) || 0) + event.dx;
          let y = (parseFloat(event.target.dataset.y) || 0) + event.dy;
          event.target.style.left = `${x}px`; event.target.style.top = `${y}px`;
          event.target.dataset.x = x; event.target.dataset.y = y;
        },
        end: (event) => {
          if (sessionStorage.getItem(`${team}_captain_unlocked`) !== 'true') return;
          const rect = field.getBoundingClientRect();
          let lp = (parseFloat(event.target.dataset.x) / rect.width) * 100;
          let tp = (parseFloat(event.target.dataset.y) / rect.height) * 100;
          const newCode = getAutoPositionName(lp, tp);
          event.target.querySelector('.player-position-label').innerText = newCode;
          event.target.style.left = `${lp.toFixed(2)}%`; event.target.style.top = `${tp.toFixed(2)}%`;
          event.target.style.transform = `translate(-50%, -50%)`;
          supabase.from(table).update({ position: JSON.stringify({ left: `${lp.toFixed(2)}%`, top: `${tp.toFixed(2)}%` }), position_code: newCode }).eq('id', event.target.dataset.playerId).then();
        }
      }
  });
}

async function applyFormation(team, name) {
    if (!await canControlPlan(team)) return;
    const table = `${team}_team`; const form = FORMATIONS[name];
    const { data: players } = await supabase.from(table).select('id').order('id');
    players.slice(0, 12).map((p, i) => {
        const pos = i < form.length ? form[i] : { left: '50%', top: '-15%', code: 'SUB' };
        supabase.from(table).update({ position: JSON.stringify({ left: pos.left, top: pos.top }), position_code: pos.code }).eq('id', p.id).then();
    });
    reloadList(table);
}
async function applyDynamicPlan(team) {
    if (!await canControlPlan(team)) return;
    alert("Dynamic plan logic applied (Simulated).");
}

function createPlayerMarker(team, name, id, pos, code, num) { 
  const m = document.createElement('div'); m.classList.add('player-marker'); m.id = `marker-${team}-${id}`; m.dataset.playerId = id; 
  m.style.background = team==='blue'? '#1976d2' : '#fbc02d'; m.style.left = pos.left; m.style.top = pos.top;
  const textColor = team === 'blue' ? '#fff' : '#000';
  const numBg = team === 'blue' ? 'rgba(0,0,0,0.5)' : 'rgba(255,255,255,0.8)';
  m.innerHTML = `<span class="player-position-label">${code || 'SUB'}</span><div class="player-name" style="color:${textColor}; display:flex; align-items:center; gap:3px; justify-content:center;"><span style="background:${numBg}; padding:1px 4px; border-radius:4px; font-size:10px;">${num}</span>${name}</div>`;
  m.addEventListener('click', (e) => { if (e.detail === 1) showPositionMenu(team, id, name); });
  document.getElementById(`${team}Plan`).appendChild(m);
}

async function showPositionMenu(team, id, name) {
    if (!await canControlPlan(team)) return;
    currentPositionTarget = { team, id, name }; document.getElementById('positionMenuTitle').innerText = `Pos: ${name}`;
    const g = document.getElementById('positionMenuGrid'); g.innerHTML = ''; 
    POSITIONS_LIST.forEach(p => { const b = document.createElement('button'); b.innerText = p.code; b.onclick = () => selectPosition(p.code); g.appendChild(b); });
    document.getElementById('positionMenuOverlay').style.display = 'flex';
}
function closePositionMenu() { document.getElementById('positionMenuOverlay').style.display = 'none'; }
async function selectPosition(code) {
    const { team, id } = currentPositionTarget; const table = `${team}_team`;
    await supabase.from(table).update({ position_code: code }).eq('id', id);
    closePositionMenu(); reloadList(table);
}

function showToast(m) { const c=document.getElementById('toastContainer'); const t=document.createElement('div'); t.innerText=m; t.style.cssText='position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px;border-radius:20px;'; c.appendChild(t); setTimeout(()=>t.remove(),3000); }

async function loadMatchAddress() {
    const { data } = await supabase.from('app_config').select('match_address').eq('id', 1).single(); 
    matchAddress = data ? data.match_address : "Address üìç";
    document.getElementById('addressBtn').textContent = (matchAddress.length > 20 && !matchAddress.includes("set")) ? "Match Address üìç" : `${matchAddress} üìç`;
}
function playNotificationSound() { 
    const audio = document.getElementById('notification-sound');
    if (audio) {
        audio.currentTime = 0; // ÿ•ÿπÿßÿØÿ© ÿßŸÑÿµŸàÿ™ ŸÑŸÑÿ®ÿØÿßŸäÿ© ŸÑÿ™ŸÉÿ±ÿßÿ±Ÿá
        audio.play().catch(e => console.log("Audio play blocked:", e));
    }
}


async function loadSystemHistory(toggle = true) {
  const historyContainer = document.getElementById('systemHistoryContainer');
  const historyList = document.getElementById('historyList');
  if (toggle) { historyContainer.style.display = historyContainer.style.display === 'block' ? 'none' : 'block'; }
  if (historyContainer.style.display === 'none') return;
  historyList.innerHTML = '<li style="text-align:center; color:#aaa;">Loading...</li>'; 
  const { data, error } = await supabase.from('system_history').select('*').order('created_at', { ascending: false }).limit(50);
  if (error || !data || data.length === 0) { historyList.innerHTML = '<li style="text-align:center; color:#aaa;">No recent events.</li>'; return; }
  historyList.innerHTML = ''; 
  data.forEach(item => {
    const dateObj = new Date(item.created_at);
    const time = dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    let bgColor = '#424242'; let textColor = '#fff'; let icon = '';
    const contentLower = item.content.toLowerCase();
    if (contentLower.includes('joined') || contentLower.includes('volunteered')) { bgColor = '#2e7d32'; icon = '‚úî'; } 
    else if (contentLower.includes('left')) { bgColor = '#c62828'; icon = '‚úñ'; } 
    else if (contentLower.includes('moved') || contentLower.includes('waiting list') || contentLower.includes('selected')) { bgColor = '#f57f17'; textColor = '#000'; icon = '‚ö†'; }
    historyList.innerHTML += `<li style="background-color: ${bgColor}; color: ${textColor}; padding: 10px 15px; border-radius: 15px; margin-bottom: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; flex-direction: column; align-items: flex-start; text-align: left; border: 1px solid rgba(255,255,255,0.1);"><div style="font-size: 14px; font-weight: bold; width:100%;"><span style="margin-right:5px;">${icon}</span> ${item.content}</div><div style="font-size: 11px; opacity: 0.8; margin-top: 5px; align-self: flex-end;">${time}</div></li>`;
  });
}

async function sendSystemMessageToChat(name, msg) { await supabase.from('system_history').insert([{ content: `${name} ${msg}`, username: 'System' }]); }

async function handleFileUpload(input, context) {
    const file = input.files[0]; if (!file) return;
    const nameInputId = context === 'global' ? 'chatNameInput' : (context==='blue'?'blueChatNameInput':'yellowChatNameInput');
    const name = document.getElementById(nameInputId).value.trim();
    if (!name) return alert("Enter name");
    localStorage.setItem('chat_username', name);
    const ext = file.name.split('.').pop(); const fileName = `${Date.now()}.${ext}`;
    const { error } = await supabase.storage.from('chat_images').upload(fileName, file);
    if(error) return alert("Upload failed");
    const { data } = supabase.storage.from('chat_images').getPublicUrl(fileName);
    const content = ['mp4','webm'].includes(ext) ? `[VID]${data.publicUrl}` : `[IMG]${data.publicUrl}`;
    const table = context === 'global' ? 'chat_messages' : `${context}_chat`;
    await supabase.from(table).insert([{ username: name, content }]);
    input.value = '';
}
function toggleRadio() { const e=document.getElementById('radioPlayerSection'); e.style.display = e.style.display==='block'?'none':'block'; }
function playRadio() { const a=document.getElementById('radioStreamPlayer'); const s=document.getElementById('radioSelect'); if(a.src!==s.value) a.src=s.value; a.play(); }
function stopRadio() { document.getElementById('radioStreamPlayer').pause(); document.getElementById('radioPlayerSection').style.display='none'; }
function changeRadioChannel() { playRadio(); document.getElementById('radioPlayerSection').style.display='none'; }

function toggleStickerMenu(context) {
    const id = context === 'global' ? 'stickerPopupGlobal' : (context === 'blue' ? 'stickerPopupBlue' : 'stickerPopupYellow');
    const el = document.getElementById(id);
    el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
    if(el.style.display === 'flex') showStickerTab(context, 'football');
}
function showStickerTab(context, category) {
    const gridId = context === 'global' ? 'stickerGridGlobal' : (context === 'blue' ? 'stickerGridBlue' : 'stickerGridYellow');
    const grid = document.getElementById(gridId);
    grid.innerHTML = '';
    STICKERS[category].forEach(url => {
        const img = document.createElement('img'); img.src = url; img.classList.add('sticker-item');
        img.onclick = () => sendSticker(context, url);
        grid.appendChild(img);
    });
}
async function sendSticker(context, url) {
    const nameInputId = context === 'global' ? 'chatNameInput' : (context==='blue'?'blueChatNameInput':'yellowChatNameInput');
    const name = document.getElementById(nameInputId).value.trim();
    if(!name) return alert("Enter name");
    localStorage.setItem('chat_username', name);
    const table = context === 'global' ? 'chat_messages' : `${context}_chat`;
    await supabase.from(table).insert([{ username: name, content: `[IMG]${url}` }]);
    toggleStickerMenu(context);
}

async function startVoiceRecording(context) {
    if (!navigator.mediaDevices) return alert("Microphone not supported");
    const nameInputId = context === 'global' ? 'chatNameInput' : (context==='blue'?'blueChatNameInput':'yellowChatNameInput');
    if (!document.getElementById(nameInputId).value.trim()) return alert("Enter name first");
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        const barId = context === 'global' ? 'recordingBar_global' : (context === 'blue' ? 'recordingBar_blue' : 'recordingBar_yellow');
        document.getElementById(barId).style.display = 'flex';
        isRecording = true;
        mediaRecorder.start();
    } catch (e) { console.error(e); alert("Mic access denied"); }
}

async function finishVoiceRecording(context, action) {
    if (!mediaRecorder || !isRecording) return;
    const barId = context === 'global' ? 'recordingBar_global' : (context === 'blue' ? 'recordingBar_blue' : 'recordingBar_yellow');
    mediaRecorder.onstop = async () => {
        document.getElementById(barId).style.display = 'none'; 
        if (action === 'send') {
             const blob = new Blob(audioChunks, { type: 'audio/webm' });
             const file = new File([blob], `voice_${Date.now()}.webm`, { type: 'audio/webm' });
             const nameInputId = context === 'global' ? 'chatNameInput' : (context==='blue'?'blueChatNameInput':'yellowChatNameInput');
             const name = document.getElementById(nameInputId).value.trim();
             const fileName = `${Date.now()}.webm`;
             const { error } = await supabase.storage.from('chat_images').upload(fileName, file);
             if(error) return alert("Audio upload failed");
             const { data } = supabase.storage.from('chat_images').getPublicUrl(fileName);
             const table = context === 'global' ? 'chat_messages' : `${context}_chat`;
             await supabase.from(table).insert([{ username: name, content: `[AUDIO]${data.publicUrl}` }]);
        }
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
    };
    mediaRecorder.stop();
    isRecording = false;
}

function toggleCustomAudio(uniqueId) {
    const audio = document.getElementById(uniqueId);
    const btn = document.getElementById('btn-' + uniqueId);
    document.querySelectorAll('audio').forEach(a => {
        if (a.id !== uniqueId && !a.paused) {
            a.pause();
            if (a.id && a.id.startsWith('audio-')) { const otherBtn = document.getElementById('btn-' + a.id); if (otherBtn) otherBtn.innerText = '‚ñ∂'; }
        }
    });
    if (audio.paused) { audio.play(); btn.innerText = '‚è∏'; } else { audio.pause(); btn.innerText = '‚ñ∂'; }
}

function updateAudioTime(uniqueId) {
    const audio = document.getElementById(uniqueId);
    const timeDisplay = document.getElementById('time-' + uniqueId);
    if (!audio || !timeDisplay) return;
    const current = formatTime(audio.currentTime);
    const duration = formatTime(audio.duration || 0);
    timeDisplay.innerText = `${current} / ${duration}`;
}

function resetAudio(uniqueId) { const btn = document.getElementById('btn-' + uniqueId); if (btn) btn.innerText = '‚ñ∂'; }
function formatTime(seconds) { if (isNaN(seconds)) return "0:00"; const m = Math.floor(seconds / 60); const s = Math.floor(seconds % 60); return `${m}:${s < 10 ? '0' : ''}${s}`; }

function renderMessage(m, id) {
    const div = document.getElementById(id); const isMe = m.username === localStorage.getItem('chat_username');
    let c = m.content;
    if (c.startsWith('[IMG]')) { c = `<img src="${c.substring(5)}" class="chat-media-content" onclick="window.open(this.src)">`; } 
    else if (c.startsWith('[VID]')) { c = `<video src="${c.substring(5)}" controls class="chat-media-content"></video>`; } 
    else if (c.startsWith('[AUDIO]')) {
        const uniqueId = 'audio-' + Math.random().toString(36).substr(2, 9);
        const src = c.substring(7);
        c = `<div class="custom-audio-player"><button id="btn-${uniqueId}" class="audio-play-btn" onclick="toggleCustomAudio('${uniqueId}')">‚ñ∂</button><span id="time-${uniqueId}" class="audio-time-display">0:00 / 0:00</span><audio id="${uniqueId}" src="${src}" ontimeupdate="updateAudioTime('${uniqueId}')" onloadedmetadata="updateAudioTime('${uniqueId}')" onended="resetAudio('${uniqueId}')" style="display:none;"></audio></div>`;
    }
    let delBtn = '';
    const table = id.includes('blue') ? 'blue_chat' : (id.includes('yellow') ? 'yellow_chat' : 'chat_messages');
    if (isMe) delBtn = `<button class="delete-msg-btn" title="Delete" onclick="deleteSingleMessage('${table}', ${m.id})">‚úï</button>`;
    const timeSpan = new Date(m.created_at).toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12:true});
    div.innerHTML += `<div class="message ${isMe?'my-message':''}" style="border-color:${getColorForUsername(m.username)}"><div style="font-size:12px; color:${getColorForUsername(m.username)}; font-weight:bold;">${m.username} <span style="font-weight:normal; color:#888; font-size:10px;">${timeSpan}</span></div><div>${c}</div>${delBtn}</div>`;
    div.scrollTop = div.scrollHeight;
}

async function deleteSingleMessage(table, id) { if(!confirm("Delete?")) return; await supabase.from(table).delete().eq('id', id); reloadList(table); }

async function loadChatMessages() { const { data } = await supabase.from('chat_messages').select('*').order('created_at', {ascending:true}).limit(50); document.getElementById('chatMessages').innerHTML=''; data.forEach(m=>renderMessage(m,'chatMessages')); }
async function loadTeamChatMessages(team) { 
    const { data } = await supabase.from(`${team}_chat`).select('*').order('created_at', {ascending:true}).limit(50); 
    document.getElementById(`${team}ChatMessages`).innerHTML=''; 
    data.forEach(m=>renderMessage(m,`${team}ChatMessages`)); 
}

// MODIFIED SEND MESSAGE (Enforce English + Full Name)
async function sendMessage() {
    const n = document.getElementById('chatNameInput').value; 
    if (!/^[A-Za-z0-9\s]+$/.test(n)) { return alert("Please use English Name Only / ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßÿ≥ŸÖ ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä ŸÅŸÇÿ∑"); }
    if (n.trim().split(/\s+/).length < 2) { return alert("Full Name Required (First & Last) / ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ ŸÖÿ∑ŸÑŸàÿ® (ÿßŸÑÿßÿ≥ŸÖ ŸàÿßŸÑŸÑŸÇÿ®)"); }
    const c = document.getElementById('chatMsgInput').value;
    if(!n || !c) return; localStorage.setItem('chat_username', n);
    await supabase.from('chat_messages').insert([{ username:n, content:c }]); document.getElementById('chatMsgInput').value='';
}

// MODIFIED TEAM MESSAGE (Enforce English + Full Name)
async function sendTeamMessage(team) {
    const n = document.getElementById(`${team}ChatNameInput`).value; 
    if (!/^[A-Za-z0-9\s]+$/.test(n)) { return alert("Please use English Name Only / ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßÿ≥ŸÖ ÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿä ŸÅŸÇÿ∑"); }
    if (n.trim().split(/\s+/).length < 2) { return alert("Full Name Required (First & Last) / ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ ŸÖÿ∑ŸÑŸàÿ® (ÿßŸÑÿßÿ≥ŸÖ ŸàÿßŸÑŸÑŸÇÿ®)"); }
    const c = document.getElementById(`${team}ChatMsgInput`).value;
    if(!n || !c) return; localStorage.setItem('chat_username', n);
    await supabase.from(`${team}_chat`).insert([{ username:n, content:c }]); document.getElementById(`${team}ChatMsgInput`).value='';
}

let gameInterval, gameActive = false, currentScore = 0, currentGameType = '';
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let ball = { x: 160, y: 200, r: 15, dy: 0, dx: 0, state: 'ready' };
let obstacles = []; let goalTarget = {}; let playerTargetX = 160;

canvas.addEventListener('mousemove', (e) => {
    if (!gameActive) return;
    const rect = canvas.getBoundingClientRect();
    playerTargetX = (e.clientX - rect.left) * (canvas.width / rect.width);
});
canvas.addEventListener('touchmove', (e) => {
    if (!gameActive) return;
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    playerTargetX = (e.touches[0].clientX - rect.left) * (canvas.width / rect.width);
}, {passive: false});

function openGameCenter() { document.getElementById('gameCenterOverlay').style.display = 'flex'; document.getElementById('gameMenu').style.display='block'; document.getElementById('gameArea').style.display='none'; }
function closeGameCenter() { exitGame(); document.getElementById('gameCenterOverlay').style.display = 'none'; }
function exitGame() { gameActive = false; cancelAnimationFrame(gameInterval); document.getElementById('gameArea').style.display = 'none'; document.getElementById('gameMenu').style.display = 'block'; }
async function loadLeaderboard(gid) {
    const list = document.getElementById('leaderboardList'); list.innerHTML='<li>Loading...</li>';
    const { data } = await supabase.from('game_scores').select('username,score').eq('game_name', gid).order('score',{ascending:false}).limit(10);
    list.innerHTML = data && data.length ? data.map((e,i)=>`<li>${i+1}. ${e.username}: ${e.score}</li>`).join('') : '<li>No scores</li>';
}

function startGame(type) { 
    currentGameType = type; document.getElementById('gameMenu').style.display='none'; document.getElementById('gameArea').style.display='block'; 
    currentScore=0; gameActive=false; document.getElementById('scoreDisplay').innerText="Score: 0";
    document.getElementById('startPrompt').style.display='block';
    
    if(type==='juggling') ball = { x: 160, y: 200, r: 20, dy: 0, dx: 2 };
    if(type==='flappy') { ball = { x: 50, y: 200, r: 12, dy: 0, dx: 0 }; obstacles = []; }
    if(type==='penalty') { ball = { x: 160, y: 360, r: 15, state:'ready' }; goalTarget={x:50, w:80, spd:3, dir:1}; }
    if(type==='dribbler') { ball = { x: 160, y: 350, r: 15 }; obstacles = []; playerTargetX = 160; }
    if(type==='keeper') { ball = { x: 160, y: 340, r: 20 }; obstacles = []; playerTargetX = 160; } 

    canvas.onmousedown = canvas.ontouchstart = (e) => {
        e.preventDefault();
        if (!gameActive) { gameActive=true; document.getElementById('startPrompt').style.display='none'; gameLoop(); 
            if(type==='juggling'){ ball.dy=-10; ball.dx=(Math.random()-0.5)*4; }
            if(type==='flappy') ball.dy=-7;
            return; 
        }
        if(type==='juggling') { ball.dy = -10; ball.dx = (Math.random()-0.5)*5; currentScore++; }
        if(type==='flappy') ball.dy = -7;
        if(type==='penalty' && ball.state==='ready') ball.state='shooting';
    };
    drawGame();
}

function drawGame() { ctx.clearRect(0,0,320,400); } 

function gameLoop() {
    if(!gameActive) return;
    ctx.clearRect(0,0,320,400);
    if (currentGameType === 'juggling') updateJuggling();
    else if (currentGameType === 'flappy') updateFlappy();
    else if (currentGameType === 'penalty') updatePenalty();
    else if (currentGameType === 'dribbler') updateDribbler();
    else if (currentGameType === 'keeper') updateKeeper();
    document.getElementById('scoreDisplay').innerText = `Score: ${currentScore}`;
    gameInterval = requestAnimationFrame(gameLoop);
}

async function gameOver() {
    gameActive = false; cancelAnimationFrame(gameInterval);
    const u = document.getElementById('chatNameInput').value || 'Guest';
    if(currentScore>0) await supabase.from('game_scores').insert([{game_name:currentGameType, username:u, score:currentScore}]);
    alert(`Game Over! Score: ${currentScore}`); exitGame(); loadLeaderboard(currentGameType);
}

function updateJuggling() {
    ball.dy += 0.5; ball.y += ball.dy; ball.x += ball.dx;
    if(ball.x+ball.r>320 || ball.x-ball.r<0) ball.dx = -ball.dx;
    if(ball.y+ball.r>400) gameOver();
    drawBall(ball.x, ball.y, ball.r, "#fff");
}
function updateFlappy() {
    ball.dy += 0.4; ball.y += ball.dy;
    if(Math.random()<0.02) obstacles.push({x:320, topH: Math.random()*200+50, passed:false});
    ctx.fillStyle="#4CAF50";
    obstacles.forEach(o => {
        o.x-=2; ctx.fillRect(o.x,0,40,o.topH); ctx.fillRect(o.x,o.topH+120,40,400);
        if(o.x+40<ball.x && !o.passed) { currentScore++; o.passed=true; }
        if(ball.x+12>o.x && ball.x-12<o.x+40 && (ball.y-12<o.topH || ball.y+12>o.topH+120)) gameOver();
    });
    if(ball.y>400 || ball.y<0) gameOver();
    drawBall(ball.x, ball.y, 12, "#FFD700");
}
function updatePenalty() {
    goalTarget.x += goalTarget.spd*goalTarget.dir;
    if(goalTarget.x+goalTarget.w>320 || goalTarget.x<0) goalTarget.dir *= -1;
    ctx.fillStyle="#333"; ctx.fillRect(0,0,320,100);
    ctx.fillStyle="#d32f2f"; ctx.fillRect(goalTarget.x,60,goalTarget.w,20);
    if(ball.state==='shooting') {
        ball.y-=15; ball.r-=0.2;
        if(ball.y<80) {
            if(ball.x>goalTarget.x && ball.x<goalTarget.x+goalTarget.w) { currentScore++; ball.state='ready'; ball.y=360; ball.r=15; goalTarget.spd+=0.5; }
            else gameOver();
        }
    }
    drawBall(ball.x, ball.y, ball.r, "#fff");
}
function updateDribbler() {
    ctx.fillStyle="#388E3C"; ctx.fillRect(0,0,320,400); ctx.strokeStyle="rgba(255,255,255,0.2)"; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(0, (currentScore*10)%400); ctx.lineTo(320, (currentScore*10)%400); ctx.stroke(); 
    ball.x += (playerTargetX - ball.x) * 0.1;
    if(Math.random() < 0.03 + (currentScore*0.001)) { obstacles.push({x: Math.random() * 280 + 20, y: -20, type: Math.random()>0.5?'cone':'defender'}); }
    obstacles.forEach((o, i) => {
        o.y += 4 + (currentScore * 0.1);
        ctx.fillStyle = o.type==='cone' ? '#FF9800' : '#d32f2f';
        ctx.beginPath(); ctx.arc(o.x, o.y, 10, 0, Math.PI*2); ctx.fill();
        const dist = Math.hypot(ball.x - o.x, 350 - o.y);
        if(dist < 25) gameOver();
        if(o.y > 420) { obstacles.splice(i, 1); currentScore++; }
    });
    drawBall(ball.x, 350, 15, "#fff");
}
function updateKeeper() {
    ctx.fillStyle="#444"; ctx.fillRect(0,360,320,40); 
    ctx.strokeStyle="#fff"; ctx.lineWidth=5; ctx.strokeRect(20, 20, 280, 340); 
    ball.x += (playerTargetX - ball.x) * 0.15;
    if(Math.random() < 0.02 + (currentScore*0.002)) { obstacles.push({x: Math.random() * 260 + 30, y: -20, caught: false}); }
    obstacles.forEach((b, i) => {
        b.y += 5 + (currentScore * 0.1);
        drawBall(b.x, b.y, 12, "#fff"); 
        const dist = Math.hypot(ball.x - b.x, 340 - b.y);
        if(dist < 30 && !b.caught) { b.caught = true; currentScore++; obstacles.splice(i, 1); }
        if(b.y > 400) gameOver();
    });
    ctx.fillStyle="#FFEB3B"; ctx.fillRect(ball.x-20, 330, 40, 20); 
}
function drawBall(x,y,r,c){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle=c; ctx.fill(); ctx.stroke(); }

// --- Open Modal & Fetch Available Players ---
async function openTeamAddModal() {
    const modal = document.getElementById('teamAddModalOverlay');
    const select = document.getElementById('chatTeamAddSelect');
    
    // Show modal and loading state
    modal.style.display = 'flex';
    select.innerHTML = '<option value="">Loading players...</option>';

    // 1. Fetch Main Team and both Colored Teams data from Supabase
    // --- ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿ™ŸÖ ŸáŸÜÿß: ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿ≠ÿ≥ÿ® ÿßŸÑÿßÿ≥ŸÖ ÿ™ÿµÿßÿπÿØŸäÿßŸã ---
    const { data: mainTeam } = await supabase.from('main_team').select('name').order('name', { ascending: true });
    // ------------------------------------------------
    const { data: blueTeam } = await supabase.from('blue_team').select('name');
    const { data: yellowTeam } = await supabase.from('yellow_team').select('name');

    // 2. Create a Set of players already in Blue or Yellow to filter them out
    const takenPlayers = new Set([
        ...(blueTeam?.map(p => p.name) || []),
        ...(yellowTeam?.map(p => p.name) || [])
    ]);

    // 3. Clear and Populate the Dropdown with available players only
    select.innerHTML = '';
    let count = 0;

    if (mainTeam) {
        mainTeam.forEach(p => {
            // Only add if NOT in Blue/Yellow already
            if (!takenPlayers.has(p.name)) {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.innerText = p.name;
                select.appendChild(opt);
                count++;
            }
        });
    }

    // Handle empty list case (all players are assigned)
    if (count === 0) {
        select.innerHTML = '<option value="">No available players</option>';
    }
}


// --- Confirm Addition (Immediate Transfer) ---
function confirmAddToTeam(team) {
    const select = document.getElementById('chatTeamAddSelect');
    const name = select.value;

    if (!name) return alert("Please select a player first");

    // Add to the selected team immediately calling existing functions
    if (team === 'blue') {
        addBlue(name);
    } else {
        addYellow(name);
    }
    
    // Close the modal after adding
    closeTeamAddModal();
}

// --- Close Modal Function ---
function closeTeamAddModal() { 
    document.getElementById('teamAddModalOverlay').style.display = 'none'; 
}


function handleTyping(context) {
    const name = document.getElementById(context==='global'?'chatNameInput':`${context}ChatNameInput`).value;
    if(!roomChannel || !name) return;
    roomChannel.send({ type: 'broadcast', event: 'typing', payload: { name: name } });
}

function updateOnlineUsersUI(users) {
    const bar = document.getElementById('onlineUsersBar');
    if(!bar) return;
    const uniqueUsers = [...new Set(users)];
    bar.innerHTML = uniqueUsers.map(u => `<div class="online-user-pill">${u} <div class="online-dot"></div></div>`).join('');
}

function setupRealtime() {
  const myName = localStorage.getItem('chat_username') || 'Guest';
  
  // 1. Global Chat
  supabase.channel('global-chat-updates')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' }, (payload) => { 
        renderMessage(payload.new, 'chatMessages'); 
        // ÿ¥ÿ∫ŸÑ ÿßŸÑÿµŸàÿ™ ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ÿ£ŸÜÿ™ ÿßŸÑŸÖÿ±ÿ≥ŸÑ (ŸÑÿ£ŸÜŸÉ ÿ≥ŸÖÿπÿ™Ÿá ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑)
        if (payload.new.username !== myName) playNotificationSound();
    })
    .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'chat_messages' }, () => { loadChatMessages(); })
    .subscribe();
    
  supabase.channel('system-history-updates').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'system_history' }, () => { const hc = document.getElementById('systemHistoryContainer'); if (hc.style.display === 'block') loadSystemHistory(false); }).subscribe();
  supabase.channel('laundry-history-updates').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'laundry_history' }, () => { const container = document.getElementById('laundryHistoryContainer'); if (container.style.display === 'block') loadLaundryHistory(false); }).subscribe();
  
  // 2. Blue Chat
  supabase.channel('blue-chat-updates').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'blue_chat' }, (payload) => { 
      if(document.getElementById('blue').style.display === 'block') {
          renderMessage(payload.new, 'blueChatMessages'); 
          if (payload.new.username !== myName) playNotificationSound();
      }
  }).subscribe();

  // 3. Yellow Chat
  supabase.channel('yellow-chat-updates').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'yellow_chat' }, (payload) => { 
      if(document.getElementById('yellow').style.display === 'block') {
          renderMessage(payload.new, 'yellowChatMessages'); 
          if (payload.new.username !== myName) playNotificationSound();
      }
  }).subscribe();

  supabase.channel('teams-updates').on('postgres_changes', { event: '*', schema: 'public', table: 'main_team' }, () => loadPlayers()).on('postgres_changes', { event: '*', schema: 'public', table: 'waiting_list' }, () => loadPlayers()).on('postgres_changes', { event: '*', schema: 'public', table: 'blue_team' }, () => loadBlue()).on('postgres_changes', { event: '*', schema: 'public', table: 'yellow_team' }, () => loadYellow()).subscribe();

  roomChannel = supabase.channel('online-room', { config: { presence: { key: myId, }, }, });
  roomChannel
    .on('presence', { event: 'sync' }, () => {
      const newState = roomChannel.presenceState();
      const users = [];
      for (const id in newState) { const userObj = newState[id][0]; if (userObj && userObj.name) users.push(userObj.name); }
      updateOnlineUsersUI(users);
    })
    .on('broadcast', { event: 'typing' }, ({ payload }) => {
        const indicator = document.getElementById('typingIndicator');
        if(indicator) {
            indicator.innerText = `${payload.name} is typing...`;
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => { indicator.innerText = ''; }, 2000);
        }
    })
    .subscribe(async (status) => { if (status === 'SUBSCRIBED') { const name = document.getElementById('chatNameInput').value || 'Guest'; await roomChannel.track({ name: name, online_at: new Date().toISOString() }); } });
}



async function checkAndRunAutoWash() {
    const now = new Date();
    if (now.getDay() !== 6 || now.getHours() < 21) return; 
    const oneDayAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000)).toISOString();
    const { data: recentWash } = await supabase.from('laundry_history').select('*').gt('washed_at', oneDayAgo); 
    if (recentWash && recentWash.length > 0) return; 

    console.log("Starting Auto-Wash Selection...");
    const { data: team } = await supabase.from("main_team").select("*");
    const { data: history } = await supabase.from("laundry_history").select("*");
    
    const twoMonthsMs = 60 * 24 * 60 * 60 * 1000;
    const nowTs = Date.now();
    const lastWashMap = {};
    if(history) history.forEach(r => lastWashMap[r.player_name] = new Date(r.washed_at).getTime());
    const eligible = team.filter(p => { return (nowTs - (lastWashMap[p.name] || 0)) > twoMonthsMs; });

    if(eligible.length === 0) return; 
    const winner = eligible[Math.floor(Math.random() * eligible.length)];
    const { error } = await supabase.from("laundry_history").insert([{ player_name: winner.name }]);
    
    if (!error) {
        await sendMessageToGroup("System", `wash-winner:${winner.name} (Auto-Selected ü§ñ)`);
        if(document.getElementById('laundryHistoryContainer').style.display === 'block') { loadLaundryHistory(false); }
        showToast(`ü§ñ Auto-System: Selected ${winner.name} for Laundry!`);
    }
}

// --- NEW ENGLISH NAME VALIDATION FUNCTIONS (UPDATED) ---
function submitEnglishName() {
    const input = document.getElementById('forcedNameInput');
    const name = input.value.trim();
    const errorMsg = document.getElementById('nameErrorMsg');
    const englishRegex = /^[A-Za-z0-9\s]+$/;

    // Check if empty or too short
    if (!name || name.length < 3) {
        errorMsg.innerText = "Name is too short / ÿßŸÑÿßÿ≥ŸÖ ŸÇÿµŸäÿ± ÿ¨ÿØÿßŸã";
        errorMsg.style.display = 'block';
        return;
    }
    // Check if English Only
    if (!englishRegex.test(name)) {
        errorMsg.innerHTML = "Only English letters allowed! <br> ŸÖÿ≥ŸÖŸàÿ≠ ŸÅŸÇÿ∑ ÿ®ÿßŸÑÿ£ÿ≠ÿ±ŸÅ ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©";
        errorMsg.style.display = 'block';
        return;
    }
    // NEW CHECK: Must contain at least two words (First + Last)
    if (name.split(/\s+/).length < 2) {
        errorMsg.innerHTML = "Full Name Required (First & Last)<br>ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ ŸÖÿ∑ŸÑŸàÿ® (ÿßŸÑÿßÿ≥ŸÖ ŸàÿßŸÑŸÑŸÇÿ®)";
        errorMsg.style.display = 'block';
        return;
    }

    localStorage.setItem('chat_username', name);
    updateAllNameInputs(name);
    document.getElementById('englishNameModal').style.display = 'none';
    setupRealtime(); 
    
    // Log online status
    logUserStatus('Online üü¢');
    initUserTracking();
}

function updateAllNameInputs(name) {
    if(document.getElementById('chatNameInput')) document.getElementById('chatNameInput').value = name;
    if(document.getElementById('blueChatNameInput')) document.getElementById('blueChatNameInput').value = name;
    if(document.getElementById('yellowChatNameInput')) document.getElementById('yellowChatNameInput').value = name;
    if(document.getElementById('nameInput')) document.getElementById('nameInput').value = name;
}

// CHECK NAME ON LOAD (WITH DELAY TO ENSURE HTML IS READY)
setTimeout(function() {
    const storedName = localStorage.getItem('chat_username');
    const englishRegex = /^[A-Za-z0-9\s]+$/;
    const modal = document.getElementById('englishNameModal');

    // Also check if stored name has first & last name
    const hasFullName = storedName && storedName.trim().split(/\s+/).length >= 2;

    if (modal) {
        if (!storedName || !englishRegex.test(storedName) || !hasFullName) {
            modal.style.display = 'flex'; 
        } else {
            updateAllNameInputs(storedName);
            setupRealtime(); 
        }
    }
}, 1000); 

// -------------------- USER ACTIVITY LOGIC (UPDATED WITH TIME & UNIQUE) --------------------

// 1. Function to save status to Supabase
async function logUserStatus(status) {
    const name = localStorage.getItem('chat_username');
    if (!name) return; 

    await supabase.from('user_logs').insert([{ 
        username: name, 
        status: status 
    }]);
}

// 2. Start tracking (Call this when app starts)
function initUserTracking() {
    const name = localStorage.getItem('chat_username');
    
    // Log "Online" immediately if name exists
    if (name) {
        logUserStatus('Online üü¢');
    }

    // Listen for tab switching or closing
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') {
            // User minimized or closed the app
            logUserStatus('Offline üî¥');
        } else {
             // User came back
             logUserStatus('Online üü¢');
        }
    });
}

// 3. Helper for Time Ago
function timeAgo(dateParam) {
    const date = typeof dateParam === 'object' ? dateParam : new Date(dateParam);
    const today = new Date();
    const seconds = Math.round((today - date) / 1000);
    const minutes = Math.round(seconds / 60);
    const hours = Math.round(minutes / 60);
    const days = Math.round(hours / 24);

    if (seconds < 60) return 'Just now';
    else if (minutes < 60) return `${minutes}m ago`;
    else if (hours < 24) return `${hours}h ago`;
    else return `${days}d ago`;
}

// 4. MAIN LOAD FUNCTION (Unique Users + Time) - NOW PROTECTED WITH PIN
async function loadUserLogs() {
    // PROTECTED: Ask for PIN
    const pin = prompt("Enter Admin PIN to view Activity Log:");
    if (pin !== ADMIN_PASSWORD) {
        return alert("Access Denied! ‚ùå");
    }

    const container = document.getElementById('userLogContainer');
    const list = document.getElementById('userLogList');
    
    // Toggle visibility with smooth scroll
    if (container.style.display === 'none') {
        container.style.display = 'block';
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
        container.style.display = 'none';
        return; 
    }

    list.innerHTML = '<li style="text-align:center;">Loading status...</li>';

    // Fetch last 150 logs to ensure coverage
    const { data, error } = await supabase
        .from('user_logs')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(150);

    if (error || !data || data.length === 0) {
        list.innerHTML = '<li style="text-align:center; color:#777;">No active users found.</li>';
        return;
    }

    // Filter to show only unique users (latest status)
    const uniqueUsers = {};
    data.forEach(log => {
        if (!uniqueUsers[log.username]) {
            uniqueUsers[log.username] = log;
        }
    });

    list.innerHTML = '';
    
    // Render List
    Object.values(uniqueUsers).forEach(user => {
        const isOnline = user.status.includes('Online');
        const timeDisplay = timeAgo(user.created_at);
        
        // Dynamic Styles
        const statusColor = isOnline ? '#00e676' : '#757575'; 
        const statusText = isOnline ? 'Active' : 'Last seen';
        const nameColor = isOnline ? '#fff' : '#aaa';
        
        list.innerHTML += `
            <li style="padding: 10px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); margin-bottom: 2px; border-radius: 4px;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="position:relative;">
                        <div style="width:12px; height:12px; background:${statusColor}; border-radius:50%; box-shadow: 0 0 8px ${statusColor}; border: 1px solid #333;"></div>
                    </div>
                    <div style="display:flex; flex-direction:column;">
                        <span style="color: ${nameColor}; font-weight:bold; font-size:15px;">${user.username}</span>
                        <span style="color: #888; font-size: 11px;">${statusText} ‚Ä¢ ${timeDisplay}</span>
                    </div>
                </div>
            </li>
        `;
    });
}

// --- LOGIC FOR AUTO-SCHEDULE ---

// 1. Add player to schedule
async function addScheduledPlayer() {
    const name = document.getElementById('autoNameInput').value.trim();
    const time = document.getElementById('autoTimeInput').value; // Returns HH:MM

    if (!name || !time) return alert("Please enter Name and Time!");

    // Initialize list if missing
    if (!systemConfig.scheduledList) systemConfig.scheduledList = [];
    
    // Add new task
    systemConfig.scheduledList.push({ name: name, time: time });
    
    // Save to Supabase and update UI
    await saveConfigToSupabase();
    renderScheduledList();
    
    // Clear inputs
    document.getElementById('autoNameInput').value = '';
}

// 2. Remove player from schedule
async function removeScheduledPlayer(index) {
    if (!confirm("Remove this scheduled task?")) return;
    systemConfig.scheduledList.splice(index, 1);
    await saveConfigToSupabase();
    renderScheduledList();
}

// 3. Render the list inside Settings
function renderScheduledList() {
    const list = document.getElementById('scheduledPlayersList');
    if (!list) return;
    list.innerHTML = '';

    if (!systemConfig.scheduledList || systemConfig.scheduledList.length === 0) {
        list.innerHTML = '<li style="color:#777; font-size:12px; text-align:center;">No players scheduled.</li>';
        return;
    }

    systemConfig.scheduledList.forEach((item, index) => {
        // Convert 24h time to 12h for display
        const [h, m] = item.time.split(':');
        const d = new Date(); d.setHours(h); d.setMinutes(m);
        const timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

        list.innerHTML += `
            <li style="display:flex; justify-content:space-between; align-items:center; background:#333; padding:5px 10px; margin-bottom:5px; border-radius:5px; border-left: 3px solid #FF9800;">
                <span style="color:#fff; font-weight:bold;">${item.name}</span>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="color:#00e676; font-family:monospace;">${timeStr}</span>
                    <button onclick="removeScheduledPlayer(${index})" style="background:#d32f2f; padding:2px 8px; font-size:12px;">‚úï</button>
                </div>
            </li>
        `;
    });
}

// 4. Helper to save config (Updates existing config without closing modal)
async function saveConfigToSupabase() {
    await supabase.from('app_config').update({ 
        system_config: JSON.stringify(systemConfig),
        match_address: document.getElementById('matchAddressInput').value.trim() 
    }).eq('id', 1);
}

// 5. Main Timer Engine (Runs every 10 seconds)
setInterval(async () => {
    if (!systemConfig.scheduledList || systemConfig.scheduledList.length === 0) return;

    const now = new Date();
    const currentHours = String(now.getHours()).padStart(2, '0');
    const currentMinutes = String(now.getMinutes()).padStart(2, '0');
    const currentTime = `${currentHours}:${currentMinutes}`;

    const toAdd = [];
    const remaining = [];

    systemConfig.scheduledList.forEach(item => {
        if (item.time === currentTime) {
            toAdd.push(item);
        } else {
            remaining.push(item);
        }
    });

    if (toAdd.length > 0) {
        console.log("Auto-adding players:", toAdd);
        
        for (const p of toAdd) {
            await autoAddPlayerToMain(p.name);
        }

        systemConfig.scheduledList = remaining;
        await saveConfigToSupabase();
        renderScheduledList();
    }

}, 10000); 

// 6. Direct Add Function (Silent - No Chat Message)
async function autoAddPlayerToMain(name) {
    // Check for duplicates
    const { data: exist } = await supabase.from("main_team").select("id").ilike("name", name);
    if (exist && exist.length > 0) return; 

    // Add to Main Team
    await supabase.from("main_team").insert([{ 
        name: name, 
        time: Date.now(), 
        player_pin: "0000" 
    }]);

    // Chat notification removed as requested
    loadPlayers(); 
}

// --- NEW FEATURE: MULTI-ADD MONITOR ---
function toggleMultiAdd() {
    const list = document.getElementById('multiAddList');
    if (list.style.display === 'none') {
        renderMultiAddMonitor();
        list.style.display = 'block';
    } else {
        list.style.display = 'none';
    }
}

function renderMultiAddMonitor() {
    const list = document.getElementById('multiAddList');
    if (!list) return;
    list.innerHTML = '';

    const logs = systemConfig.multiAddLog || [];

    if (logs.length === 0) {
        list.innerHTML = '<li style="color:#777; font-size:11px; text-align:center;">No data recorded yet.</li>';
        return;
    }

    logs.forEach((log, index) => {
        const timeStr = new Date(log.time).toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
        list.innerHTML += `
            <li style="display:flex; justify-content:space-between; align-items:center; background:#2c2c2c; padding:6px; margin-bottom:4px; border-radius:4px; border-left: 2px solid #009688;">
                <div style="font-size:12px;">
                    <span style="color:#aaa;">Device:</span> <strong style="color:#fff;">${log.adder}</strong><br>
                    <span style="color:#aaa;">Added:</span> <span style="color:#FF9800;">${log.player}</span>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:10px; color:#666;">${timeStr}</div>
                    <button onclick="deleteMultiAddLog(${index})" style="background:transparent; color:#d32f2f; font-size:12px; padding:0;">‚úï</button>
                </div>
            </li>
        `;
    });
}

async function deleteMultiAddLog(index) {
    if(!confirm("Delete this log entry?")) return;
    if(!systemConfig.multiAddLog) return;
    
    systemConfig.multiAddLog.splice(index, 1);
    await saveConfigToSupabase();
    renderMultiAddMonitor();
}


// -------------------- SMART TEAM MAKER LOGIC --------------------

// 1. UPDATE THIS FUNCTION (UI with 2 Positions & 1-10 Ratings)
async function loadTeamMakerUI() {
    const listDiv = document.getElementById('teamMakerList');
    listDiv.innerHTML = '<p style="text-align:center; color:#aaa;">Loading...</p>';

    const { data: mainTeam } = await supabase.from('main_team').select('*').order('name');
    
    if (!mainTeam || mainTeam.length === 0) {
        listDiv.innerHTML = '<p style="text-align:center; color:#e57373;">Main Team is empty!</p>';
        return;
    }

    if (!systemConfig.playerStats) systemConfig.playerStats = {};

    listDiv.innerHTML = '';
    
    // Position Options Helper
    const createPosOptions = (selected) => {
        const positions = ['GK','CB','LB','RB','CDM','CM','CAM','LW','RW','ST'];
        let html = '<option value="">None</option>';
        positions.forEach(p => {
            html += `<option value="${p}" ${selected === p ? 'selected' : ''}>${p}</option>`;
        });
        return html;
    };

    // Rating Options Helper (1-10)
    const createRateOptions = (selected) => {
        const ratings = [
            {v:1, t:"1 - Weak üß±"}, {v:2, t:"2 - Poor"}, {v:3, t:"3 - Slow"}, 
            {v:4, t:"4 - Avg"}, {v:5, t:"5 - Decent"}, {v:6, t:"6 - Good"}, 
            {v:7, t:"7 - V.Good"}, {v:8, t:"8 - Pro üî•"}, 
            {v:9, t:"9 - Star üåü"}, {v:10, t:"10 - LEGEND üêê"}
        ];
        let html = '';
        ratings.forEach(r => {
            html += `<option value="${r.v}" ${selected === r.v ? 'selected' : ''}>${r.t}</option>`;
        });
        return html;
    };

    mainTeam.forEach(player => {
        const saved = systemConfig.playerStats[player.name] || {};
        const savedPos1 = saved.pos1 || 'CM'; // Primary
        const savedPos2 = saved.pos2 || '';   // Secondary
        const savedRate = saved.rate || 5;

        const row = document.createElement('div');
        row.className = 'tm-player-row';
        
        row.innerHTML = `
            <div style="flex:2; overflow:hidden;">
                <span class="tm-name" style="display:block;">${player.name}</span>
            </div>
            <div class="tm-controls" style="flex:4; justify-content:flex-end; gap:3px;">
                <select id="tm-pos1-${player.id}" class="tm-select tm-pos1" style="width:50px; border:1px solid #1e88e5;" title="Primary Position">
                    ${createPosOptions(savedPos1)}
                </select>
                <select id="tm-pos2-${player.id}" class="tm-select tm-pos2" style="width:50px; border:1px solid #777; opacity:0.8;" title="Secondary Position">
                    ${createPosOptions(savedPos2)}
                </select>
                <select id="tm-rate-${player.id}" class="tm-select tm-rating" style="width:85px; font-weight:bold; color:#FFD700;">
                    ${createRateOptions(savedRate)}
                </select>
            </div>
        `;
        listDiv.appendChild(row);
    });
}

// 2. UPDATE THIS FUNCTION (Smart Dual-Position Logic)
async function generateBalancedTeams() {
    const listDiv = document.getElementById('teamMakerList');
    const inputs = listDiv.querySelectorAll('.tm-player-row');
    
    if (inputs.length === 0) return alert("Please click 'Load Main List Players' first!");
    
    if (!confirm("‚ö†Ô∏è Create Balanced Teams?\n\nSystem will check Primary AND Secondary positions to fill gaps.")) return;

    let allPlayers = [];
    if (!systemConfig.playerStats) systemConfig.playerStats = {};

    // --- A. Harvest Data ---
    inputs.forEach(row => {
        const name = row.querySelector('.tm-name').innerText;
        const pos1 = row.querySelector('.tm-pos1').value || 'CM';
        const pos2 = row.querySelector('.tm-pos2').value || '';
        const rate = parseInt(row.querySelector('.tm-rating').value);
        
        // Save both positions
        systemConfig.playerStats[name] = { pos1, pos2, rate };
        
        // 'activePos' starts as Primary, but can change if needed
        allPlayers.push({ name, pos1, pos2, rate, activePos: pos1 });
    });

    await saveConfigToSupabase();

    // --- B. INTELLIGENT ROLE SWAPPING (The Sheikh's Brain üß†) ---
    // Define Categories
    const isGK = p => p === 'GK';
    const isDEF = p => ['CB', 'LB', 'RB'].includes(p);
    const isMID = p => ['CDM', 'CM', 'CAM', 'LM', 'RM'].includes(p);
    const isFWD = p => ['ST', 'LW', 'RW', 'CF'].includes(p);

    // Count Primary Roles
    let defCount = allPlayers.filter(p => isDEF(p.pos1)).length;
    let midCount = allPlayers.filter(p => isMID(p.pos1)).length;
    let fwdCount = allPlayers.filter(p => isFWD(p.pos1)).length;

    // Ideal Minimums (Based on 24 players / 2 teams)
    const TARGET_DEF = 8; // 4 per team
    const TARGET_MID = 8; // 4 per team
    // Forwards just take whatever is left

    // 1. Fix Defense Shortage
    if (defCount < TARGET_DEF) {
        // Find players who are NOT primary defenders, but HAVE defense as secondary
        const potentialDefs = allPlayers.filter(p => !isDEF(p.pos1) && isDEF(p.pos2));
        
        potentialDefs.forEach(p => {
            if (defCount < TARGET_DEF) {
                p.activePos = p.pos2; // Switch them to Defense!
                defCount++;
                console.log(`Switched ${p.name} to Defense (Secondary)`);
            }
        });
    }

    // 2. Fix Midfield Shortage (if any)
    if (midCount < TARGET_MID) {
        const potentialMids = allPlayers.filter(p => !isMID(p.pos1) && isMID(p.pos2) && p.activePos === p.pos1);
        potentialMids.forEach(p => {
            if (midCount < TARGET_MID) {
                p.activePos = p.pos2;
                midCount++;
            }
        });
    }

    // --- C. Sort & Distribute ---
    allPlayers.sort((a, b) => b.rate - a.rate); // Strongest first

    let blueTeam = [];
    let yellowTeam = [];
    let blueScore = 0;
    let yellowScore = 0;
    let assignedNames = new Set();

    function distributeGroup(group) {
        if (group.length === 0) return;
        // Shuffle same-rated players
        group.sort((a, b) => {
            if (b.rate !== a.rate) return b.rate - a.rate;
            return 0.5 - Math.random();
        });

        group.forEach(p => {
            if (assignedNames.has(p.name)) return;

            const addToBlue = (blueScore <= yellowScore && blueTeam.length < 12) || yellowTeam.length >= 12;
            
            if (addToBlue && blueTeam.length < 12) {
                blueTeam.push(p);
                blueScore += p.rate;
            } else if (yellowTeam.length < 12) {
                yellowTeam.push(p);
                yellowScore += p.rate;
            }
            assignedNames.add(p.name);
        });
    }

    // Distribute based on the NEW 'activePos'
    // 1. GK
    distributeGroup(allPlayers.filter(p => isGK(p.activePos) || isGK(p.pos2))); // Check pos2 for GK specifically as it's critical
    // 2. DEF
    distributeGroup(allPlayers.filter(p => isDEF(p.activePos)));
    // 3. MID
    distributeGroup(allPlayers.filter(p => isMID(p.activePos)));
    // 4. FWD
    distributeGroup(allPlayers.filter(p => isFWD(p.activePos)));
    // 5. Remainder
    distributeGroup(allPlayers.filter(p => !assignedNames.has(p.name)));

    // --- D. Save to DB ---
    async function saveTeamToDB(teamArr, tableName) {
        let counts = {}; 

        const dbRecords = teamArr.map(p => {
            // Use activePos for mapping
            let mapKey = p.activePos;
            if (!posMap[mapKey]) mapKey = 'CM'; 

            let coordsObj;
            if (Array.isArray(posMap[mapKey])) {
                if (!counts[mapKey]) counts[mapKey] = 0;
                coordsObj = posMap[mapKey][counts[mapKey] % posMap[mapKey].length];
                counts[mapKey]++;
            } else {
                coordsObj = posMap[mapKey] || posMap['CM'];
            }

            return {
                name: p.name,
                time: Date.now(),
                position_code: coordsObj.c,
                position: JSON.stringify({left: coordsObj.x, top: coordsObj.y}),
                player_pin: null 
            };
        });

        if (dbRecords.length > 0) {
            await supabase.from(tableName).insert(dbRecords);
        }
    }

    showToast("üß† Smart Balancing...");
    
    await supabase.from('blue_team').delete().gt('id', 0);
    await supabase.from('yellow_team').delete().gt('id', 0);

    await saveTeamToDB(blueTeam, 'blue_team');
    await saveTeamToDB(yellowTeam, 'yellow_team');

    document.getElementById('settingsModalOverlay').style.display = 'none';
    loadBlue();
    loadYellow();
    
    setTimeout(() => {
        alert(`‚úÖ Teams Balanced!\n\nCheck positions - some players may have switched to their secondary roles to balance the field!`);
    }, 500);
}


// 3. UPDATE THIS FUNCTION (Logic to Save Data & Balance 1-10)
async function generateBalancedTeams() {
    const listDiv = document.getElementById('teamMakerList');
    const inputs = listDiv.querySelectorAll('.tm-player-row');
    
    if (inputs.length === 0) return alert("Please load players first.");
    if (!confirm("‚ö†Ô∏è Create Balanced Teams?\nThis will overwrite current teams and SAVE player ratings.")) return;

    let allPlayers = [];
    if (!systemConfig.playerStats) systemConfig.playerStats = {};

    // A. Harvest Data & SAVE TO MEMORY
    inputs.forEach(row => {
        const name = row.querySelector('.tm-name').innerText;
        const idPart = row.querySelector('select').id.split('-')[2]; 
        const pos = document.getElementById(`tm-pos-${idPart}`).value;
        const rate = parseInt(document.getElementById(`tm-rate-${idPart}`).value);
        
        // Save to system config object
        systemConfig.playerStats[name] = { pos: pos, rate: rate };
        
        allPlayers.push({ name, pos, rate });
    });

    // Save to Database immediately so we don't lose ratings
    await saveConfigToSupabase();

    // B. Sort by Rating (Highest to Lowest)
    allPlayers.sort((a, b) => b.rate - a.rate);

    let blueTeam = [];
    let yellowTeam = [];
    let blueScore = 0;
    let yellowScore = 0;

    // Helper: Distribute Logic
    function distributeGroup(group) {
        // Add randomness for players with SAME rating
        group.sort((a, b) => {
            if (b.rate !== a.rate) return b.rate - a.rate;
            return 0.5 - Math.random();
        });

        group.forEach(p => {
            // Balance logic: Add to weaker team
            const addToBlue = (blueScore <= yellowScore && blueTeam.length < 12) || yellowTeam.length >= 12;
            
            if (addToBlue && blueTeam.length < 12) {
                blueTeam.push(p);
                blueScore += p.rate;
            } else if (yellowTeam.length < 12) {
                yellowTeam.push(p);
                yellowScore += p.rate;
            }
        });
    }

    // C. Process by specific groups to ensure structure
    distributeGroup(allPlayers.filter(p => p.pos === 'GK'));
    distributeGroup(allPlayers.filter(p => ['CB', 'LB', 'RB'].includes(p.pos))); // Defenders
    distributeGroup(allPlayers.filter(p => ['ST', 'LW', 'RW'].includes(p.pos))); // Attackers
    distributeGroup(allPlayers.filter(p => ['CDM', 'CM', 'CAM'].includes(p.pos))); // Midfielders

    // D. Database Saving Logic (Using new posMap)
    async function saveTeamToDB(teamArr, tableName) {
        let counts = {}; // Track usage of positions

        const dbRecords = teamArr.map(p => {
            // Fallback logic for coordinates
            let mapKey = p.pos;
            if (!posMap[mapKey]) mapKey = 'CM'; // Default if unknown

            let coordsObj;
            if (Array.isArray(posMap[mapKey])) {
                if (!counts[mapKey]) counts[mapKey] = 0;
                coordsObj = posMap[mapKey][counts[mapKey] % posMap[mapKey].length];
                counts[mapKey]++;
            } else {
                coordsObj = posMap[mapKey];
            }

            return {
                name: p.name,
                time: Date.now(),
                position_code: coordsObj.c,
                position: JSON.stringify({left: coordsObj.x, top: coordsObj.y}),
                player_pin: null 
            };
        });

        if (dbRecords.length > 0) {
            await supabase.from(tableName).insert(dbRecords);
        }
    }

    // E. Execute
    showToast("üíæ Saving Ratings & Balancing Teams...");
    
    await supabase.from('blue_team').delete().gt('id', 0);
    await supabase.from('yellow_team').delete().gt('id', 0);

    await saveTeamToDB(blueTeam, 'blue_team');
    await saveTeamToDB(yellowTeam, 'yellow_team');

    document.getElementById('settingsModalOverlay').style.display = 'none';
    loadBlue();
    loadYellow();
    
    setTimeout(() => {
        alert(`‚úÖ Teams Balanced & Ratings Saved!\n\nüîµ Blue (Power ${blueScore})\nüü° Yellow (Power ${yellowScore})`);
    }, 500);
}


// 2. The Core Algorithm: Distribute & Assign Positions
async function generateBalancedTeams() {
    const listDiv = document.getElementById('teamMakerList');
    const inputs = listDiv.querySelectorAll('.tm-player-row');
    
    if (inputs.length === 0) return alert("Please load players first.");
    if (!confirm("‚ö†Ô∏è WARNING:\nThis will DELETE current Blue & Yellow teams and replace them with new balanced ones.\n\nContinue?")) return;

    let allPlayers = [];

    // A. Harvest Data from UI
    inputs.forEach(row => {
        const name = row.querySelector('.tm-name').innerText;
        const idPart = row.querySelector('select').id.split('-')[2]; 
        const pos = document.getElementById(`tm-pos-${idPart}`).value;
        const rate = parseInt(document.getElementById(`tm-rate-${idPart}`).value);
        
        allPlayers.push({ name, pos, rate });
    });

    // B. Sort by Rating (Highest to Lowest) to balance power first
    allPlayers.sort((a, b) => b.rate - a.rate);

    let blueTeam = [];
    let yellowTeam = [];
    let blueScore = 0;
    let yellowScore = 0;

    // Helper: Smart Distribution Function
    function distributeGroup(group) {
        // Shuffle players with SAME rating to add randomness
        group.sort((a, b) => {
            if (b.rate !== a.rate) return b.rate - a.rate;
            return 0.5 - Math.random();
        });

        group.forEach(p => {
            // Logic: Add to the team with lower Total Score, or alternate if equal
            // Also check if team is full (max 12)
            const addToBlue = (blueScore <= yellowScore && blueTeam.length < 12) || yellowTeam.length >= 12;
            
            if (addToBlue && blueTeam.length < 12) {
                blueTeam.push(p);
                blueScore += p.rate;
            } else if (yellowTeam.length < 12) {
                yellowTeam.push(p);
                yellowScore += p.rate;
            }
        });
    }

    // C. Process by Position (GK first, then others)
    distributeGroup(allPlayers.filter(p => p.pos === 'GK'));
    distributeGroup(allPlayers.filter(p => p.pos === 'DEF'));
    distributeGroup(allPlayers.filter(p => p.pos === 'FWD'));
    distributeGroup(allPlayers.filter(p => p.pos === 'MID')); // Mids last filler

    // D. Mapping Positions to Coordinates (Auto-Formation)
    // We use a flexible map. If a team has 3 DEFs, they get defensive spots.
    const posMap = {
        'GK':  {c:'GK', x:'6%', y:'50%'},
        'DEF': [{c:'CB', x:'18%', y:'38%'}, {c:'CB', x:'18%', y:'62%'}, {c:'LB', x:'25%', y:'15%'}, {c:'RB', x:'25%', y:'85%'}],
        'MID': [{c:'CM', x:'45%', y:'40%'}, {c:'CM', x:'45%', y:'60%'}, {c:'LM', x:'50%', y:'15%'}, {c:'RM', x:'50%', y:'85%'}, {c:'DM', x:'40%', y:'50%'}],
        'FWD': [{c:'ST', x:'80%', y:'35%'}, {c:'ST', x:'80%', y:'65%'}, {c:'RW', x:'80%', y:'85%'}, {c:'LW', x:'80%', y:'15%'}],
        'SUB': {c:'SUB', x:'50%', y:'-15%'}
    };

    async function saveTeamToDB(teamArr, tableName) {
        // Reset counters for each position type
        let counts = { DEF: 0, MID: 0, FWD: 0 };

        const dbRecords = teamArr.map(p => {
            let code = 'SUB';
            let coords = posMap['SUB'];

            if (p.pos === 'GK') { 
                code = 'GK'; coords = posMap['GK']; 
            } else {
                // Cycle through available slots for that position
                let list = posMap[p.pos] || posMap['MID']; // Default to MID if error
                let index = counts[p.pos] % list.length;
                coords = list[index];
                code = coords.c;
                counts[p.pos]++;
            }

            return {
                name: p.name,
                time: Date.now(),
                position_code: code,
                position: JSON.stringify({left: coords.left || coords.x, top: coords.top || coords.y}),
                player_pin: null 
            };
        });

        if (dbRecords.length > 0) {
            await supabase.from(tableName).insert(dbRecords);
        }
    }

    // E. Execute Database Operations
    showToast("‚öôÔ∏è Balancing Teams... Please wait.");
    
    // 1. Clear Old Teams
    await supabase.from('blue_team').delete().gt('id', 0);
    await supabase.from('yellow_team').delete().gt('id', 0);

    // 2. Insert New Teams
    await saveTeamToDB(blueTeam, 'blue_team');
    await saveTeamToDB(yellowTeam, 'yellow_team');

    // 3. Finish
    document.getElementById('settingsModalOverlay').style.display = 'none';
    
    // Reload UI
    loadBlue();
    loadYellow();
    
    // Notify User
    setTimeout(() => {
        alert(`‚úÖ Teams Created Successfully!\n\nüîµ Blue Power: ${blueScore}\nüü° Yellow Power: ${yellowScore}\n\nDifference: ${Math.abs(blueScore - yellowScore)}`);
    }, 500);
}

(async function init() {
    const storedUsername = localStorage.getItem('chat_username');
    if (storedUsername) {
        document.getElementById('chatNameInput').value = storedUsername;
        document.getElementById('blueChatNameInput').value = storedUsername;
        document.getElementById('yellowChatNameInput').value = storedUsername;
        document.getElementById('nameInput').value = storedUsername;
    }

    document.getElementById('chatMsgInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { sendMessage(); } });
    document.getElementById('blueChatMsgInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { sendTeamMessage('blue'); } });
    document.getElementById('yellowChatMsgInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') { sendTeamMessage('yellow'); } });

    await loadSystemConfig(); loadMatchAddress(); loadPlayers(); loadBlue(); loadYellow(); loadChatMessages(); 
    checkAndRunAutoWash(); 
    
    // START TRACKING
    initUserTracking();

    showSection('main');
})();
</script>

<div id="englishNameModal" class="mini-modal-overlay" style="display:none; z-index: 9999; background: rgba(0,0,0,0.96); backdrop-filter: blur(5px);">
    <div class="mini-modal-box" style="border: 1px solid #444; box-shadow: 0 10px 40px rgba(0,0,0,0.8); max-width: 320px;">
        <h2 style="color:#e53935; margin-top:0; font-size: 22px; display:flex; align-items:center; justify-content:center; gap:8px;">
            ‚ö†Ô∏è Name Required
        </h2>
        
        <p style="color:#e0e0e0; font-size: 16px; margin: 20px 0; line-height: 1.6;">
            Please write your FULL name (English)<br>
            <span style="font-size:14px; color:#aaa;">(First Name & Last Name)</span>
        </p>
        
        <input type="text" id="forcedNameInput" placeholder="Your Full Name" style="width:100%; padding:12px; margin:10px 0; border-radius: 8px; border: 1px solid #555; background: #1e1e1e; color: #fff; text-align: center; font-size:16px; box-sizing: border-box;">
        
        <p id="nameErrorMsg" style="color:#ff5252; display:none; font-size:13px; margin:8px 0; font-weight: bold; background: rgba(255, 82, 82, 0.1); padding: 8px; border-radius: 6px;">
            Only English letters allowed!
        </p>
        
        <button onclick="submitEnglishName()" style="background:#e53935; color:#fff; width:100%; padding:14px; font-weight:bold; margin-top: 15px; border-radius: 8px; font-size:16px; transition: 0.2s;">Confirm & Enter</button>
    </div>
</div>

<div id="viewAddressModal" class="mini-modal-overlay" style="display:none; z-index: 3500;">
    <div class="mini-modal-box">
        <h3 style="color:#fff; margin-top:0;">Match Address üìç</h3>
        <p style="color:#ccc; font-size:12px; margin-bottom:5px;">You can copy the address below or open the map:</p>
        
        <input type="text" id="addressDisplayInput" readonly 
               style="width:95%; background:#111; color:#fff; border:1px solid #FF9800; padding:10px; text-align:center; user-select: text;">
        
        <div style="display:flex; gap:10px; margin-top:10px; justify-content: center;">
            <button onclick="copyToClipboard()" style="background:#009688; color:#fff; flex:1; padding:10px;">Copy üìã</button>
            <button onclick="openMapDirectly()" style="background:#1976d2; color:#fff; flex:1; padding:10px;">Open Map üó∫Ô∏è</button>
        </div>
        
        <button onclick="closeAddressModal()" style="background:#555; color:#fff; margin-top:10px; width:100%;">Close</button>
    </div>
</div>

</body>
</html>
